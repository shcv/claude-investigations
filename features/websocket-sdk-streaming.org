#+TITLE: WebSocket SDK Streaming Interface
#+DATE: 2026-02-10

* Overview

The =--sdk-url= flag provides a WebSocket-based transport layer as an
alternative to stdin/stdout for Claude Code's stream-json mode. Instead of
reading NDJSON from stdin and writing to stdout, messages flow over a persistent
WebSocket connection to a remote server, with automatic reconnection, message
buffering, and replay semantics built in.

Introduced in v1.0.77, refined through v2.1.x. The flag is hidden from
=--help= output (=.hideHelp()= in the argument parser) — it's an internal
integration point, not a user-facing feature.

* How It Differs from stdio stream-json

Both modes use the same NDJSON message protocol. The difference is the
transport layer underneath.

| Aspect | stdio (=stream-json=) | WebSocket (=--sdk-url=) |
|---------------------------+-------------------------------+--------------------------------------|
| Transport | stdin/stdout pipes | Persistent WebSocket connection |
| Lifecycle | Tied to process lifetime | Survives transient network failures |
| Message buffering | None — caller manages stdin | 1000-message circular buffer |
| Reconnection | N/A | Automatic, 10-minute budget |
| Message replay | N/A | Replays buffered messages on reconnect |
| Keep-alive | N/A | Ping/pong every 10 seconds |
| Control requests | Via stdin | Via WebSocket or HTTP POST fallback |
| Authentication | Environment/config | Bearer token in WebSocket headers |
| Permission prompts | Normal tool | Forced to =stdio= mode |

The key architectural insight: =FQA= (the SDK transport class) *extends* =Mc1=
(the stdio transport class). It bridges the WebSocket into a Node.js
PassThrough stream, so downstream code sees the same interface regardless of
transport. The selection happens at startup:

#+BEGIN_SRC javascript
// Transport factory (deobfuscated from IJz in pretty-v2.1.38.js:541962)
function createInputHandler(prompt, options) {
  // ... wrap prompt into initial message ...
  return options.sdkUrl
    ? new SdkTransport(options.sdkUrl, inputStream, options.replayUserMessages)
    : new StdioTransport(inputStream, options.replayUserMessages);
}
#+END_SRC

* Architecture

Three classes form the transport stack:

** Pc1 — Core WebSocket Transport

The low-level WebSocket manager. Handles connection lifecycle, reconnection,
ping/pong, and message buffering.

Source location: =pretty-v2.1.38.js:537836-538115=

Key state:
- =state=: idle → reconnecting → connected → closing → closed
- =messageBuffer=: CircularBuffer with capacity 1000
- =lastSentId=: UUID of last sent message (for replay negotiation)
- =reconnectStartTime=: Timestamp for 10-minute budget tracking
- =pongReceived=: Dead connection detection flag

** mQA — Hybrid Transport (POST Fallback)

Extends =Pc1=. When the environment variable
=CLAUDE_CODE_POST_FOR_SESSION_INGRESS_V2= is set, this transport is selected
instead. It receives data over WebSocket but sends outbound messages via HTTP
POST to a derived URL (converts =/ws/= to =/session/= and appends =/events=).

Source location: =pretty-v2.1.38.js:538144-538199=

POST retry strategy: 10 attempts, 500ms initial delay, 8s max delay,
exponential backoff.

** FQA — SDK Transport Wrapper

Extends =Mc1= (stdio transport). Creates a PassThrough stream and wires
WebSocket data into it, so the rest of Claude Code reads from what looks like
stdin.

Source location: =pretty-v2.1.38.js:538222-538264=

The transport factory =zMq()= at line 538201 selects between =Pc1= and =mQA=
based on the =CLAUDE_CODE_POST_FOR_SESSION_INGRESS_V2= environment variable.

* Required Flags

=--sdk-url= strictly requires both format flags. The CLI exits with an error
if they're missing:

#+BEGIN_SRC bash
claude -p "prompt" \
  --sdk-url=wss://example.com/sdk/v1/connect \
  --input-format=stream-json \
  --output-format=stream-json
#+END_SRC

The validation (=pretty-v2.1.38.js:574358=):
#+BEGIN_SRC javascript
if (sdkUrl) {
  if (inputFormat !== "stream-json" || outputFormat !== "stream-json") {
    console.error("Error: --sdk-url requires both --input-format=stream-json"
                + " and --output-format=stream-json.");
    process.exit(1);
  }
}
#+END_SRC

Also requires =-p= (print/non-interactive mode). When =--sdk-url= is active,
the permission prompt tool is forced to ="stdio"= regardless of configuration.

* Authentication

** Token Resolution Order

The token function (=nV()= at line 235867) checks in this order:

1. =CLAUDE_CODE_SESSION_ACCESS_TOKEN= environment variable — checked first
2. Internal fallback (=mL6()=) — undocumented internal method
3. =CLAUDE_CODE_WEBSOCKET_AUTH_FILE_DESCRIPTOR= — reads token from a file
   descriptor number

The token is sent as a =Bearer= token in the WebSocket upgrade request headers.

** File Descriptor Authentication

Prevents token exposure in process listings (=/proc/*/cmdline=, =ps=). The
implementation reads from platform-specific paths:

- Linux: =/proc/self/fd/{N}=
- macOS/FreeBSD: =/dev/fd/{N}=

#+BEGIN_SRC bash
# Pass token through fd 3
export CLAUDE_CODE_WEBSOCKET_AUTH_FILE_DESCRIPTOR=3
exec 3< <(echo "your-token-here")

claude -p "prompt" \
  --sdk-url=wss://example.com/sdk \
  --input-format=stream-json \
  --output-format=stream-json
#+END_SRC

** Additional Headers

The transport also sends =x-environment-runner-version= if
=CLAUDE_CODE_ENVIRONMENT_RUNNER_VERSION= is set. A session ID is included in
connection metadata.

* Reconnection

** Time-Budget Strategy

Reconnection does *not* use a fixed attempt count. It uses a 10-minute total
time budget. As long as elapsed time since the first failure is under 10
minutes, it keeps trying with exponential backoff.

| Parameter | Value |
|---------------------+----------|
| Initial delay | 1000ms |
| Max delay per attempt | 30000ms |
| Total time budget | 600000ms |
| Jitter | ±25% |

The backoff formula:
#+BEGIN_SRC javascript
// delay = min(1000 * 2^(attempt-1), 30000), then add ±25% jitter
let baseDelay = Math.min(1000 * Math.pow(2, attempts - 1), 30000);
let delay = Math.max(0, baseDelay + baseDelay * 0.25 * (2 * Math.random() - 1));
#+END_SRC

When the 10-minute budget expires, the transport fires its close callback and
the process exits.

** Message Replay on Reconnect

After a successful reconnection:

1. Client sends =X-Last-Request-Id= header containing the UUID of the last
   message it sent before disconnection
2. Server responds with =x-last-request-id= indicating the last message it
   actually processed
3. Client finds that UUID in its circular buffer and replays everything after it

This provides at-least-once delivery. Messages without a =uuid= field are not
buffered and not replayed.

* Circular Buffer

Fixed-capacity ring buffer. Capacity: 1000 messages.

Source location: =pretty-v2.1.38.js:264520-264566= (class =$B1=)

Only messages with a =uuid= field are added to the buffer (checked in the
=write()= method). When the buffer is full, the oldest message is overwritten.
The =toArray()= method returns messages in insertion order, handling the
wrap-around correctly.

* Keep-Alive

A ping is sent every 10 seconds. If no pong is received before the next ping
interval fires, the connection is considered dead and reconnection begins.

#+BEGIN_SRC javascript
// Simplified from pretty-v2.1.38.js:538070
startPingInterval() {
  this.pongReceived = true;
  this.pingInterval = setInterval(() => {
    if (!this.pongReceived) {
      this.handleConnectionError();  // triggers reconnection
      return;
    }
    this.pongReceived = false;
    this.ws.ping();
  }, 10000);
}
#+END_SRC

* Control Requests

Added around v2.1.32. The WebSocket transport supports sending control messages
for operations like interrupting the current task:

#+BEGIN_SRC javascript
sendInterrupt() {
  if (!this.ws || this.ws.readyState !== WebSocket.OPEN) return;
  this.ws.send(JSON.stringify({
    type: "control_request",
    request_id: crypto.randomUUID(),
    request: { subtype: "interrupt" },
  }));
}
#+END_SRC

* Message Protocol

All messages are newline-delimited JSON (NDJSON), identical to the stdio
stream-json format.

** User Messages
#+BEGIN_SRC json
{"type":"user","uuid":"550e8400-...","session_id":"","message":{"role":"user","content":"Hello"},"parent_tool_use_id":null}
#+END_SRC

** Control Responses
#+BEGIN_SRC json
{"type":"control_response","status":"connected","metadata":{"session_id":"abc123","last_request_id":"550e8400-..."}}
#+END_SRC

** Control Requests (client → server)
#+BEGIN_SRC json
{"type":"control_request","request_id":"uuid-here","request":{"subtype":"interrupt"}}
#+END_SRC

The =session_id= and =parent_tool_use_id= fields are present in the SDK
transport but not in stdio mode — they're part of the remote session protocol.

* Environment Variables

| Variable | Purpose |
|----------------------------------------------+--------------------------------------------------|
| =CLAUDE_CODE_SESSION_ACCESS_TOKEN= | Bearer token for WebSocket auth |
| =CLAUDE_CODE_WEBSOCKET_AUTH_FILE_DESCRIPTOR= | File descriptor number containing the token |
| =CLAUDE_CODE_ENVIRONMENT_RUNNER_VERSION= | Sent as =x-environment-runner-version= header |
| =CLAUDE_CODE_POST_FOR_SESSION_INGRESS_V2= | Enables hybrid POST fallback transport |

* Version History

| Version | Changes |
|---------+-----------------------------------------------------|
| v1.0.77 | Initial WebSocket transport with stream-json format |
| v1.0.78 | File descriptor authentication |
| v2.0.x | Stable through major version bump, no breaking changes |
| ~v2.1.32 | Control request support (interrupt), improved logging |
| v2.1.38 | Current version analyzed in this report |

* Source References

All line numbers reference =archive/claude-code/pretty/pretty-v2.1.38.js=:

| Symbol | Lines | Purpose |
|--------+--------------+--------------------------------------|
| =FQA= | 538222-538264 | SDK transport wrapper |
| =Pc1= | 537836-538115 | Core WebSocket transport |
| =mQA= | 538144-538199 | Hybrid POST fallback transport |
| =Mc1= | 537591-537785 | Stdio transport (base class) |
| =$B1= | 264520-264566 | CircularBuffer |
| =nV()= | 235867-235871 | Token retrieval |
| =JD9()= | 235827-235866 | File descriptor token reading |
| =zMq()= | 538201-538207 | Transport factory |
| =IJz()= | 541962-541979 | Input handler factory |
