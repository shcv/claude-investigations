4434e9d8 Stream completed with message_start but no content blocks completed - triggering non-streaming fallback
480dd0fc `),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],I}if(this.chunks.push(H),H.startsWith(":"))return null;let[$,A,L]=uw0(H,":");if(L.startsWith(" "))L=L.substring(1);if($==="event")this.event=L;else if($==="data")this.data.push(L);return null}}function uw0(H,$){let A=H.indexOf($);if(A!==-1)return[H.substring(0,A),$,H.substring(A+$.length)];return[H,"",""]}var HTH,zV;var WLA=K(()=>{Uu();TV();KLA();ZAH();TB$();TV();zV=class zV{constructor(H,$,A){this.iterator=H,HTH.set(this,void 0),this.controller=$,ED(this,HTH,A,"f")}static fromSSEResponse(H,$,A){let L=!1,I=A?JQ(A):console;async function*D(){if(L)throw new LD("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");L=!0;let B=!1;try{for await(let f of bw0(H,$)){if(f.event==="completion")try{yield JSON.parse(f.data)}catch(E){throw I.error("Could not parse message into JSON:",f.data),I.error("From chunk:",f.raw),E}if(f.event==="message_start"||f.event==="message_delta"||f.event==="message_stop"||f.event==="content_block_start"||f.event==="content_block_delta"||f.event==="content_block_stop")try{yield JSON.parse(f.data)}catch(E){throw I.error("Could not parse message into JSON:",f.data),I.error("From chunk:",f.raw),E}if(f.event==="ping")continue;if(f.event==="error")throw new KD(void 0,YB$(f.data)??f.data,void 0,H.headers)}B=!0}catch(f){if(Xu(f))return;throw f}finally{if(!B)$.abort()}}return new zV(D,$,A)}static fromReadableStream(H,$,A){let L=!1;async function*I(){let B=new yi,f=tqH(H);for await(let E of f)for(let M of B.decode(E))yield M;for(let E of B.flush())yield E}async function*D(){if(L)throw new LD("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");L=!0;let B=!1;try{for await(let f of I()){if(B)continue;if(f)yield JSON.parse(f)}B=!0}catch(f){if(Xu(f))return;throw f}finally{if(!B)$.abort()}}return new zV(D,$,A)}[(HTH=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let H=[],$=[],A=this.iterator(),L=(I)=>{return{next:()=>{if(I.length===0){let D=A.next();H.push(D),$.push(D)}return I.shift()}}};return[new zV(()=>L(H),this.controller,xA(this,HTH,"f")),new zV(()=>L($),this.controller,xA(this,HTH,"f"))]}toReadableStream(){let H=this,$;return JLA({async start(){$=H[Symbol.asyncIterator]()},async pull(A){try{let{value:L,done:I}=await $.next();if(I)return A.close();let D=sqH(JSON.stringify(L)+`
480dfe0a ${U}`)}return B},_4;var vi=K(()=>{TV();wcL=Object.freeze(Object.create(null)),_4=aw0(ZcL)});var ITH;var TLA=K(()=>{rR();Qq();B4H();vi();ITH=class ITH extends _5{list(H={},$){let{betas:A,...L}=H??{};return this._client.getAPIList("/v1/files",sN,{query:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"files-api-2025-04-14"].toString()},$?.headers])})}delete(H,$={},A){let{betas:L}=$??{};return this._client.delete(_4`/v1/files/${H}`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"files-api-2025-04-14"].toString()},A?.headers])})}download(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/files/${H}/content`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"files-api-2025-04-14"].toString(),Accept:"application/binary"},A?.headers]),__binaryResponse:!0})}retrieveMetadata(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/files/${H}`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"files-api-2025-04-14"].toString()},A?.headers])})}upload(H,$){let{betas:A,...L}=H;return this._client.post("/v1/files",D4H({body:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"files-api-2025-04-14"].toString()},$?.headers])},this._client))}}});var DTH;var zLA=K(()=>{rR();Qq();vi();DTH=class DTH extends _5{retrieve(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/models/${H}?beta=true`,{...A,headers:Z9([{...L?.toString()!=null?{"anthropic-beta":L?.toString()}:void 0},A?.headers])})}list(H={},$){let{betas:A,...L}=H??{};return this._client.getAPIList("/v1/models?beta=true",sN,{query:L,...$,headers:Z9([{...A?.toString()!=null?{"anthropic-beta":A?.toString()}:void 0},$?.headers])})}}});var jB$;var NLA=K(()=>{jB$={"claude-opus-4-20250514":8192,"claude-opus-4-0":8192,"claude-4-opus-20250514":8192,"anthropic.claude-opus-4-20250514-v1:0":8192,"claude-opus-4@20250514":8192,"claude-opus-4-1-20250805":8192,"anthropic.claude-opus-4-1-20250805-v1:0":8192,"claude-opus-4-1@20250805":8192}});function OLA(H,$){if(!$||!("parse"in($.output_format??{})))return{...H,content:H.content.map((A)=>{if(A.type==="text")return{...A,parsed:null};return A}),parsed_output:null};return xLA(H,$)}function xLA(H,$){let A=null,L=H.content.map((I)=>{if(I.type==="text"){let D=sw0($,I.text);if(A===null)A=D;return{...I,parsed:D}}return I});return{...H,content:L,parsed_output:A}}function sw0(H,$){if(H.output_format?.type!=="json_schema")return null;try{if("parse"in H.output_format)return H.output_format.parse($);return JSON.parse($)}catch(A){throw new LD(`Failed to parse structured output: ${A}`)}}var SLA=K(()=>{TV()});var ew0=(H)=>{let $=0,A=[];while($<H.length){let L=H[$];if(L==="\\"){$++;continue}if(L==="{"){A.push({type:"brace",value:"{"}),$++;continue}if(L==="}"){A.push({type:"brace",value:"}"}),$++;continue}if(L==="["){A.push({type:"paren",value:"["}),$++;continue}if(L==="]"){A.push({type:"paren",value:"]"}),$++;continue}if(L===":"){A.push({type:"separator",value:":"}),$++;continue}if(L===","){A.push({type:"delimiter",value:","}),$++;continue}if(L==='"'){let f="",E=!1;L=H[++$];while(L!=='"'){if($===H.length){E=!0;break}if(L==="\\"){if($++,$===H.length){E=!0;break}f+=L+H[$],L=H[++$]}else f+=L,L=H[++$]}if(L=H[++$],!E)A.push({type:"string",value:f});continue}if(L&&/\s/.test(L)){$++;continue}let D=/[0-9]/;if(L&&D.test(L)||L==="-"||L==="."){let f="";if(L==="-")f+=L,L=H[++$];while(L&&D.test(L)||L===".")f+=L,L=H[++$];A.push({type:"number",value:f});continue}let B=/[a-z]/i;if(L&&B.test(L)){let f="";while(L&&B.test(L)){if($===H.length)break;f+=L,L=H[++$]}if(f=="true"||f=="false"||f==="null")A.push({type:"name",value:f});else{$++;continue}continue}$++}return A},f4H=(H)=>{if(H.length===0)return H;let $=H[H.length-1];switch($.type){case"separator":return H=H.slice(0,H.length-1),f4H(H);break;case"number":let A=$.value[$.value.length-1];if(A==="."||A==="-")return H=H.slice(0,H.length-1),f4H(H);case"string":let L=H[H.length-2];if(L?.type==="delimiter")return H=H.slice(0,H.length-1),f4H(H);else if(L?.type==="brace"&&L.value==="{")return H=H.slice(0,H.length-1),f4H(H);break;case"delimiter":return H=H.slice(0,H.length-1),f4H(H);break}return H},HZ0=(H)=>{let $=[];if(H.map((A)=>{if(A.type==="brace")if(A.value==="{")$.push("}");else $.splice($.lastIndexOf("}"),1);if(A.type==="paren")if(A.value==="[")$.push("]");else $.splice($.lastIndexOf("]"),1)}),$.length>0)$.reverse().map((A)=>{if(A==="}")H.push({type:"brace",value:"}"});else if(A==="]")H.push({type:"paren",value:"]"})});return H},$Z0=(H)=>{let $="";return H.map((A)=>{switch(A.type){case"string":$+='"'+A.value+'"';break;default:$+=A.value;break}}),$},RB$=(H)=>JSON.parse($Z0(HZ0(f4H(ew0(H)))));var jLA=()=>{};var zAH=K(()=>{TV()});var yB$=K(()=>{WLA()});function NcL(H){return H.type==="tool_use"||H.type==="server_tool_use"||H.type==="mcp_tool_use"}function OcL(H){}var Wq,hi,E4H,BTH,vB$,fTH,ETH,hB$,MTH,Fu,GTH,bB$,kB$,M4H,uB$,gB$,RLA,qcL,mB$,yLA,vLA,hLA,TcL,zcL="__json_buf",UTH;var xcL=K(()=>{Uu();jLA();zAH();yB$();SLA();UTH=class UTH{constructor(H){Wq.add(this),this.messages=[],this.receivedMessages=[],hi.set(this,void 0),E4H.set(this,null),this.controller=new AbortController,BTH.set(this,void 0),vB$.set(this,()=>{}),fTH.set(this,()=>{}),ETH.set(this,void 0),hB$.set(this,()=>{}),MTH.set(this,()=>{}),Fu.set(this,{}),GTH.set(this,!1),bB$.set(this,!1),kB$.set(this,!1),M4H.set(this,!1),uB$.set(this,void 0),gB$.set(this,void 0),mB$.set(this,($)=>{if(ED(this,bB$,!0,"f"),Xu($))$=new lf;if($ instanceof lf)return ED(this,kB$,!0,"f"),this._emit("abort",$);if($ instanceof LD)return this._emit("error",$);if($ instanceof Error){let A=new LD($.message);return A.cause=$,this._emit("error",A)}return this._emit("error",new LD(String($)))}),ED(this,BTH,new Promise(($,A)=>{ED(this,vB$,$,"f"),ED(this,fTH,A,"f")}),"f"),ED(this,ETH,new Promise(($,A)=>{ED(this,hB$,$,"f"),ED(this,MTH,A,"f")}),"f"),xA(this,BTH,"f").catch(()=>{}),xA(this,ETH,"f").catch(()=>{}),ED(this,E4H,H,"f")}get response(){return xA(this,uB$,"f")}get request_id(){return xA(this,gB$,"f")}async withResponse(){let H=await xA(this,BTH,"f");if(!H)throw Error("Could not resolve a `Response` object");return{data:this,response:H,request_id:H.headers.get("request-id")}}static fromReadableStream(H){let $=new UTH(null);return $._run(()=>$._fromReadableStream(H)),$}static createMessage(H,$,A){let L=new UTH($);for(let I of $.messages)L._addMessageParam(I);return ED(L,E4H,{...$,stream:!0},"f"),L._run(()=>L._createMessage(H,{...$,stream:!0},{...A,headers:{...A?.headers,"X-Stainless-Helper-Method":"stream"}})),L}_run(H){H().then(()=>{this._emitFinal(),this._emit("end")},xA(this,mB$,"f"))}_addMessageParam(H){this.messages.push(H)}_addMessage(H,$=!0){if(this.receivedMessages.push(H),$)this._emit("message",H)}async _createMessage(H,$,A){let L=A?.signal,I;if(L){if(L.aborted)this.controller.abort();I=this.controller.abort.bind(this.controller),L.addEventListener("abort",I)}try{xA(this,Wq,"m",yLA).call(this);let{response:D,data:B}=await H.create({...$,stream:!0},{...A,signal:this.controller.signal}).withResponse();this._connected(D);for await(let f of B)xA(this,Wq,"m",vLA).call(this,f);if(B.controller.signal?.aborted)throw new lf;xA(this,Wq,"m",hLA).call(this)}finally{if(L&&I)L.removeEventListener("abort",I)}}_connected(H){if(this.ended)return;ED(this,uB$,H,"f"),ED(this,gB$,H?.headers.get("request-id"),"f"),xA(this,vB$,"f").call(this,H),this._emit("connect")}get ended(){return xA(this,GTH,"f")}get errored(){return xA(this,bB$,"f")}get aborted(){return xA(this,kB$,"f")}abort(){this.controller.abort()}on(H,$){return(xA(this,Fu,"f")[H]||(xA(this,Fu,"f")[H]=[])).push({listener:$}),this}off(H,$){let A=xA(this,Fu,"f")[H];if(!A)return this;let L=A.findIndex((I)=>I.listener===$);if(L>=0)A.splice(L,1);return this}once(H,$){return(xA(this,Fu,"f")[H]||(xA(this,Fu,"f")[H]=[])).push({listener:$,once:!0}),this}emitted(H){return new Promise(($,A)=>{if(ED(this,M4H,!0,"f"),H!=="error")this.once("error",A);this.once(H,$)})}async done(){ED(this,M4H,!0,"f"),await xA(this,ETH,"f")}get currentMessage(){return xA(this,hi,"f")}async finalMessage(){return await this.done(),xA(this,Wq,"m",RLA).call(this)}async finalText(){return await this.done(),xA(this,Wq,"m",qcL).call(this)}_emit(H,...$){if(xA(this,GTH,"f"))return;if(H==="end")ED(this,GTH,!0,"f"),xA(this,hB$,"f").call(this);let A=xA(this,Fu,"f")[H];if(A)xA(this,Fu,"f")[H]=A.filter((L)=>!L.once),A.forEach(({listener:L})=>L(...$));if(H==="abort"){let L=$[0];if(!xA(this,M4H,"f")&&!A?.length)Promise.reject(L);xA(this,fTH,"f").call(this,L),xA(this,MTH,"f").call(this,L),this._emit("end");return}if(H==="error"){let L=$[0];if(!xA(this,M4H,"f")&&!A?.length)Promise.reject(L);xA(this,fTH,"f").call(this,L),xA(this,MTH,"f").call(this,L),this._emit("end")}}_emitFinal(){if(this.receivedMessages.at(-1))this._emit("finalMessage",xA(this,Wq,"m",RLA).call(this))}async _fromReadableStream(H,$){let A=$?.signal,L;if(A){if(A.aborted)this.controller.abort();L=this.controller.abort.bind(this.controller),A.addEventListener("abort",L)}try{xA(this,Wq,"m",yLA).call(this),this._connected(null);let I=zV.fromReadableStream(H,this.controller);for await(let D of I)xA(this,Wq,"m",vLA).call(this,D);if(I.controller.signal?.aborted)throw new lf;xA(this,Wq,"m",hLA).call(this)}finally{if(A&&L)A.removeEventListener("abort",L)}}[(hi=new WeakMap,E4H=new WeakMap,BTH=new WeakMap,vB$=new WeakMap,fTH=new WeakMap,ETH=new WeakMap,hB$=new WeakMap,MTH=new WeakMap,Fu=new WeakMap,GTH=new WeakMap,bB$=new WeakMap,kB$=new WeakMap,M4H=new WeakMap,uB$=new WeakMap,gB$=new WeakMap,mB$=new WeakMap,Wq=new WeakSet,RLA=function(){if(this.receivedMessages.length===0)throw new LD("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},qcL=function(){if(this.receivedMessages.length===0)throw new LD("stream ended without producing a Message with role=assistant");let $=this.receivedMessages.at(-1).content.filter((A)=>A.type==="text").map((A)=>A.text);if($.length===0)throw new LD("stream ended without producing a content block with type=text");return $.join(" ")},yLA=function(){if(this.ended)return;ED(this,hi,void 0,"f")},vLA=function($){if(this.ended)return;let A=xA(this,Wq,"m",TcL).call(this,$);switch(this._emit("streamEvent",$,A),$.type){case"content_block_delta":{let L=A.content.at(-1);switch($.delta.type){case"text_delta":{if(L.type==="text")this._emit("text",$.delta.text,L.text||"");break}case"citations_delta":{if(L.type==="text")this._emit("citation",$.delta.citation,L.citations??[]);break}case"input_json_delta":{if(NcL(L)&&L.input)this._emit("inputJson",$.delta.partial_json,L.input);break}case"thinking_delta":{if(L.type==="thinking")this._emit("thinking",$.delta.thinking,L.thinking);break}case"signature_delta":{if(L.type==="thinking")this._emit("signature",L.signature);break}default:OcL($.delta)}break}case"message_stop":{this._addMessageParam(A),this._addMessage(OLA(A,xA(this,E4H,"f")),!0);break}case"content_block_stop":{this._emit("contentBlock",A.content.at(-1));break}case"message_start":{ED(this,hi,A,"f");break}case"content_block_start":case"message_delta":break}},hLA=function(){if(this.ended)throw new LD("stream has ended, this shouldn't happen");let $=xA(this,hi,"f");if(!$)throw new LD("request ended without sending any chunks");return ED(this,hi,void 0,"f"),OLA($,xA(this,E4H,"f"))},TcL=function($){let A=xA(this,hi,"f");if($.type==="message_start"){if(A)throw new LD(`Unexpected event order, got ${$.type} before receiving "message_stop"`);return $.message}if(!A)throw new LD(`Unexpected event order, got ${$.type} before "message_start"`);switch($.type){case"message_stop":return A;case"message_delta":if(A.container=$.delta.container,A.stop_reason=$.delta.stop_reason,A.stop_sequence=$.delta.stop_sequence,A.usage.output_tokens=$.usage.output_tokens,A.context_management=$.context_management,$.usage.input_tokens!=null)A.usage.input_tokens=$.usage.input_tokens;if($.usage.cache_creation_input_tokens!=null)A.usage.cache_creation_input_tokens=$.usage.cache_creation_input_tokens;if($.usage.cache_read_input_tokens!=null)A.usage.cache_read_input_tokens=$.usage.cache_read_input_tokens;if($.usage.server_tool_use!=null)A.usage.server_tool_use=$.usage.server_tool_use;return A;case"content_block_start":return A.content.push($.content_block),A;case"content_block_delta":{let L=A.content.at($.index);switch($.delta.type){case"text_delta":{if(L?.type==="text")A.content[$.index]={...L,text:(L.text||"")+$.delta.text};break}case"citations_delta":{if(L?.type==="text")A.content[$.index]={...L,citations:[...L.citations??[],$.delta.citation]};break}case"input_json_delta":{if(L&&NcL(L)){let I=L[zcL]||"";I+=$.delta.partial_json;let D={...L};if(Object.defineProperty(D,zcL,{value:I,enumerable:!1,writable:!0}),I)try{D.input=RB$(I)}catch(B){let f=new LD(`Unable to parse tool parameter JSON from model. Please retry your request or adjust your prompt. Error: ${B}. JSON: ${I}`);xA(this,mB$,"f").call(this,f)}A.content[$.index]=D}break}case"thinking_delta":{if(L?.type==="thinking")A.content[$.index]={...L,thinking:L.thinking+$.delta.thinking};break}case"signature_delta":{if(L?.type==="thinking")A.content[$.index]={...L,signature:$.delta.signature};break}default:OcL($.delta)}return A}case"content_block_stop":return A}},Symbol.asyncIterator)](){let H=[],$=[],A=!1;return this.on("streamEvent",(L)=>{let I=$.shift();if(I)I.resolve(L);else H.push(L)}),this.on("end",()=>{A=!0;for(let L of $)L.resolve(void 0);$.length=0}),this.on("abort",(L)=>{A=!0;for(let I of $)I.reject(L);$.length=0}),this.on("error",(L)=>{A=!0;for(let I of $)I.reject(L);$.length=0}),{next:async()=>{if(!H.length){if(A)return{value:void 0,done:!0};return new Promise((I,D)=>$.push({resolve:I,reject:D})).then((I)=>I?{value:I,done:!1}:{value:void 0,done:!0})}return{value:H.shift(),done:!1}},return:async()=>{return this.abort(),{value:void 0,done:!0}}}}toReadableStream(){return new zV(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}});function ScL(){let H,$;return{promise:new Promise((L,I)=>{H=L,$=I}),resolve:H,reject:$}}async function AZ0(H,$=H.messages.at(-1)){if(!$||$.role!=="assistant"||!$.content||typeof $.content==="string")return null;let A=$.content.filter((I)=>I.type==="tool_use");if(A.length===0)return null;return{role:"user",content:await Promise.all(A.map(async(I)=>{let D=H.tools.find((B)=>B.name===I.name);if(!D||!("run"in D))return{type:"tool_result",tool_use_id:I.id,content:`Error: Tool '${I.name}' not found`,is_error:!0};try{let B=I.input;if("parse"in D&&D.parse)B=D.parse(B);let f=await D.run(B);return{type:"tool_result",tool_use_id:I.id,content:f}}catch(B){return{type:"tool_result",tool_use_id:I.id,content:`Error: ${B instanceof Error?B.message:String(B)}`,is_error:!0}}}))}}var pB$,G4H,NAH,m_,XTH,eN,Ku,bi,JTH,bLA,FTH;var kLA=K(()=>{Uu();TV();Qq();FTH=class FTH{constructor(H,$,A){pB$.add(this),this.client=H,G4H.set(this,!1),NAH.set(this,!1),m_.set(this,void 0),XTH.set(this,void 0),eN.set(this,void 0),Ku.set(this,void 0),bi.set(this,void 0),JTH.set(this,0),ED(this,m_,{params:{...$,messages:structuredClone($.messages)}},"f"),ED(this,XTH,{...A,headers:Z9([{"x-stainless-helper":"BetaToolRunner"},A?.headers])},"f"),ED(this,bi,ScL(),"f")}async*[(G4H=new WeakMap,NAH=new WeakMap,m_=new WeakMap,XTH=new WeakMap,eN=new WeakMap,Ku=new WeakMap,bi=new WeakMap,JTH=new WeakMap,pB$=new WeakSet,Symbol.asyncIterator)](){var H;if(xA(this,G4H,"f"))throw new LD("Cannot iterate over a consumed stream");ED(this,G4H,!0,"f"),ED(this,NAH,!0,"f"),ED(this,Ku,void 0,"f");try{while(!0){let $;try{if(xA(this,m_,"f").params.max_iterations&&xA(this,JTH,"f")>=xA(this,m_,"f").params.max_iterations)break;ED(this,NAH,!1,"f"),ED(this,eN,void 0,"f"),ED(this,Ku,void 0,"f"),ED(this,JTH,(H=xA(this,JTH,"f"),H++,H),"f");let{max_iterations:A,...L}=xA(this,m_,"f").params;if(L.stream)$=this.client.beta.messages.stream({...L},xA(this,XTH,"f")),ED(this,eN,$.finalMessage(),"f"),xA(this,eN,"f").catch(()=>{}),yield $;else ED(this,eN,this.client.beta.messages.create({...L,stream:!1},xA(this,XTH,"f")),"f"),yield xA(this,eN,"f");if(!xA(this,NAH,"f")){let{role:D,content:B}=await xA(this,eN,"f");xA(this,m_,"f").params.messages.push({role:D,content:B})}let I=await xA(this,pB$,"m",bLA).call(this,xA(this,m_,"f").params.messages.at(-1));if(I)xA(this,m_,"f").params.messages.push(I);if(!I&&!xA(this,NAH,"f"))break}finally{if($)$.abort()}}if(!xA(this,eN,"f"))throw new LD("ToolRunner concluded without a message from the server");xA(this,bi,"f").resolve(await xA(this,eN,"f"))}catch($){throw ED(this,G4H,!1,"f"),xA(this,bi,"f").promise.catch(()=>{}),xA(this,bi,"f").reject($),ED(this,bi,ScL(),"f"),$}}setMessagesParams(H){if(typeof H==="function")xA(this,m_,"f").params=H(xA(this,m_,"f").params);else xA(this,m_,"f").params=H;ED(this,NAH,!0,"f"),ED(this,Ku,void 0,"f")}async generateToolResponse(){let H=await xA(this,eN,"f")??this.params.messages.at(-1);if(!H)return null;return xA(this,pB$,"m",bLA).call(this,H)}done(){return xA(this,bi,"f").promise}async runUntilDone(){if(!xA(this,G4H,"f"))for await(let H of this);return this.done()}get params(){return xA(this,m_,"f").params}pushMessages(...H){this.setMessagesParams(($)=>({...$,messages:[...$.messages,...H]}))}then(H,$){return this.runUntilDone().then(H,$)}};bLA=async function($){if(xA(this,Ku,"f")!==void 0)return xA(this,Ku,"f");return ED(this,Ku,AZ0(xA(this,m_,"f").params,$),"f"),xA(this,Ku,"f")}});var U4H;var uLA=K(()=>{TV();KLA();U4H=class U4H{constructor(H,$){this.iterator=H,this.controller=$}async*decoder(){let H=new yi;for await(let $ of this.iterator)for(let A of H.decode($))yield JSON.parse(A);for(let $ of H.flush())yield JSON.parse($)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(H,$){if(!H.body){if($.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative")throw new LD("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new LD("Attempted to iterate over a response with no body")}return new U4H(tqH(H.body),$)}}});var KTH;var gLA=K(()=>{rR();Qq();uLA();zAH();vi();KTH=class KTH extends _5{create(H,$){let{betas:A,...L}=H;return this._client.post("/v1/messages/batches?beta=true",{body:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"message-batches-2024-09-24"].toString()},$?.headers])})}retrieve(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/messages/batches/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"message-batches-2024-09-24"].toString()},A?.headers])})}list(H={},$){let{betas:A,...L}=H??{};return this._client.getAPIList("/v1/messages/batches?beta=true",sN,{query:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"message-batches-2024-09-24"].toString()},$?.headers])})}delete(H,$={},A){let{betas:L}=$??{};return this._client.delete(_4`/v1/messages/batches/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"message-batches-2024-09-24"].toString()},A?.headers])})}cancel(H,$={},A){let{betas:L}=$??{};return this._client.post(_4`/v1/messages/batches/${H}/cancel?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"message-batches-2024-09-24"].toString()},A?.headers])})}async results(H,$={},A){let L=await this.retrieve(H);if(!L.results_url)throw new LD(`No batch \`results_url\`; Has it finished processing? ${L.processing_status} - ${L.id}`);let{betas:I}=$??{};return this._client.get(L.results_url,{...A,headers:Z9([{"anthropic-beta":[...I??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary"},A?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((D,B)=>U4H.fromResponse(B.response,B.controller))}}});var jcL,OAH;var mLA=K(()=>{NLA();Qq();SLA();xcL();kLA();gLA();gLA();kLA();jcL={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-7-sonnet-latest":"February 19th, 2026","claude-3-7-sonnet-20250219":"February 19th, 2026"};OAH=class OAH extends _5{constructor(){super(...arguments);this.batches=new KTH(this._client)}create(H,$){let{betas:A,...L}=H;if(L.model in jcL)console.warn(`The model '${L.model}' is deprecated and will reach end-of-life on ${jcL[L.model]}
480e4d7c Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let I=this._client._options.timeout;if(!L.stream&&I==null){let D=jB$[L.model]??void 0;I=this._client.calculateNonstreamingTimeout(L.max_tokens,D)}return this._client.post("/v1/messages?beta=true",{body:L,timeout:I??600000,...$,headers:Z9([{...A?.toString()!=null?{"anthropic-beta":A?.toString()}:void 0},$?.headers]),stream:H.stream??!1})}parse(H,$){return $={...$,headers:Z9([{"anthropic-beta":[...H.betas??[],"structured-outputs-2025-09-17"].toString()},$?.headers])},this.create(H,$).then((A)=>xLA(A,H))}stream(H,$){return UTH.createMessage(this,H,$)}countTokens(H,$){let{betas:A,...L}=H;return this._client.post("/v1/messages/count_tokens?beta=true",{body:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"token-counting-2024-11-01"].toString()},$?.headers])})}toolRunner(H,$){return new FTH(this._client,H,$)}};OAH.Batches=KTH;OAH.BetaToolRunner=FTH});var QTH;var pLA=K(()=>{rR();Qq();B4H();vi();QTH=class QTH extends _5{create(H,$={},A){let{betas:L,...I}=$??{};return this._client.post(_4`/v1/skills/${H}/versions?beta=true`,D4H({body:I,...A,headers:Z9([{"anthropic-beta":[...L??[],"skills-2025-10-02"].toString()},A?.headers])},this._client))}retrieve(H,$,A){let{skill_id:L,betas:I}=$;return this._client.get(_4`/v1/skills/${L}/versions/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...I??[],"skills-2025-10-02"].toString()},A?.headers])})}list(H,$={},A){let{betas:L,...I}=$??{};return this._client.getAPIList(_4`/v1/skills/${H}/versions?beta=true`,ATH,{query:I,...A,headers:Z9([{"anthropic-beta":[...L??[],"skills-2025-10-02"].toString()},A?.headers])})}delete(H,$,A){let{skill_id:L,betas:I}=$;return this._client.delete(_4`/v1/skills/${L}/versions/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...I??[],"skills-2025-10-02"].toString()},A?.headers])})}}});var X4H;var dLA=K(()=>{pLA();pLA();rR();Qq();B4H();vi();X4H=class X4H extends _5{constructor(){super(...arguments);this.versions=new QTH(this._client)}create(H={},$){let{betas:A,...L}=H??{};return this._client.post("/v1/skills?beta=true",D4H({body:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"skills-2025-10-02"].toString()},$?.headers])},this._client))}retrieve(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/skills/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"skills-2025-10-02"].toString()},A?.headers])})}list(H={},$){let{betas:A,...L}=H??{};return this._client.getAPIList("/v1/skills?beta=true",ATH,{query:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"skills-2025-10-02"].toString()},$?.headers])})}delete(H,$={},A){let{betas:L}=$??{};return this._client.delete(_4`/v1/skills/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"skills-2025-10-02"].toString()},A?.headers])})}};X4H.Versions=QTH});var y6;var cLA=K(()=>{TLA();TLA();zLA();zLA();mLA();mLA();dLA();dLA();y6=class y6 extends _5{constructor(){super(...arguments);this.models=new DTH(this._client),this.messages=new OAH(this._client),this.files=new ITH(this._client),this.skills=new X4H(this._client)}};y6.Models=DTH;y6.Messages=OAH;y6.Files=ITH;y6.Skills=X4H});var ki;var lLA=K(()=>{Qq();ki=class ki extends _5{create(H,$){let{betas:A,...L}=H;return this._client.post("/v1/complete",{body:L,timeout:this._client._options.timeout??600000,...$,headers:Z9([{...A?.toString()!=null?{"anthropic-beta":A?.toString()}:void 0},$?.headers]),stream:H.stream??!1})}}});function hcL(H){return H.type==="tool_use"||H.type==="server_tool_use"}function bcL(H){}var Vq,ui,WTH,dB$,VTH,PTH,cB$,_TH,Qu,CTH,lB$,iB$,J4H,nB$,rB$,iLA,RcL,nLA,rLA,aLA,oLA,ycL,vcL="__json_buf",YTH;var kcL=K(()=>{Uu();zAH();yB$();jLA();YTH=class YTH{constructor(){Vq.add(this),this.messages=[],this.receivedMessages=[],ui.set(this,void 0),this.controller=new AbortController,WTH.set(this,void 0),dB$.set(this,()=>{}),VTH.set(this,()=>{}),PTH.set(this,void 0),cB$.set(this,()=>{}),_TH.set(this,()=>{}),Qu.set(this,{}),CTH.set(this,!1),lB$.set(this,!1),iB$.set(this,!1),J4H.set(this,!1),nB$.set(this,void 0),rB$.set(this,void 0),nLA.set(this,(H)=>{if(ED(this,lB$,!0,"f"),Xu(H))H=new lf;if(H instanceof lf)return ED(this,iB$,!0,"f"),this._emit("abort",H);if(H instanceof LD)return this._emit("error",H);if(H instanceof Error){let $=new LD(H.message);return $.cause=H,this._emit("error",$)}return this._emit("error",new LD(String(H)))}),ED(this,WTH,new Promise((H,$)=>{ED(this,dB$,H,"f"),ED(this,VTH,$,"f")}),"f"),ED(this,PTH,new Promise((H,$)=>{ED(this,cB$,H,"f"),ED(this,_TH,$,"f")}),"f"),xA(this,WTH,"f").catch(()=>{}),xA(this,PTH,"f").catch(()=>{})}get response(){return xA(this,nB$,"f")}get request_id(){return xA(this,rB$,"f")}async withResponse(){let H=await xA(this,WTH,"f");if(!H)throw Error("Could not resolve a `Response` object");return{data:this,response:H,request_id:H.headers.get("request-id")}}static fromReadableStream(H){let $=new YTH;return $._run(()=>$._fromReadableStream(H)),$}static createMessage(H,$,A){let L=new YTH;for(let I of $.messages)L._addMessageParam(I);return L._run(()=>L._createMessage(H,{...$,stream:!0},{...A,headers:{...A?.headers,"X-Stainless-Helper-Method":"stream"}})),L}_run(H){H().then(()=>{this._emitFinal(),this._emit("end")},xA(this,nLA,"f"))}_addMessageParam(H){this.messages.push(H)}_addMessage(H,$=!0){if(this.receivedMessages.push(H),$)this._emit("message",H)}async _createMessage(H,$,A){let L=A?.signal,I;if(L){if(L.aborted)this.controller.abort();I=this.controller.abort.bind(this.controller),L.addEventListener("abort",I)}try{xA(this,Vq,"m",rLA).call(this);let{response:D,data:B}=await H.create({...$,stream:!0},{...A,signal:this.controller.signal}).withResponse();this._connected(D);for await(let f of B)xA(this,Vq,"m",aLA).call(this,f);if(B.controller.signal?.aborted)throw new lf;xA(this,Vq,"m",oLA).call(this)}finally{if(L&&I)L.removeEventListener("abort",I)}}_connected(H){if(this.ended)return;ED(this,nB$,H,"f"),ED(this,rB$,H?.headers.get("request-id"),"f"),xA(this,dB$,"f").call(this,H),this._emit("connect")}get ended(){return xA(this,CTH,"f")}get errored(){return xA(this,lB$,"f")}get aborted(){return xA(this,iB$,"f")}abort(){this.controller.abort()}on(H,$){return(xA(this,Qu,"f")[H]||(xA(this,Qu,"f")[H]=[])).push({listener:$}),this}off(H,$){let A=xA(this,Qu,"f")[H];if(!A)return this;let L=A.findIndex((I)=>I.listener===$);if(L>=0)A.splice(L,1);return this}once(H,$){return(xA(this,Qu,"f")[H]||(xA(this,Qu,"f")[H]=[])).push({listener:$,once:!0}),this}emitted(H){return new Promise(($,A)=>{if(ED(this,J4H,!0,"f"),H!=="error")this.once("error",A);this.once(H,$)})}async done(){ED(this,J4H,!0,"f"),await xA(this,PTH,"f")}get currentMessage(){return xA(this,ui,"f")}async finalMessage(){return await this.done(),xA(this,Vq,"m",iLA).call(this)}async finalText(){return await this.done(),xA(this,Vq,"m",RcL).call(this)}_emit(H,...$){if(xA(this,CTH,"f"))return;if(H==="end")ED(this,CTH,!0,"f"),xA(this,cB$,"f").call(this);let A=xA(this,Qu,"f")[H];if(A)xA(this,Qu,"f")[H]=A.filter((L)=>!L.once),A.forEach(({listener:L})=>L(...$));if(H==="abort"){let L=$[0];if(!xA(this,J4H,"f")&&!A?.length)Promise.reject(L);xA(this,VTH,"f").call(this,L),xA(this,_TH,"f").call(this,L),this._emit("end");return}if(H==="error"){let L=$[0];if(!xA(this,J4H,"f")&&!A?.length)Promise.reject(L);xA(this,VTH,"f").call(this,L),xA(this,_TH,"f").call(this,L),this._emit("end")}}_emitFinal(){if(this.receivedMessages.at(-1))this._emit("finalMessage",xA(this,Vq,"m",iLA).call(this))}async _fromReadableStream(H,$){let A=$?.signal,L;if(A){if(A.aborted)this.controller.abort();L=this.controller.abort.bind(this.controller),A.addEventListener("abort",L)}try{xA(this,Vq,"m",rLA).call(this),this._connected(null);let I=zV.fromReadableStream(H,this.controller);for await(let D of I)xA(this,Vq,"m",aLA).call(this,D);if(I.controller.signal?.aborted)throw new lf;xA(this,Vq,"m",oLA).call(this)}finally{if(A&&L)A.removeEventListener("abort",L)}}[(ui=new WeakMap,WTH=new WeakMap,dB$=new WeakMap,VTH=new WeakMap,PTH=new WeakMap,cB$=new WeakMap,_TH=new WeakMap,Qu=new WeakMap,CTH=new WeakMap,lB$=new WeakMap,iB$=new WeakMap,J4H=new WeakMap,nB$=new WeakMap,rB$=new WeakMap,nLA=new WeakMap,Vq=new WeakSet,iLA=function(){if(this.receivedMessages.length===0)throw new LD("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},RcL=function(){if(this.receivedMessages.length===0)throw new LD("stream ended without producing a Message with role=assistant");let $=this.receivedMessages.at(-1).content.filter((A)=>A.type==="text").map((A)=>A.text);if($.length===0)throw new LD("stream ended without producing a content block with type=text");return $.join(" ")},rLA=function(){if(this.ended)return;ED(this,ui,void 0,"f")},aLA=function($){if(this.ended)return;let A=xA(this,Vq,"m",ycL).call(this,$);switch(this._emit("streamEvent",$,A),$.type){case"content_block_delta":{let L=A.content.at(-1);switch($.delta.type){case"text_delta":{if(L.type==="text")this._emit("text",$.delta.text,L.text||"");break}case"citations_delta":{if(L.type==="text")this._emit("citation",$.delta.citation,L.citations??[]);break}case"input_json_delta":{if(hcL(L)&&L.input)this._emit("inputJson",$.delta.partial_json,L.input);break}case"thinking_delta":{if(L.type==="thinking")this._emit("thinking",$.delta.thinking,L.thinking);break}case"signature_delta":{if(L.type==="thinking")this._emit("signature",L.signature);break}default:bcL($.delta)}break}case"message_stop":{this._addMessageParam(A),this._addMessage(A,!0);break}case"content_block_stop":{this._emit("contentBlock",A.content.at(-1));break}case"message_start":{ED(this,ui,A,"f");break}case"content_block_start":case"message_delta":break}},oLA=function(){if(this.ended)throw new LD("stream has ended, this shouldn't happen");let $=xA(this,ui,"f");if(!$)throw new LD("request ended without sending any chunks");return ED(this,ui,void 0,"f"),$},ycL=function($){let A=xA(this,ui,"f");if($.type==="message_start"){if(A)throw new LD(`Unexpected event order, got ${$.type} before receiving "message_stop"`);return $.message}if(!A)throw new LD(`Unexpected event order, got ${$.type} before "message_start"`);switch($.type){case"message_stop":return A;case"message_delta":if(A.stop_reason=$.delta.stop_reason,A.stop_sequence=$.delta.stop_sequence,A.usage.output_tokens=$.usage.output_tokens,$.usage.input_tokens!=null)A.usage.input_tokens=$.usage.input_tokens;if($.usage.cache_creation_input_tokens!=null)A.usage.cache_creation_input_tokens=$.usage.cache_creation_input_tokens;if($.usage.cache_read_input_tokens!=null)A.usage.cache_read_input_tokens=$.usage.cache_read_input_tokens;if($.usage.server_tool_use!=null)A.usage.server_tool_use=$.usage.server_tool_use;return A;case"content_block_start":return A.content.push({...$.content_block}),A;case"content_block_delta":{let L=A.content.at($.index);switch($.delta.type){case"text_delta":{if(L?.type==="text")A.content[$.index]={...L,text:(L.text||"")+$.delta.text};break}case"citations_delta":{if(L?.type==="text")A.content[$.index]={...L,citations:[...L.citations??[],$.delta.citation]};break}case"input_json_delta":{if(L&&hcL(L)){let I=L[vcL]||"";I+=$.delta.partial_json;let D={...L};if(Object.defineProperty(D,vcL,{value:I,enumerable:!1,writable:!0}),I)D.input=RB$(I);A.content[$.index]=D}break}case"thinking_delta":{if(L?.type==="thinking")A.content[$.index]={...L,thinking:L.thinking+$.delta.thinking};break}case"signature_delta":{if(L?.type==="thinking")A.content[$.index]={...L,signature:$.delta.signature};break}default:bcL($.delta)}return A}case"content_block_stop":return A}},Symbol.asyncIterator)](){let H=[],$=[],A=!1;return this.on("streamEvent",(L)=>{let I=$.shift();if(I)I.resolve(L);else H.push(L)}),this.on("end",()=>{A=!0;for(let L of $)L.resolve(void 0);$.length=0}),this.on("abort",(L)=>{A=!0;for(let I of $)I.reject(L);$.length=0}),this.on("error",(L)=>{A=!0;for(let I of $)I.reject(L);$.length=0}),{next:async()=>{if(!H.length){if(A)return{value:void 0,done:!0};return new Promise((I,D)=>$.push({resolve:I,reject:D})).then((I)=>I?{value:I,done:!1}:{value:void 0,done:!0})}return{value:H.shift(),done:!1}},return:async()=>{return this.abort(),{value:void 0,done:!0}}}}toReadableStream(){return new zV(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}});var wTH;var tLA=K(()=>{rR();Qq();uLA();zAH();vi();wTH=class wTH extends _5{create(H,$){return this._client.post("/v1/messages/batches",{body:H,...$})}retrieve(H,$){return this._client.get(_4`/v1/messages/batches/${H}`,$)}list(H={},$){return this._client.getAPIList("/v1/messages/batches",sN,{query:H,...$})}delete(H,$){return this._client.delete(_4`/v1/messages/batches/${H}`,$)}cancel(H,$){return this._client.post(_4`/v1/messages/batches/${H}/cancel`,$)}async results(H,$){let A=await this.retrieve(H);if(!A.results_url)throw new LD(`No batch \`results_url\`; Has it finished processing? ${A.processing_status} - ${A.id}`);return this._client.get(A.results_url,{...$,headers:Z9([{Accept:"application/binary"},$?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((L,I)=>U4H.fromResponse(I.response,I.controller))}}});var w2,ucL;var sLA=K(()=>{kcL();tLA();tLA();NLA();w2=class w2 extends _5{constructor(){super(...arguments);this.batches=new wTH(this._client)}create(H,$){if(H.model in ucL)console.warn(`The model '${H.model}' is deprecated and will reach end-of-life on ${ucL[H.model]}
487ec789 `),querySource:D.querySource,tools:vH(u)}:void 0,g=_vI(D.model,y,Y),v=Date.now(),p=Date.now(),d=0,k=void 0,n=void 0,GH=void 0,e=(HH)=>{let $H=[...f],DH=HD()==="bedrock"?[...ud$(HH.model),...G?[G]:[]]:[],MH=$X$(DH),AH={...MH.output_config??{}},KH=YyD()??D.effortValue??oaL(D.model);if(FY1(KH,AH,MH,$H,D.model),D.outputFormat&&!("format"in AH)){if(AH.format=D.outputFormat,!$H.includes(_c))$H.push(_c)}let CH=void 0;if(A!==0)if(YhI(D.model)){if(MH.thinking={type:"adaptive"},!$H.includes(BS$))$H.push(BS$);let lH=$H.indexOf(QlH);if(lH!==-1)$H.splice(lH,1)}else{let lH=A??PlH(D.model),hH=HH.maxTokensOverride||D.maxOutputTokensOverride;CH={budget_tokens:hH?Math.min(lH,hH-1):lH,type:"enabled"}}let TH=waL({hasThinking:A!==0}),yH=HH?.maxTokensOverride||D.maxOutputTokensOverride||Math.max((A??0)+1,zNA(D.model)),gH=D.enablePromptCaching??lrD(HH.model),QH=A!==0?void 0:D.temperatureOverride??1;return{model:zu(D.model),messages:VY1(Y,gH),system:O,tools:[...P,...D.extraToolSchemas??[]],tool_choice:D.toolChoice,...j?{betas:$H}:{},metadata:Kr(),max_tokens:yH,thinking:CH,...QH!==void 0&&{temperature:QH},...TH&&j&&$H.includes(WlH)?{context_management:TH}:{},...MH,...Object.keys(AH).length>0?{output_config:AH}:{}}};D.getToolPermissionContext().then((HH)=>{let $H=e({model:D.model,maxThinkingTokens:A}),MH=$H.output_config?.effort??"unset";WhI({model:D.model,messagesLength:$H.messages.length,temperature:D.temperatureOverride??1,betas:j?$H.betas??[]:[],permissionMode:HH.mode,querySource:D.querySource,queryTracking:D.queryTracking,effortValue:MH})});let BH=[],VH=0,wH=void 0,WH=[],qH=TC,s=0,IH=null,FH=!1,EH=0,YH=void 0,OH=void 0;try{W9("query_client_creation_start");let HH=KU$(()=>lO({maxRetries:0,model:D.model,fetchOverride:D.fetchOverride}),async(DH,MH,AH)=>{d=MH,p=Date.now();let KH=e(AH);LtH(KH,D.querySource),EH=KH.max_tokens;let CH=await DH.beta.messages.create({...KH,stream:!0},{signal:I}).withResponse();return n=CH.request_id,GH=CH.response,CH.data},{model:D.model,fallbackModel:D.fallbackModel,maxThinkingTokens:A,...!1,signal:I}),$H;do if($H=await HH.next(),!("controller"in $H.value))yield $H.value;while(!$H.done);if(k=$H.value,W9("query_client_creation_end"),BH.length=0,VH=0,wH=void 0,WH.length=0,qH=TC,IH=null,W9("query_api_request_sent"),!D.agentId)u9H("api_request_sent");try{let DH=!0,MH=null,AH=30000,KH=0,CH=0;for await(let yH of k){let gH=Date.now();if(MH!==null){let QH=gH-MH;if(QH>AH)CH++,KH+=QH,N(`Streaming stall detected: ${(QH/1000).toFixed(1)}s gap between events (stall #${CH})`,{level:"warn"}),c("tengu_streaming_stall",{stall_duration_ms:QH,stall_count:CH,total_stall_time_ms:KH,event_type:yH.type,model:D.model,request_id:n??"unknown"})}if(MH=gH,DH){if(N("Stream started - received first chunk"),W9("query_first_chunk_received"),!D.agentId)u9H("first_chunk");czD(),DH=!1}switch(yH.type){case"message_start":{wH=yH.message,VH=Date.now()-p,qH=O9H(qH,yH.message.usage);break}case"content_block_start":switch(yH.content_block.type){case"tool_use":WH[yH.index]={...yH.content_block,input:""};break;case"server_tool_use":WH[yH.index]={...yH.content_block,input:""};break;case"text":WH[yH.index]={...yH.content_block,text:""};break;case"thinking":WH[yH.index]={...yH.content_block,thinking:"",signature:""};break;default:WH[yH.index]={...yH.content_block};break}break;case"content_block_delta":{let QH=WH[yH.index];if(!QH)throw c("tengu_streaming_error",{error_type:"content_block_not_found_delta",part_type:yH.type,part_index:yH.index}),RangeError("Content block not found");switch(yH.delta.type){case"citations_delta":break;case"input_json_delta":if(QH.type!=="tool_use"&&QH.type!=="server_tool_use")throw c("tengu_streaming_error",{error_type:"content_block_type_mismatch_input_json",expected_type:"tool_use",actual_type:QH.type}),Error("Content block is not a input_json block");if(typeof QH.input!=="string")throw c("tengu_streaming_error",{error_type:"content_block_input_not_string",input_type:typeof QH.input}),Error("Content block input is not a string");QH.input+=yH.delta.partial_json;break;case"text_delta":if(QH.type!=="text")throw c("tengu_streaming_error",{error_type:"content_block_type_mismatch_text",expected_type:"text",actual_type:QH.type}),Error("Content block is not a text block");QH.text+=yH.delta.text;break;case"signature_delta":if(QH.type!=="thinking")throw c("tengu_streaming_error",{error_type:"content_block_type_mismatch_thinking_signature",expected_type:"thinking",actual_type:QH.type}),Error("Content block is not a thinking block");QH.signature=yH.delta.signature;break;case"thinking_delta":if(QH.type!=="thinking")throw c("tengu_streaming_error",{error_type:"content_block_type_mismatch_thinking_delta",expected_type:"thinking",actual_type:QH.type}),Error("Content block is not a thinking block");QH.thinking+=yH.delta.thinking;break}break}case"content_block_stop":{let QH=WH[yH.index];if(!QH)throw c("tengu_streaming_error",{error_type:"content_block_not_found_stop",part_type:yH.type,part_index:yH.index}),RangeError("Content block not found");if(!wH)throw c("tengu_streaming_error",{error_type:"partial_message_not_found",part_type:yH.type}),Error("Message not found");let lH={message:{...wH,content:Xz$([QH],L,D.agentId)},requestId:n??void 0,type:"assistant",uuid:Uz$.randomUUID(),timestamp:new Date().toISOString(),...{}};BH.push(lH),yield lH;break}case"message_delta":{qH=O9H(qH,yH.usage);let QH=BH[BH.length-1];if(QH)QH.message={...QH.message,usage:qH};IH=yH.delta.stop_reason;let lH=D9$(B,qH);$9$(lH,qH,D.model),s+=lH;let hH=y6I(yH.delta.stop_reason,D.model);if(hH)yield hH;if(IH==="max_tokens")c("tengu_max_tokens_reached",{max_tokens:EH}),yield Yf({content:`${z5}: Claude's response exceeded the ${EH} output token maximum. To configure this behavior, set the CLAUDE_CODE_MAX_OUTPUT_TOKENS environment variable.`,apiError:"max_output_tokens"});if(IH==="model_context_window_exceeded")c("tengu_context_window_exceeded",{max_tokens:EH,output_tokens:qH.output_tokens}),yield Yf({content:`${z5}: The model has reached its context window limit.`});break}case"message_stop":break}yield{type:"stream_event",event:yH}}if(!wH||BH.length===0&&!IH)throw N(!wH?"Stream completed without receiving message_start event - triggering non-streaming fallback":"Stream completed with message_start but no content blocks completed - triggering non-streaming fallback",{level:"error"}),c("tengu_stream_no_events",{model:D.model,request_id:n??"unknown"}),Error("Stream ended without receiving any events");if(CH>0)N(`Streaming completed with ${CH} stall(s), total stall time: ${(KH/1000).toFixed(1)}s`,{level:"warn"}),c("tengu_streaming_stall_summary",{stall_count:CH,total_stall_time_ms:KH,model:D.model,request_id:n??"unknown"});tvI(D.querySource,qH.cache_read_input_tokens,qH.cache_creation_input_tokens,H,D.agentId);let TH=GH;if(TH)kUA(TH.headers),YH=TH.headers}catch(DH){if(DH instanceof lf)if(I.aborted)throw N(`Streaming aborted by user: ${DH instanceof Error?DH.message:String(DH)}`),DH;else throw N(`Streaming timeout (SDK abort): ${DH.message}`,{level:"error"}),new nR({message:"Request timed out"});if(N(`Error streaming, falling back to non-streaming mode: ${DH instanceof Error?DH.message:String(DH)}`,{level:"error"}),FH=!0,D.onStreamingFallback)D.onStreamingFallback();c("tengu_streaming_fallback_to_non_streaming",{model:D.model,error:DH instanceof Error?DH.name:String(DH),attemptNumber:d,maxOutputTokens:EH,maxThinkingTokens:A});let MH=yield*irD({model:D.model},{model:D.model,maxThinkingTokens:A,...{},signal:I},e,(KH,CH,TH)=>{d=KH,EH=TH},(KH)=>LtH(KH,D.querySource)),AH={message:{...MH,content:Xz$(MH.content,L,D.agentId)},requestId:n??void 0,type:"assistant",uuid:Uz$.randomUUID(),timestamp:new Date().toISOString(),...{}};BH.push(AH),yield AH}}catch(HH){if(!FH&&HH instanceof my&&HH.originalError instanceof KD&&HH.originalError.status===404){if(N("Streaming endpoint returned 404, falling back to non-streaming mode",{level:"warn"}),FH=!0,D.onStreamingFallback)D.onStreamingFallback();c("tengu_streaming_fallback_to_non_streaming",{model:D.model,error:"404_stream_creation",attemptNumber:d,maxOutputTokens:EH,maxThinkingTokens:A});try{let DH=yield*irD({model:D.model},{model:D.model,maxThinkingTokens:A,...{},signal:I},e,(AH,KH,CH)=>{d=AH,EH=CH},(AH)=>LtH(AH,D.querySource)),MH={message:{...DH,content:Xz$(DH.content,L,D.agentId)},requestId:n??void 0,type:"assistant",uuid:Uz$.randomUUID(),timestamp:new Date().toISOString(),...{}};BH.push(MH),yield MH}catch(DH){N(`Non-streaming fallback also failed: ${DH instanceof Error?DH.message:String(DH)}`,{level:"error"});let MH=DH,AH=D.model;if(DH instanceof my)MH=DH.originalError,AH=DH.retryContext.model;if(MH instanceof KD)hG$(MH);let KH=n||(MH instanceof KD?MH.requestID:void 0)||(MH instanceof KD?MH.error?.request_id:void 0);if(O6A({error:MH,model:AH,messageCount:Y.length,messageTokens:VP(Y),durationMs:Date.now()-p,durationMsIncludingRetries:Date.now()-v,attempt:d,requestId:KH,didFallBackToNonStreaming:FH,queryTracking:D.queryTracking,querySource:D.querySource,llmSpan:g}),MH instanceof lf){$pH(k);return}yield XU$(MH,AH,{messages:H,messagesForAPI:Y}),$pH(k);return}}else{N(`Error in API request: ${HH instanceof Error?HH.message:String(HH)}`,{level:"error"});let DH=HH,MH=D.model;if(HH instanceof my)DH=HH.originalError,MH=HH.retryContext.model;if(DH instanceof KD)hG$(DH);let AH=n||(DH instanceof KD?DH.requestID:void 0)||(DH instanceof KD?DH.error?.request_id:void 0);if(O6A({error:DH,model:MH,messageCount:Y.length,messageTokens:VP(Y),durationMs:Date.now()-p,durationMsIncludingRetries:Date.now()-v,attempt:d,requestId:AH,didFallBackToNonStreaming:FH,queryTracking:D.queryTracking,querySource:D.querySource,llmSpan:g}),DH instanceof lf){$pH(k);return}yield XU$(DH,MH,{messages:H,messagesForAPI:Y}),$pH(k);return}}D.getToolPermissionContext().then((HH)=>{VhI({model:BH[0]?.message.model??wH?.model??D.model,preNormalizedModel:D.model,usage:qH,start:p,startIncludingRetries:v,attempt:d,messageCount:Y.length,messageTokens:VP(Y),requestId:n??null,stopReason:IH,ttftMs:VH,didFallBackToNonStreaming:FH,querySource:D.querySource,headers:YH,costUSD:s,queryTracking:D.queryTracking,permissionMode:HH.mode,newMessages:BH,llmSpan:g,globalCacheStrategy:W})}),$pH(k)}function $pH(H){if(!H)return;try{if(!H.controller.signal.aborted)H.controller.abort()}catch{}}function O9H(H,$){return{input_tokens:$.input_tokens!==null&&$.input_tokens>0?$.input_tokens:H.input_tokens,cache_creation_input_tokens:$.cache_creation_input_tokens!==null&&$.cache_creation_input_tokens>0?$.cache_creation_input_tokens:H.cache_creation_input_tokens,cache_read_input_tokens:$.cache_read_input_tokens!==null&&$.cache_read_input_tokens>0?$.cache_read_input_tokens:H.cache_read_input_tokens,output_tokens:$.output_tokens??H.output_tokens,server_tool_use:{web_search_requests:$.server_tool_use?.web_search_requests??H.server_tool_use.web_search_requests,web_fetch_requests:$.server_tool_use?.web_fetch_requests??H.server_tool_use.web_fetch_requests},service_tier:H.service_tier,cache_creation:{ephemeral_1h_input_tokens:$.cache_creation?.ephemeral_1h_input_tokens??H.cache_creation.ephemeral_1h_input_tokens,ephemeral_5m_input_tokens:$.cache_creation?.ephemeral_5m_input_tokens??H.cache_creation.ephemeral_5m_input_tokens}}}function cY$(H,$){return{input_tokens:H.input_tokens+$.input_tokens,cache_creation_input_tokens:H.cache_creation_input_tokens+$.cache_creation_input_tokens,cache_read_input_tokens:H.cache_read_input_tokens+$.cache_read_input_tokens,output_tokens:H.output_tokens+$.output_tokens,server_tool_use:{web_search_requests:H.server_tool_use.web_search_requests+$.server_tool_use.web_search_requests,web_fetch_requests:H.server_tool_use.web_fetch_requests+$.server_tool_use.web_fetch_requests},service_tier:$.service_tier,cache_creation:{ephemeral_1h_input_tokens:H.cache_creation.ephemeral_1h_input_tokens+$.cache_creation.ephemeral_1h_input_tokens,ephemeral_5m_input_tokens:H.cache_creation.ephemeral_5m_input_tokens+$.cache_creation.ephemeral_5m_input_tokens}}}function VY1(H,$){return c("tengu_api_cache_breakpoints",{totalMessageCount:H.length,cachingEnabled:$}),H.map((A,L)=>{return A.type==="user"?KY1(A,L>H.length-3,$):QY1(A,L>H.length-3,$)})}function PY1(H,$,A){return xOA(H,{skipGlobalCacheForSystemPrompt:A?.skipGlobalCacheForSystemPrompt}).map((L)=>{return{type:"text",text:L.text,...$&&L.cacheScope!==null?{cache_control:APH(L.cacheScope)}:{}}})}async function YQ({systemPrompt:H=[],userPrompt:$,outputFormat:A,signal:L,options:I}){return(await HX$([R$({content:H.map((B)=>({type:"text",text:B}))}),R$({content:$})],async()=>{let B=[R$({content:$})];return[await Qm({messages:B,systemPrompt:H,maxThinkingTokens:0,tools:[],signal:L,options:{...I,model:eX(),enablePromptCaching:I.enablePromptCaching??!1,outputFormat:A,async getToolPermissionContext(){return KK()}}})]}))[0]}async function fz$({systemPrompt:H=[],userPrompt:$,outputFormat:A,signal:L,options:I}){return(await HX$([R$({content:H.map((B)=>({type:"text",text:B}))}),R$({content:$})],async()=>{let B=[R$({content:$})];return[await Qm({messages:B,systemPrompt:H,maxThinkingTokens:0,tools:[],signal:L,options:{...I,enablePromptCaching:I.enablePromptCaching??!1,outputFormat:A,async getToolPermissionContext(){return KK()}}})]}))[0]}function CY1(H,$){let A=Math.min(H.max_tokens,$),L={...H};if(L.thinking?.type==="enabled"&&L.thinking.budget_tokens)L.thinking={...L.thinking,budget_tokens:Math.min(L.thinking.budget_tokens,A-1)};return{...L,max_tokens:A}}function zNA(H){let $=nfH(H),A=KlH.validate(process.env.CLAUDE_CODE_MAX_OUTPUT_TOKENS);if(A.status==="capped")N(`CLAUDE_CODE_MAX_OUTPUT_TOKENS ${A.message}`);else if(A.status==="invalid")N(`CLAUDE_CODE_MAX_OUTPUT_TOKENS ${A.message}`);return Math.min(A.effective,$)}var Uz$,_Y1=21333;var mU=K(()=>{ZaL();iI();V9$();yDA();qw();nt();oZ();vA();fI();NA();_$();_L();iI();rM();E3();mY();yy();jD();z$();cFA();dxH();QyH();oZH();lM();lIH();LHH();oZ();UT();ya();aS();yF();E$();FyH();Wt();Hq$();Cm();mY();G3H();huH();p$();zAH();gy();fI();MCH();iI();UBH();la();BzH();Yq();Z$();jD();i6();Uz$=require("crypto")});function ZY1(){return trD.randomBytes(8).toString("hex")}function TY1(H,$){let A=!1,L=!1;for(let I=0;I<$;I++){let D=H[I],B=0;for(let f=I-1;f>=0&&H[f]==="\\";f--)B++;if(B%2===1)continue;if(D==="'"&&!L)A=!A;else if(D==='"'&&!A)L=!L}return A||L}function zY1(H,$){let A=H.lastIndexOf(`
48895d82 `)})()}}async write(H){await this.transport.write(H)}close(){this.transport.close(),this.inputStream.end()}}});var EEB=K(()=>{OV();ei();oG();DK()});class MEB{config;mutableMessages;abortController;permissionDenials;totalUsage;hasHandledOrphanedPermission=!1;constructor(H){this.config=H,this.mutableMessages=H.initialMessages??[],this.abortController=H.abortController??cD(),this.permissionDenials=[],this.totalUsage=TC}async*submitMessage(H,$){let{cwd:A,commands:L,tools:I,mcpClients:D,verbose:B=!1,maxThinkingTokens:f,maxTurns:E,maxBudgetUsd:M,canUseTool:G,customSystemPrompt:U,appendSystemPrompt:X,userSpecifiedModel:J,fallbackModel:F,jsonSchema:Q,getAppState:W,setAppState:P,replayUserMessages:Y=!1,includePartialMessages:C=!1,agents:Z=[],setSDKStatus:q,orphanedPermission:O}=this.config;MY(A);let j=!yZ(),u=Date.now(),y=async(U$,hA,iA,rH,G$,b$)=>{let qA=await G(U$,hA,iA,rH,G$,b$);if(qA.behavior!=="allow")this.permissionDenials.push({tool_name:U$.name,tool_use_id:G$,tool_input:hA});return qA},g=await W(),v=J?t8(J):G1(),[p,d,k]=await Promise.all([tC(I,v,Array.from(g.toolPermissionContext.additionalWorkingDirectories.keys()),D),y5(),typeof U==="string"?Promise.resolve({}):R5()]),n={...d,...Gx1(D)},GH=[...typeof U==="string"?[U]:p,...X?[X]:[]],e=I.some((U$)=>U$.name===PK);if(Q&&e)KK$(P,j$());let BH={messages:this.mutableMessages,setMessages:()=>{},onChangeAPIKey:()=>{},options:{commands:L,debug:!1,tools:I,verbose:B,mainLoopModel:v,maxThinkingTokens:f??0,mcpClients:D,mcpResources:{},ideInstallationStatus:null,isNonInteractiveSession:!0,customSystemPrompt:U,appendSystemPrompt:X,agentDefinitions:{activeAgents:Z,allAgents:[]},theme:M$().theme,maxBudgetUsd:M},getAppState:W,setAppState:P,abortController:this.abortController,readFileState:g9H(this.mutableMessages,A),setInProgressToolUseIDs:()=>{},setResponseLength:()=>{},updateFileHistoryState:(U$)=>{P((hA)=>({...hA,fileHistory:U$(hA.fileHistory)}))},updateAttributionState:(U$)=>{P((hA)=>({...hA,attribution:U$(hA.attribution)}))},setSDKStatus:q};if(O&&!this.hasHandledOrphanedPermission){this.hasHandledOrphanedPermission=!0;for await(let U$ of ezD(O,I,this.mutableMessages,BH))yield U$}let{messages:VH,shouldQuery:wH,allowedTools:WH,maxThinkingTokens:qH,model:s,resultText:IH}=await rN$({input:H,mode:"prompt",setIsLoading:()=>{},setToolJSX:()=>{},context:{...BH,messages:this.mutableMessages},messages:this.mutableMessages,uuid:$?.uuid,querySource:"sdk"});this.mutableMessages.push(...VH);let FH=f??qH??0,EH=[...this.mutableMessages],YH=VH.filter((U$)=>U$.type==="user"&&!U$.isMeta&&!U$.toolUseResult||U$.type==="system"&&U$.subtype==="compact_boundary"),OH=Y?YH:[];P((U$)=>({...U$,toolPermissionContext:{...U$.toolPermissionContext,alwaysAllowRules:{...U$.toolPermissionContext.alwaysAllowRules,command:WH}}}));let HH=s??v,$H=g9H(EH,A),DH=qKH($H,BH.readFileState);BH={messages:EH,setMessages:()=>{},onChangeAPIKey:()=>{},options:{commands:L,debug:!1,tools:I,verbose:B,mainLoopModel:HH,maxThinkingTokens:FH,mcpClients:D,mcpResources:{},ideInstallationStatus:null,isNonInteractiveSession:!0,customSystemPrompt:U,appendSystemPrompt:X,theme:M$().theme,agentDefinitions:{activeAgents:Z,allAgents:[]},maxBudgetUsd:M},getAppState:W,setAppState:P,abortController:this.abortController,readFileState:DH,setInProgressToolUseIDs:()=>{},setResponseLength:()=>{},updateFileHistoryState:BH.updateFileHistoryState,updateAttributionState:BH.updateAttributionState,setSDKStatus:q};let AH=VL()?.outputStyle??aQ,[KH,{enabled:CH}]=await Promise.all([zJ$(Y$()),zf()]);if(yield{type:"system",subtype:"init",cwd:A,session_id:j$(),tools:I.map((U$)=>U$.name),mcp_servers:D.map((U$)=>({name:U$.name,status:U$.type})),model:HH,permissionMode:g.toolPermissionContext.mode,slash_commands:L.map((U$)=>U$.name),apiKeySource:V5().source,betas:J6(),claude_code_version:{ISSUES_EXPLAINER:"report the issue at https://github.com/anthropics/claude-code/issues",PACKAGE_URL:"@anthropic-ai/claude-code",README_URL:"https://code.claude.com/docs/en/overview",VERSION:"2.1.33",FEEDBACK_CHANNEL:"https://github.com/anthropics/claude-code/issues",BUILD_TIME:"2026-02-06T00:15:09Z"}.VERSION,output_style:AH,agents:Z.map((U$)=>U$.agentType),skills:KH.map((U$)=>U$.name),plugins:CH.map((U$)=>({name:U$.name,path:U$.path})),uuid:hd.randomUUID()},u9H("system_message_yielded"),!wH){for(let U$ of YH){if(U$.type==="user"&&typeof U$.message.content==="string"&&(U$.message.content.includes(`<${YMH}>`)||U$.message.content.includes(`<${eoH}>`)||U$.isCompactSummary))EH.push(U$),yield{type:"user",message:{...U$.message,content:HU(U$.message.content)},session_id:j$(),parent_tool_use_id:null,uuid:U$.uuid,isReplay:!U$.isCompactSummary};if(U$.type==="system"&&U$.subtype==="compact_boundary")EH.push(U$),yield{type:"system",subtype:"compact_boundary",session_id:j$(),uuid:U$.uuid,compact_metadata:{trigger:U$.compactMetadata.trigger,pre_tokens:U$.compactMetadata.preTokens}}}if(j){if(await cS(EH),A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}yield{type:"result",subtype:"success",is_error:!1,duration_ms:Date.now()-u,duration_api_ms:pY(),num_turns:EH.length-1,result:IH??"",stop_reason:null,session_id:j$(),total_cost_usd:$Q(),usage:TC,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID()};return}if(bE()&&j)VH.filter(CpH).forEach((U$)=>{J6H((hA)=>{P((iA)=>({...iA,fileHistory:hA(iA.fileHistory)}))},U$.uuid)});let yH=TC,gH=1,QH=!1,lH,hH=null,sH=Q?MbA(this.mutableMessages,PK):0;for await(let U$ of OP({messages:EH,systemPrompt:GH,userContext:n,systemContext:k,canUseTool:y,toolUseContext:BH,fallbackModel:F,querySource:"sdk",maxTurns:E})){if(U$.type==="assistant"||U$.type==="user"||U$.type==="system"&&U$.subtype==="compact_boundary"){if(EH.push(U$),j)await cS(EH);if(!QH&&OH.length>0){QH=!0;for(let hA of OH)if(hA.type==="user")yield{type:"user",message:hA.message,session_id:j$(),parent_tool_use_id:null,uuid:hA.uuid,isReplay:!0}}}if(U$.type==="user")gH++;switch(U$.type){case"tombstone":break;case"assistant":hH=U$.message.stop_reason,this.mutableMessages.push(U$),yield*$xA(U$);break;case"progress":case"user":this.mutableMessages.push(U$),yield*$xA(U$);break;case"stream_event":if(U$.event.type==="message_start")yH=TC,yH=O9H(yH,U$.event.message.usage);if(U$.event.type==="message_delta")yH=O9H(yH,U$.event.usage);if(U$.event.type==="message_stop")this.totalUsage=cY$(this.totalUsage,yH);if(C)yield{type:"stream_event",event:U$.event,session_id:j$(),parent_tool_use_id:null,uuid:hd.randomUUID()};break;case"attachment":if(this.mutableMessages.push(U$),U$.attachment.type==="structured_output")lH=U$.attachment.data;else if(U$.attachment.type==="max_turns_reached"){if(j){if(A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}yield{type:"result",subtype:"error_max_turns",duration_ms:Date.now()-u,duration_api_ms:pY(),is_error:!1,num_turns:U$.attachment.turnCount,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID(),errors:[]};return}else if(Y&&U$.attachment.type==="queued_command")yield{type:"user",message:{role:"user",content:U$.attachment.prompt},session_id:j$(),parent_tool_use_id:null,uuid:U$.attachment.source_uuid||U$.uuid,isReplay:!0};break;case"stream_request_start":break;case"system":if(this.mutableMessages.push(U$),U$.subtype==="compact_boundary"&&U$.compactMetadata)yield{type:"system",subtype:"compact_boundary",session_id:j$(),uuid:U$.uuid,compact_metadata:{trigger:U$.compactMetadata.trigger,pre_tokens:U$.compactMetadata.preTokens}};break;case"tool_use_summary":yield{type:"tool_use_summary",summary:U$.summary,preceding_tool_use_ids:U$.precedingToolUseIds,session_id:j$(),uuid:U$.uuid};break}if(M!==void 0&&$Q()>=M){if(j){if(A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}yield{type:"result",subtype:"error_max_budget_usd",duration_ms:Date.now()-u,duration_api_ms:pY(),is_error:!1,num_turns:gH,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID(),errors:[]};return}if(U$.type==="user"&&Q){let iA=MbA(this.mutableMessages,PK)-sH,rH=parseInt(process.env.MAX_STRUCTURED_OUTPUT_RETRIES||"5",10);if(iA>=rH){if(j){if(A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}yield{type:"result",subtype:"error_max_structured_output_retries",duration_ms:Date.now()-u,duration_api_ms:pY(),is_error:!0,num_turns:gH,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID(),errors:[`Failed to provide valid structured output after ${rH} attempts`]};return}}}let F$=K6(EH);if(j){if(A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}if(!szD(F$)){yield{type:"result",subtype:"error_during_execution",duration_ms:Date.now()-u,duration_api_ms:pY(),is_error:!1,num_turns:gH,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID(),errors:TMH().map((U$)=>U$.error)};return}let KA="",UA=!1;if(F$.type==="assistant"){let U$=K6(F$.message.content);if(U$?.type==="text")KA=U$.text;UA=Boolean(F$.isApiErrorMessage)}yield{type:"result",subtype:"success",is_error:UA,duration_ms:Date.now()-u,duration_api_ms:pY(),num_turns:gH,result:KA,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,structured_output:lH,uuid:hd.randomUUID()}}interrupt(){this.abortController.abort()}getMessages(){return this.mutableMessages}getSessionId(){return j$()}setModel(H){this.config.userSpecifiedModel=H}}async function*GEB({commands:H,prompt:$,promptUuid:A,cwd:L,tools:I,mcpClients:D,verbose:B=!1,maxThinkingTokens:f,maxTurns:E,maxBudgetUsd:M,canUseTool:G,mutableMessages:U=[],customSystemPrompt:X,appendSystemPrompt:J,userSpecifiedModel:F,fallbackModel:Q,jsonSchema:W,getAppState:P,setAppState:Y,abortController:C,replayUserMessages:Z=!1,includePartialMessages:q=!1,agents:O=[],setSDKStatus:j,orphanedPermission:u}){yield*new MEB({cwd:L,tools:I,commands:H,mcpClients:D,agents:O,canUseTool:G,getAppState:P,setAppState:Y,initialMessages:U,customSystemPrompt:X,appendSystemPrompt:J,userSpecifiedModel:F,fallbackModel:Q,maxThinkingTokens:f,maxTurns:E,maxBudgetUsd:M,jsonSchema:W,verbose:B,replayUserMessages:Z,includePartialMessages:q,setSDKStatus:j,abortController:C,orphanedPermission:u}).submitMessage($,{uuid:A})}var hd,Gx1=()=>({});var UEB=K(()=>{_HH();i6();R4();VI();qw();ST();Yq();N9H();Q7();rh();nB();NA();_L();zv();yuA();p$();iI();QK$();Nq();DE();fI();huH();QyH();mU();vA();aE();wh();mL();WX();_$();sC();nz$();c2$();hd=require("crypto")});var XEB=K(()=>{E$()});var JEB=K(()=>{_$();FgA();VI();XEB();z$();tr()});function FEB(H){let $=process.env.CLAUDE_CODE_EXIT_AFTER_STOP_DELAY,A=$?parseInt($,10):null,L=A&&!isNaN(A)&&A>0,I=null,D=0;return{start(){if(I)clearTimeout(I),I=null;if(L)D=Date.now(),I=setTimeout(()=>{let B=Date.now()-D;if(H()&&B>=A)N(`Exiting after ${A}ms of idle time`),$9()},A)},stop(){if(I)clearTimeout(I),I=null}}}var KEB=K(()=>{E$();MU()});function QEB(H){try{let $=new URL(H);return{sessionId:SgA.randomUUID(),ingressUrl:$.href,isUrl:!0,jsonlFile:null,isJsonlFile:!1}}catch{if(Iw(H))return{sessionId:H,ingressUrl:null,isUrl:!1,jsonlFile:null,isJsonlFile:!1};if(H.endsWith(".jsonl"))return{sessionId:SgA.randomUUID(),ingressUrl:null,isUrl:!1,jsonlFile:H,isJsonlFile:!0}}return null}var SgA;var WEB=K(()=>{vx();SgA=require("crypto")});async function VEB(){N("installPluginsForHeadless: starting");try{let[,H,$,A]=await Promise.all([IO$(),yq$(),wVH(),qVH()]),L=[];if(H.size>0){let M=await vq$(H);for(let G of M){let U=H.get(G);if(!U)continue;try{await vw(U.source),L.push(G),N(`installPluginsForHeadless: installed extra marketplace ${G}`)}catch(X){r(X instanceof Error?X:Error(String(X))),N(`installPluginsForHeadless: failed to install extra marketplace ${G}`)}}if(L.length>0)q3H(),wx()}let I=await d1(),D=$.filter((M)=>!A.includes(M)),B=[],f=[];for(let M of D){let[,G]=M.split("@");if(!G||G in I)B.push(M);else f.push(M)}if(f.length>0)N(`installPluginsForHeadless: skipping ${f.length} plugins from unknown marketplaces: ${f.join(", ")}`);if(B.length===0)return N("installPluginsForHeadless: no plugins to install"),!1;let E=await hq$(B,()=>{});if(E.installed.length>0)wx();return N(`installPluginsForHeadless: ${E.installed.length} installed, ${E.failed.length} failed`),E.installed.length>0}catch(H){return r(H instanceof Error?H:Error(String(H))),!1}}var PEB=K(()=>{cuA();TVH();mRA();S4();kq$();WX();E$();_$()});async function YEB(H,$,A,L,I,D,B,f){if(sJ.subscribe((q)=>{ZZ$(q,A)}),ROA(),await RQH())await $cD();if(kL.isSandboxingEnabled())try{await kL.initialize()}catch(q){process.stderr.write(`
4a5dc55d data: {"type":"message_start","message":{"model":"claude-haiku-4-5-20251001","id":"msg_017QL8t8PK788xvwrQRNtBXi","type":"message","role":"assistant","content":[],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":363,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}}       }
34f3243ac data: {"type":"message_start","message":{"model":"claude-haiku-4-5-20251001","id":"msg_017QL8t8PK788xvwrQRNtBXi","type":"message","role":"assistant","content":[],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":363,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}}       }Z
382aec66c Stream completed without receiving message_start event - triggering non-streaming fallback
382b605ec Stream completed with message_start but no content blocks completed - triggering non-streaming fallback
3b1583f4c `),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],I}if(this.chunks.push(H),H.startsWith(":"))return null;let[$,A,L]=uw0(H,":");if(L.startsWith(" "))L=L.substring(1);if($==="event")this.event=L;else if($==="data")this.data.push(L);return null}}function uw0(H,$){let A=H.indexOf($);if(A!==-1)return[H.substring(0,A),$,H.substring(A+$.length)];return[H,"",""]}var HTH,zV;var WLA=K(()=>{Uu();TV();KLA();ZAH();TB$();TV();zV=class zV{constructor(H,$,A){this.iterator=H,HTH.set(this,void 0),this.controller=$,ED(this,HTH,A,"f")}static fromSSEResponse(H,$,A){let L=!1,I=A?JQ(A):console;async function*D(){if(L)throw new LD("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");L=!0;let B=!1;try{for await(let f of bw0(H,$)){if(f.event==="completion")try{yield JSON.parse(f.data)}catch(E){throw I.error("Could not parse message into JSON:",f.data),I.error("From chunk:",f.raw),E}if(f.event==="message_start"||f.event==="message_delta"||f.event==="message_stop"||f.event==="content_block_start"||f.event==="content_block_delta"||f.event==="content_block_stop")try{yield JSON.parse(f.data)}catch(E){throw I.error("Could not parse message into JSON:",f.data),I.error("From chunk:",f.raw),E}if(f.event==="ping")continue;if(f.event==="error")throw new KD(void 0,YB$(f.data)??f.data,void 0,H.headers)}B=!0}catch(f){if(Xu(f))return;throw f}finally{if(!B)$.abort()}}return new zV(D,$,A)}static fromReadableStream(H,$,A){let L=!1;async function*I(){let B=new yi,f=tqH(H);for await(let E of f)for(let M of B.decode(E))yield M;for(let E of B.flush())yield E}async function*D(){if(L)throw new LD("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");L=!0;let B=!1;try{for await(let f of I()){if(B)continue;if(f)yield JSON.parse(f)}B=!0}catch(f){if(Xu(f))return;throw f}finally{if(!B)$.abort()}}return new zV(D,$,A)}[(HTH=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let H=[],$=[],A=this.iterator(),L=(I)=>{return{next:()=>{if(I.length===0){let D=A.next();H.push(D),$.push(D)}return I.shift()}}};return[new zV(()=>L(H),this.controller,xA(this,HTH,"f")),new zV(()=>L($),this.controller,xA(this,HTH,"f"))]}toReadableStream(){let H=this,$;return JLA({async start(){$=H[Symbol.asyncIterator]()},async pull(A){try{let{value:L,done:I}=await $.next();if(I)return A.close();let D=sqH(JSON.stringify(L)+`
3b1586c5a ${U}`)}return B},_4;var vi=K(()=>{TV();wcL=Object.freeze(Object.create(null)),_4=aw0(ZcL)});var ITH;var TLA=K(()=>{rR();Qq();B4H();vi();ITH=class ITH extends _5{list(H={},$){let{betas:A,...L}=H??{};return this._client.getAPIList("/v1/files",sN,{query:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"files-api-2025-04-14"].toString()},$?.headers])})}delete(H,$={},A){let{betas:L}=$??{};return this._client.delete(_4`/v1/files/${H}`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"files-api-2025-04-14"].toString()},A?.headers])})}download(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/files/${H}/content`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"files-api-2025-04-14"].toString(),Accept:"application/binary"},A?.headers]),__binaryResponse:!0})}retrieveMetadata(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/files/${H}`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"files-api-2025-04-14"].toString()},A?.headers])})}upload(H,$){let{betas:A,...L}=H;return this._client.post("/v1/files",D4H({body:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"files-api-2025-04-14"].toString()},$?.headers])},this._client))}}});var DTH;var zLA=K(()=>{rR();Qq();vi();DTH=class DTH extends _5{retrieve(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/models/${H}?beta=true`,{...A,headers:Z9([{...L?.toString()!=null?{"anthropic-beta":L?.toString()}:void 0},A?.headers])})}list(H={},$){let{betas:A,...L}=H??{};return this._client.getAPIList("/v1/models?beta=true",sN,{query:L,...$,headers:Z9([{...A?.toString()!=null?{"anthropic-beta":A?.toString()}:void 0},$?.headers])})}}});var jB$;var NLA=K(()=>{jB$={"claude-opus-4-20250514":8192,"claude-opus-4-0":8192,"claude-4-opus-20250514":8192,"anthropic.claude-opus-4-20250514-v1:0":8192,"claude-opus-4@20250514":8192,"claude-opus-4-1-20250805":8192,"anthropic.claude-opus-4-1-20250805-v1:0":8192,"claude-opus-4-1@20250805":8192}});function OLA(H,$){if(!$||!("parse"in($.output_format??{})))return{...H,content:H.content.map((A)=>{if(A.type==="text")return{...A,parsed:null};return A}),parsed_output:null};return xLA(H,$)}function xLA(H,$){let A=null,L=H.content.map((I)=>{if(I.type==="text"){let D=sw0($,I.text);if(A===null)A=D;return{...I,parsed:D}}return I});return{...H,content:L,parsed_output:A}}function sw0(H,$){if(H.output_format?.type!=="json_schema")return null;try{if("parse"in H.output_format)return H.output_format.parse($);return JSON.parse($)}catch(A){throw new LD(`Failed to parse structured output: ${A}`)}}var SLA=K(()=>{TV()});var ew0=(H)=>{let $=0,A=[];while($<H.length){let L=H[$];if(L==="\\"){$++;continue}if(L==="{"){A.push({type:"brace",value:"{"}),$++;continue}if(L==="}"){A.push({type:"brace",value:"}"}),$++;continue}if(L==="["){A.push({type:"paren",value:"["}),$++;continue}if(L==="]"){A.push({type:"paren",value:"]"}),$++;continue}if(L===":"){A.push({type:"separator",value:":"}),$++;continue}if(L===","){A.push({type:"delimiter",value:","}),$++;continue}if(L==='"'){let f="",E=!1;L=H[++$];while(L!=='"'){if($===H.length){E=!0;break}if(L==="\\"){if($++,$===H.length){E=!0;break}f+=L+H[$],L=H[++$]}else f+=L,L=H[++$]}if(L=H[++$],!E)A.push({type:"string",value:f});continue}if(L&&/\s/.test(L)){$++;continue}let D=/[0-9]/;if(L&&D.test(L)||L==="-"||L==="."){let f="";if(L==="-")f+=L,L=H[++$];while(L&&D.test(L)||L===".")f+=L,L=H[++$];A.push({type:"number",value:f});continue}let B=/[a-z]/i;if(L&&B.test(L)){let f="";while(L&&B.test(L)){if($===H.length)break;f+=L,L=H[++$]}if(f=="true"||f=="false"||f==="null")A.push({type:"name",value:f});else{$++;continue}continue}$++}return A},f4H=(H)=>{if(H.length===0)return H;let $=H[H.length-1];switch($.type){case"separator":return H=H.slice(0,H.length-1),f4H(H);break;case"number":let A=$.value[$.value.length-1];if(A==="."||A==="-")return H=H.slice(0,H.length-1),f4H(H);case"string":let L=H[H.length-2];if(L?.type==="delimiter")return H=H.slice(0,H.length-1),f4H(H);else if(L?.type==="brace"&&L.value==="{")return H=H.slice(0,H.length-1),f4H(H);break;case"delimiter":return H=H.slice(0,H.length-1),f4H(H);break}return H},HZ0=(H)=>{let $=[];if(H.map((A)=>{if(A.type==="brace")if(A.value==="{")$.push("}");else $.splice($.lastIndexOf("}"),1);if(A.type==="paren")if(A.value==="[")$.push("]");else $.splice($.lastIndexOf("]"),1)}),$.length>0)$.reverse().map((A)=>{if(A==="}")H.push({type:"brace",value:"}"});else if(A==="]")H.push({type:"paren",value:"]"})});return H},$Z0=(H)=>{let $="";return H.map((A)=>{switch(A.type){case"string":$+='"'+A.value+'"';break;default:$+=A.value;break}}),$},RB$=(H)=>JSON.parse($Z0(HZ0(f4H(ew0(H)))));var jLA=()=>{};var zAH=K(()=>{TV()});var yB$=K(()=>{WLA()});function NcL(H){return H.type==="tool_use"||H.type==="server_tool_use"||H.type==="mcp_tool_use"}function OcL(H){}var Wq,hi,E4H,BTH,vB$,fTH,ETH,hB$,MTH,Fu,GTH,bB$,kB$,M4H,uB$,gB$,RLA,qcL,mB$,yLA,vLA,hLA,TcL,zcL="__json_buf",UTH;var xcL=K(()=>{Uu();jLA();zAH();yB$();SLA();UTH=class UTH{constructor(H){Wq.add(this),this.messages=[],this.receivedMessages=[],hi.set(this,void 0),E4H.set(this,null),this.controller=new AbortController,BTH.set(this,void 0),vB$.set(this,()=>{}),fTH.set(this,()=>{}),ETH.set(this,void 0),hB$.set(this,()=>{}),MTH.set(this,()=>{}),Fu.set(this,{}),GTH.set(this,!1),bB$.set(this,!1),kB$.set(this,!1),M4H.set(this,!1),uB$.set(this,void 0),gB$.set(this,void 0),mB$.set(this,($)=>{if(ED(this,bB$,!0,"f"),Xu($))$=new lf;if($ instanceof lf)return ED(this,kB$,!0,"f"),this._emit("abort",$);if($ instanceof LD)return this._emit("error",$);if($ instanceof Error){let A=new LD($.message);return A.cause=$,this._emit("error",A)}return this._emit("error",new LD(String($)))}),ED(this,BTH,new Promise(($,A)=>{ED(this,vB$,$,"f"),ED(this,fTH,A,"f")}),"f"),ED(this,ETH,new Promise(($,A)=>{ED(this,hB$,$,"f"),ED(this,MTH,A,"f")}),"f"),xA(this,BTH,"f").catch(()=>{}),xA(this,ETH,"f").catch(()=>{}),ED(this,E4H,H,"f")}get response(){return xA(this,uB$,"f")}get request_id(){return xA(this,gB$,"f")}async withResponse(){let H=await xA(this,BTH,"f");if(!H)throw Error("Could not resolve a `Response` object");return{data:this,response:H,request_id:H.headers.get("request-id")}}static fromReadableStream(H){let $=new UTH(null);return $._run(()=>$._fromReadableStream(H)),$}static createMessage(H,$,A){let L=new UTH($);for(let I of $.messages)L._addMessageParam(I);return ED(L,E4H,{...$,stream:!0},"f"),L._run(()=>L._createMessage(H,{...$,stream:!0},{...A,headers:{...A?.headers,"X-Stainless-Helper-Method":"stream"}})),L}_run(H){H().then(()=>{this._emitFinal(),this._emit("end")},xA(this,mB$,"f"))}_addMessageParam(H){this.messages.push(H)}_addMessage(H,$=!0){if(this.receivedMessages.push(H),$)this._emit("message",H)}async _createMessage(H,$,A){let L=A?.signal,I;if(L){if(L.aborted)this.controller.abort();I=this.controller.abort.bind(this.controller),L.addEventListener("abort",I)}try{xA(this,Wq,"m",yLA).call(this);let{response:D,data:B}=await H.create({...$,stream:!0},{...A,signal:this.controller.signal}).withResponse();this._connected(D);for await(let f of B)xA(this,Wq,"m",vLA).call(this,f);if(B.controller.signal?.aborted)throw new lf;xA(this,Wq,"m",hLA).call(this)}finally{if(L&&I)L.removeEventListener("abort",I)}}_connected(H){if(this.ended)return;ED(this,uB$,H,"f"),ED(this,gB$,H?.headers.get("request-id"),"f"),xA(this,vB$,"f").call(this,H),this._emit("connect")}get ended(){return xA(this,GTH,"f")}get errored(){return xA(this,bB$,"f")}get aborted(){return xA(this,kB$,"f")}abort(){this.controller.abort()}on(H,$){return(xA(this,Fu,"f")[H]||(xA(this,Fu,"f")[H]=[])).push({listener:$}),this}off(H,$){let A=xA(this,Fu,"f")[H];if(!A)return this;let L=A.findIndex((I)=>I.listener===$);if(L>=0)A.splice(L,1);return this}once(H,$){return(xA(this,Fu,"f")[H]||(xA(this,Fu,"f")[H]=[])).push({listener:$,once:!0}),this}emitted(H){return new Promise(($,A)=>{if(ED(this,M4H,!0,"f"),H!=="error")this.once("error",A);this.once(H,$)})}async done(){ED(this,M4H,!0,"f"),await xA(this,ETH,"f")}get currentMessage(){return xA(this,hi,"f")}async finalMessage(){return await this.done(),xA(this,Wq,"m",RLA).call(this)}async finalText(){return await this.done(),xA(this,Wq,"m",qcL).call(this)}_emit(H,...$){if(xA(this,GTH,"f"))return;if(H==="end")ED(this,GTH,!0,"f"),xA(this,hB$,"f").call(this);let A=xA(this,Fu,"f")[H];if(A)xA(this,Fu,"f")[H]=A.filter((L)=>!L.once),A.forEach(({listener:L})=>L(...$));if(H==="abort"){let L=$[0];if(!xA(this,M4H,"f")&&!A?.length)Promise.reject(L);xA(this,fTH,"f").call(this,L),xA(this,MTH,"f").call(this,L),this._emit("end");return}if(H==="error"){let L=$[0];if(!xA(this,M4H,"f")&&!A?.length)Promise.reject(L);xA(this,fTH,"f").call(this,L),xA(this,MTH,"f").call(this,L),this._emit("end")}}_emitFinal(){if(this.receivedMessages.at(-1))this._emit("finalMessage",xA(this,Wq,"m",RLA).call(this))}async _fromReadableStream(H,$){let A=$?.signal,L;if(A){if(A.aborted)this.controller.abort();L=this.controller.abort.bind(this.controller),A.addEventListener("abort",L)}try{xA(this,Wq,"m",yLA).call(this),this._connected(null);let I=zV.fromReadableStream(H,this.controller);for await(let D of I)xA(this,Wq,"m",vLA).call(this,D);if(I.controller.signal?.aborted)throw new lf;xA(this,Wq,"m",hLA).call(this)}finally{if(A&&L)A.removeEventListener("abort",L)}}[(hi=new WeakMap,E4H=new WeakMap,BTH=new WeakMap,vB$=new WeakMap,fTH=new WeakMap,ETH=new WeakMap,hB$=new WeakMap,MTH=new WeakMap,Fu=new WeakMap,GTH=new WeakMap,bB$=new WeakMap,kB$=new WeakMap,M4H=new WeakMap,uB$=new WeakMap,gB$=new WeakMap,mB$=new WeakMap,Wq=new WeakSet,RLA=function(){if(this.receivedMessages.length===0)throw new LD("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},qcL=function(){if(this.receivedMessages.length===0)throw new LD("stream ended without producing a Message with role=assistant");let $=this.receivedMessages.at(-1).content.filter((A)=>A.type==="text").map((A)=>A.text);if($.length===0)throw new LD("stream ended without producing a content block with type=text");return $.join(" ")},yLA=function(){if(this.ended)return;ED(this,hi,void 0,"f")},vLA=function($){if(this.ended)return;let A=xA(this,Wq,"m",TcL).call(this,$);switch(this._emit("streamEvent",$,A),$.type){case"content_block_delta":{let L=A.content.at(-1);switch($.delta.type){case"text_delta":{if(L.type==="text")this._emit("text",$.delta.text,L.text||"");break}case"citations_delta":{if(L.type==="text")this._emit("citation",$.delta.citation,L.citations??[]);break}case"input_json_delta":{if(NcL(L)&&L.input)this._emit("inputJson",$.delta.partial_json,L.input);break}case"thinking_delta":{if(L.type==="thinking")this._emit("thinking",$.delta.thinking,L.thinking);break}case"signature_delta":{if(L.type==="thinking")this._emit("signature",L.signature);break}default:OcL($.delta)}break}case"message_stop":{this._addMessageParam(A),this._addMessage(OLA(A,xA(this,E4H,"f")),!0);break}case"content_block_stop":{this._emit("contentBlock",A.content.at(-1));break}case"message_start":{ED(this,hi,A,"f");break}case"content_block_start":case"message_delta":break}},hLA=function(){if(this.ended)throw new LD("stream has ended, this shouldn't happen");let $=xA(this,hi,"f");if(!$)throw new LD("request ended without sending any chunks");return ED(this,hi,void 0,"f"),OLA($,xA(this,E4H,"f"))},TcL=function($){let A=xA(this,hi,"f");if($.type==="message_start"){if(A)throw new LD(`Unexpected event order, got ${$.type} before receiving "message_stop"`);return $.message}if(!A)throw new LD(`Unexpected event order, got ${$.type} before "message_start"`);switch($.type){case"message_stop":return A;case"message_delta":if(A.container=$.delta.container,A.stop_reason=$.delta.stop_reason,A.stop_sequence=$.delta.stop_sequence,A.usage.output_tokens=$.usage.output_tokens,A.context_management=$.context_management,$.usage.input_tokens!=null)A.usage.input_tokens=$.usage.input_tokens;if($.usage.cache_creation_input_tokens!=null)A.usage.cache_creation_input_tokens=$.usage.cache_creation_input_tokens;if($.usage.cache_read_input_tokens!=null)A.usage.cache_read_input_tokens=$.usage.cache_read_input_tokens;if($.usage.server_tool_use!=null)A.usage.server_tool_use=$.usage.server_tool_use;return A;case"content_block_start":return A.content.push($.content_block),A;case"content_block_delta":{let L=A.content.at($.index);switch($.delta.type){case"text_delta":{if(L?.type==="text")A.content[$.index]={...L,text:(L.text||"")+$.delta.text};break}case"citations_delta":{if(L?.type==="text")A.content[$.index]={...L,citations:[...L.citations??[],$.delta.citation]};break}case"input_json_delta":{if(L&&NcL(L)){let I=L[zcL]||"";I+=$.delta.partial_json;let D={...L};if(Object.defineProperty(D,zcL,{value:I,enumerable:!1,writable:!0}),I)try{D.input=RB$(I)}catch(B){let f=new LD(`Unable to parse tool parameter JSON from model. Please retry your request or adjust your prompt. Error: ${B}. JSON: ${I}`);xA(this,mB$,"f").call(this,f)}A.content[$.index]=D}break}case"thinking_delta":{if(L?.type==="thinking")A.content[$.index]={...L,thinking:L.thinking+$.delta.thinking};break}case"signature_delta":{if(L?.type==="thinking")A.content[$.index]={...L,signature:$.delta.signature};break}default:OcL($.delta)}return A}case"content_block_stop":return A}},Symbol.asyncIterator)](){let H=[],$=[],A=!1;return this.on("streamEvent",(L)=>{let I=$.shift();if(I)I.resolve(L);else H.push(L)}),this.on("end",()=>{A=!0;for(let L of $)L.resolve(void 0);$.length=0}),this.on("abort",(L)=>{A=!0;for(let I of $)I.reject(L);$.length=0}),this.on("error",(L)=>{A=!0;for(let I of $)I.reject(L);$.length=0}),{next:async()=>{if(!H.length){if(A)return{value:void 0,done:!0};return new Promise((I,D)=>$.push({resolve:I,reject:D})).then((I)=>I?{value:I,done:!1}:{value:void 0,done:!0})}return{value:H.shift(),done:!1}},return:async()=>{return this.abort(),{value:void 0,done:!0}}}}toReadableStream(){return new zV(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}});function ScL(){let H,$;return{promise:new Promise((L,I)=>{H=L,$=I}),resolve:H,reject:$}}async function AZ0(H,$=H.messages.at(-1)){if(!$||$.role!=="assistant"||!$.content||typeof $.content==="string")return null;let A=$.content.filter((I)=>I.type==="tool_use");if(A.length===0)return null;return{role:"user",content:await Promise.all(A.map(async(I)=>{let D=H.tools.find((B)=>B.name===I.name);if(!D||!("run"in D))return{type:"tool_result",tool_use_id:I.id,content:`Error: Tool '${I.name}' not found`,is_error:!0};try{let B=I.input;if("parse"in D&&D.parse)B=D.parse(B);let f=await D.run(B);return{type:"tool_result",tool_use_id:I.id,content:f}}catch(B){return{type:"tool_result",tool_use_id:I.id,content:`Error: ${B instanceof Error?B.message:String(B)}`,is_error:!0}}}))}}var pB$,G4H,NAH,m_,XTH,eN,Ku,bi,JTH,bLA,FTH;var kLA=K(()=>{Uu();TV();Qq();FTH=class FTH{constructor(H,$,A){pB$.add(this),this.client=H,G4H.set(this,!1),NAH.set(this,!1),m_.set(this,void 0),XTH.set(this,void 0),eN.set(this,void 0),Ku.set(this,void 0),bi.set(this,void 0),JTH.set(this,0),ED(this,m_,{params:{...$,messages:structuredClone($.messages)}},"f"),ED(this,XTH,{...A,headers:Z9([{"x-stainless-helper":"BetaToolRunner"},A?.headers])},"f"),ED(this,bi,ScL(),"f")}async*[(G4H=new WeakMap,NAH=new WeakMap,m_=new WeakMap,XTH=new WeakMap,eN=new WeakMap,Ku=new WeakMap,bi=new WeakMap,JTH=new WeakMap,pB$=new WeakSet,Symbol.asyncIterator)](){var H;if(xA(this,G4H,"f"))throw new LD("Cannot iterate over a consumed stream");ED(this,G4H,!0,"f"),ED(this,NAH,!0,"f"),ED(this,Ku,void 0,"f");try{while(!0){let $;try{if(xA(this,m_,"f").params.max_iterations&&xA(this,JTH,"f")>=xA(this,m_,"f").params.max_iterations)break;ED(this,NAH,!1,"f"),ED(this,eN,void 0,"f"),ED(this,Ku,void 0,"f"),ED(this,JTH,(H=xA(this,JTH,"f"),H++,H),"f");let{max_iterations:A,...L}=xA(this,m_,"f").params;if(L.stream)$=this.client.beta.messages.stream({...L},xA(this,XTH,"f")),ED(this,eN,$.finalMessage(),"f"),xA(this,eN,"f").catch(()=>{}),yield $;else ED(this,eN,this.client.beta.messages.create({...L,stream:!1},xA(this,XTH,"f")),"f"),yield xA(this,eN,"f");if(!xA(this,NAH,"f")){let{role:D,content:B}=await xA(this,eN,"f");xA(this,m_,"f").params.messages.push({role:D,content:B})}let I=await xA(this,pB$,"m",bLA).call(this,xA(this,m_,"f").params.messages.at(-1));if(I)xA(this,m_,"f").params.messages.push(I);if(!I&&!xA(this,NAH,"f"))break}finally{if($)$.abort()}}if(!xA(this,eN,"f"))throw new LD("ToolRunner concluded without a message from the server");xA(this,bi,"f").resolve(await xA(this,eN,"f"))}catch($){throw ED(this,G4H,!1,"f"),xA(this,bi,"f").promise.catch(()=>{}),xA(this,bi,"f").reject($),ED(this,bi,ScL(),"f"),$}}setMessagesParams(H){if(typeof H==="function")xA(this,m_,"f").params=H(xA(this,m_,"f").params);else xA(this,m_,"f").params=H;ED(this,NAH,!0,"f"),ED(this,Ku,void 0,"f")}async generateToolResponse(){let H=await xA(this,eN,"f")??this.params.messages.at(-1);if(!H)return null;return xA(this,pB$,"m",bLA).call(this,H)}done(){return xA(this,bi,"f").promise}async runUntilDone(){if(!xA(this,G4H,"f"))for await(let H of this);return this.done()}get params(){return xA(this,m_,"f").params}pushMessages(...H){this.setMessagesParams(($)=>({...$,messages:[...$.messages,...H]}))}then(H,$){return this.runUntilDone().then(H,$)}};bLA=async function($){if(xA(this,Ku,"f")!==void 0)return xA(this,Ku,"f");return ED(this,Ku,AZ0(xA(this,m_,"f").params,$),"f"),xA(this,Ku,"f")}});var U4H;var uLA=K(()=>{TV();KLA();U4H=class U4H{constructor(H,$){this.iterator=H,this.controller=$}async*decoder(){let H=new yi;for await(let $ of this.iterator)for(let A of H.decode($))yield JSON.parse(A);for(let $ of H.flush())yield JSON.parse($)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(H,$){if(!H.body){if($.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative")throw new LD("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new LD("Attempted to iterate over a response with no body")}return new U4H(tqH(H.body),$)}}});var KTH;var gLA=K(()=>{rR();Qq();uLA();zAH();vi();KTH=class KTH extends _5{create(H,$){let{betas:A,...L}=H;return this._client.post("/v1/messages/batches?beta=true",{body:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"message-batches-2024-09-24"].toString()},$?.headers])})}retrieve(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/messages/batches/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"message-batches-2024-09-24"].toString()},A?.headers])})}list(H={},$){let{betas:A,...L}=H??{};return this._client.getAPIList("/v1/messages/batches?beta=true",sN,{query:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"message-batches-2024-09-24"].toString()},$?.headers])})}delete(H,$={},A){let{betas:L}=$??{};return this._client.delete(_4`/v1/messages/batches/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"message-batches-2024-09-24"].toString()},A?.headers])})}cancel(H,$={},A){let{betas:L}=$??{};return this._client.post(_4`/v1/messages/batches/${H}/cancel?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"message-batches-2024-09-24"].toString()},A?.headers])})}async results(H,$={},A){let L=await this.retrieve(H);if(!L.results_url)throw new LD(`No batch \`results_url\`; Has it finished processing? ${L.processing_status} - ${L.id}`);let{betas:I}=$??{};return this._client.get(L.results_url,{...A,headers:Z9([{"anthropic-beta":[...I??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary"},A?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((D,B)=>U4H.fromResponse(B.response,B.controller))}}});var jcL,OAH;var mLA=K(()=>{NLA();Qq();SLA();xcL();kLA();gLA();gLA();kLA();jcL={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-7-sonnet-latest":"February 19th, 2026","claude-3-7-sonnet-20250219":"February 19th, 2026"};OAH=class OAH extends _5{constructor(){super(...arguments);this.batches=new KTH(this._client)}create(H,$){let{betas:A,...L}=H;if(L.model in jcL)console.warn(`The model '${L.model}' is deprecated and will reach end-of-life on ${jcL[L.model]}
3b158bbcc Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let I=this._client._options.timeout;if(!L.stream&&I==null){let D=jB$[L.model]??void 0;I=this._client.calculateNonstreamingTimeout(L.max_tokens,D)}return this._client.post("/v1/messages?beta=true",{body:L,timeout:I??600000,...$,headers:Z9([{...A?.toString()!=null?{"anthropic-beta":A?.toString()}:void 0},$?.headers]),stream:H.stream??!1})}parse(H,$){return $={...$,headers:Z9([{"anthropic-beta":[...H.betas??[],"structured-outputs-2025-09-17"].toString()},$?.headers])},this.create(H,$).then((A)=>xLA(A,H))}stream(H,$){return UTH.createMessage(this,H,$)}countTokens(H,$){let{betas:A,...L}=H;return this._client.post("/v1/messages/count_tokens?beta=true",{body:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"token-counting-2024-11-01"].toString()},$?.headers])})}toolRunner(H,$){return new FTH(this._client,H,$)}};OAH.Batches=KTH;OAH.BetaToolRunner=FTH});var QTH;var pLA=K(()=>{rR();Qq();B4H();vi();QTH=class QTH extends _5{create(H,$={},A){let{betas:L,...I}=$??{};return this._client.post(_4`/v1/skills/${H}/versions?beta=true`,D4H({body:I,...A,headers:Z9([{"anthropic-beta":[...L??[],"skills-2025-10-02"].toString()},A?.headers])},this._client))}retrieve(H,$,A){let{skill_id:L,betas:I}=$;return this._client.get(_4`/v1/skills/${L}/versions/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...I??[],"skills-2025-10-02"].toString()},A?.headers])})}list(H,$={},A){let{betas:L,...I}=$??{};return this._client.getAPIList(_4`/v1/skills/${H}/versions?beta=true`,ATH,{query:I,...A,headers:Z9([{"anthropic-beta":[...L??[],"skills-2025-10-02"].toString()},A?.headers])})}delete(H,$,A){let{skill_id:L,betas:I}=$;return this._client.delete(_4`/v1/skills/${L}/versions/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...I??[],"skills-2025-10-02"].toString()},A?.headers])})}}});var X4H;var dLA=K(()=>{pLA();pLA();rR();Qq();B4H();vi();X4H=class X4H extends _5{constructor(){super(...arguments);this.versions=new QTH(this._client)}create(H={},$){let{betas:A,...L}=H??{};return this._client.post("/v1/skills?beta=true",D4H({body:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"skills-2025-10-02"].toString()},$?.headers])},this._client))}retrieve(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/skills/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"skills-2025-10-02"].toString()},A?.headers])})}list(H={},$){let{betas:A,...L}=H??{};return this._client.getAPIList("/v1/skills?beta=true",ATH,{query:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"skills-2025-10-02"].toString()},$?.headers])})}delete(H,$={},A){let{betas:L}=$??{};return this._client.delete(_4`/v1/skills/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"skills-2025-10-02"].toString()},A?.headers])})}};X4H.Versions=QTH});var y6;var cLA=K(()=>{TLA();TLA();zLA();zLA();mLA();mLA();dLA();dLA();y6=class y6 extends _5{constructor(){super(...arguments);this.models=new DTH(this._client),this.messages=new OAH(this._client),this.files=new ITH(this._client),this.skills=new X4H(this._client)}};y6.Models=DTH;y6.Messages=OAH;y6.Files=ITH;y6.Skills=X4H});var ki;var lLA=K(()=>{Qq();ki=class ki extends _5{create(H,$){let{betas:A,...L}=H;return this._client.post("/v1/complete",{body:L,timeout:this._client._options.timeout??600000,...$,headers:Z9([{...A?.toString()!=null?{"anthropic-beta":A?.toString()}:void 0},$?.headers]),stream:H.stream??!1})}}});function hcL(H){return H.type==="tool_use"||H.type==="server_tool_use"}function bcL(H){}var Vq,ui,WTH,dB$,VTH,PTH,cB$,_TH,Qu,CTH,lB$,iB$,J4H,nB$,rB$,iLA,RcL,nLA,rLA,aLA,oLA,ycL,vcL="__json_buf",YTH;var kcL=K(()=>{Uu();zAH();yB$();jLA();YTH=class YTH{constructor(){Vq.add(this),this.messages=[],this.receivedMessages=[],ui.set(this,void 0),this.controller=new AbortController,WTH.set(this,void 0),dB$.set(this,()=>{}),VTH.set(this,()=>{}),PTH.set(this,void 0),cB$.set(this,()=>{}),_TH.set(this,()=>{}),Qu.set(this,{}),CTH.set(this,!1),lB$.set(this,!1),iB$.set(this,!1),J4H.set(this,!1),nB$.set(this,void 0),rB$.set(this,void 0),nLA.set(this,(H)=>{if(ED(this,lB$,!0,"f"),Xu(H))H=new lf;if(H instanceof lf)return ED(this,iB$,!0,"f"),this._emit("abort",H);if(H instanceof LD)return this._emit("error",H);if(H instanceof Error){let $=new LD(H.message);return $.cause=H,this._emit("error",$)}return this._emit("error",new LD(String(H)))}),ED(this,WTH,new Promise((H,$)=>{ED(this,dB$,H,"f"),ED(this,VTH,$,"f")}),"f"),ED(this,PTH,new Promise((H,$)=>{ED(this,cB$,H,"f"),ED(this,_TH,$,"f")}),"f"),xA(this,WTH,"f").catch(()=>{}),xA(this,PTH,"f").catch(()=>{})}get response(){return xA(this,nB$,"f")}get request_id(){return xA(this,rB$,"f")}async withResponse(){let H=await xA(this,WTH,"f");if(!H)throw Error("Could not resolve a `Response` object");return{data:this,response:H,request_id:H.headers.get("request-id")}}static fromReadableStream(H){let $=new YTH;return $._run(()=>$._fromReadableStream(H)),$}static createMessage(H,$,A){let L=new YTH;for(let I of $.messages)L._addMessageParam(I);return L._run(()=>L._createMessage(H,{...$,stream:!0},{...A,headers:{...A?.headers,"X-Stainless-Helper-Method":"stream"}})),L}_run(H){H().then(()=>{this._emitFinal(),this._emit("end")},xA(this,nLA,"f"))}_addMessageParam(H){this.messages.push(H)}_addMessage(H,$=!0){if(this.receivedMessages.push(H),$)this._emit("message",H)}async _createMessage(H,$,A){let L=A?.signal,I;if(L){if(L.aborted)this.controller.abort();I=this.controller.abort.bind(this.controller),L.addEventListener("abort",I)}try{xA(this,Vq,"m",rLA).call(this);let{response:D,data:B}=await H.create({...$,stream:!0},{...A,signal:this.controller.signal}).withResponse();this._connected(D);for await(let f of B)xA(this,Vq,"m",aLA).call(this,f);if(B.controller.signal?.aborted)throw new lf;xA(this,Vq,"m",oLA).call(this)}finally{if(L&&I)L.removeEventListener("abort",I)}}_connected(H){if(this.ended)return;ED(this,nB$,H,"f"),ED(this,rB$,H?.headers.get("request-id"),"f"),xA(this,dB$,"f").call(this,H),this._emit("connect")}get ended(){return xA(this,CTH,"f")}get errored(){return xA(this,lB$,"f")}get aborted(){return xA(this,iB$,"f")}abort(){this.controller.abort()}on(H,$){return(xA(this,Qu,"f")[H]||(xA(this,Qu,"f")[H]=[])).push({listener:$}),this}off(H,$){let A=xA(this,Qu,"f")[H];if(!A)return this;let L=A.findIndex((I)=>I.listener===$);if(L>=0)A.splice(L,1);return this}once(H,$){return(xA(this,Qu,"f")[H]||(xA(this,Qu,"f")[H]=[])).push({listener:$,once:!0}),this}emitted(H){return new Promise(($,A)=>{if(ED(this,J4H,!0,"f"),H!=="error")this.once("error",A);this.once(H,$)})}async done(){ED(this,J4H,!0,"f"),await xA(this,PTH,"f")}get currentMessage(){return xA(this,ui,"f")}async finalMessage(){return await this.done(),xA(this,Vq,"m",iLA).call(this)}async finalText(){return await this.done(),xA(this,Vq,"m",RcL).call(this)}_emit(H,...$){if(xA(this,CTH,"f"))return;if(H==="end")ED(this,CTH,!0,"f"),xA(this,cB$,"f").call(this);let A=xA(this,Qu,"f")[H];if(A)xA(this,Qu,"f")[H]=A.filter((L)=>!L.once),A.forEach(({listener:L})=>L(...$));if(H==="abort"){let L=$[0];if(!xA(this,J4H,"f")&&!A?.length)Promise.reject(L);xA(this,VTH,"f").call(this,L),xA(this,_TH,"f").call(this,L),this._emit("end");return}if(H==="error"){let L=$[0];if(!xA(this,J4H,"f")&&!A?.length)Promise.reject(L);xA(this,VTH,"f").call(this,L),xA(this,_TH,"f").call(this,L),this._emit("end")}}_emitFinal(){if(this.receivedMessages.at(-1))this._emit("finalMessage",xA(this,Vq,"m",iLA).call(this))}async _fromReadableStream(H,$){let A=$?.signal,L;if(A){if(A.aborted)this.controller.abort();L=this.controller.abort.bind(this.controller),A.addEventListener("abort",L)}try{xA(this,Vq,"m",rLA).call(this),this._connected(null);let I=zV.fromReadableStream(H,this.controller);for await(let D of I)xA(this,Vq,"m",aLA).call(this,D);if(I.controller.signal?.aborted)throw new lf;xA(this,Vq,"m",oLA).call(this)}finally{if(A&&L)A.removeEventListener("abort",L)}}[(ui=new WeakMap,WTH=new WeakMap,dB$=new WeakMap,VTH=new WeakMap,PTH=new WeakMap,cB$=new WeakMap,_TH=new WeakMap,Qu=new WeakMap,CTH=new WeakMap,lB$=new WeakMap,iB$=new WeakMap,J4H=new WeakMap,nB$=new WeakMap,rB$=new WeakMap,nLA=new WeakMap,Vq=new WeakSet,iLA=function(){if(this.receivedMessages.length===0)throw new LD("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},RcL=function(){if(this.receivedMessages.length===0)throw new LD("stream ended without producing a Message with role=assistant");let $=this.receivedMessages.at(-1).content.filter((A)=>A.type==="text").map((A)=>A.text);if($.length===0)throw new LD("stream ended without producing a content block with type=text");return $.join(" ")},rLA=function(){if(this.ended)return;ED(this,ui,void 0,"f")},aLA=function($){if(this.ended)return;let A=xA(this,Vq,"m",ycL).call(this,$);switch(this._emit("streamEvent",$,A),$.type){case"content_block_delta":{let L=A.content.at(-1);switch($.delta.type){case"text_delta":{if(L.type==="text")this._emit("text",$.delta.text,L.text||"");break}case"citations_delta":{if(L.type==="text")this._emit("citation",$.delta.citation,L.citations??[]);break}case"input_json_delta":{if(hcL(L)&&L.input)this._emit("inputJson",$.delta.partial_json,L.input);break}case"thinking_delta":{if(L.type==="thinking")this._emit("thinking",$.delta.thinking,L.thinking);break}case"signature_delta":{if(L.type==="thinking")this._emit("signature",L.signature);break}default:bcL($.delta)}break}case"message_stop":{this._addMessageParam(A),this._addMessage(A,!0);break}case"content_block_stop":{this._emit("contentBlock",A.content.at(-1));break}case"message_start":{ED(this,ui,A,"f");break}case"content_block_start":case"message_delta":break}},oLA=function(){if(this.ended)throw new LD("stream has ended, this shouldn't happen");let $=xA(this,ui,"f");if(!$)throw new LD("request ended without sending any chunks");return ED(this,ui,void 0,"f"),$},ycL=function($){let A=xA(this,ui,"f");if($.type==="message_start"){if(A)throw new LD(`Unexpected event order, got ${$.type} before receiving "message_stop"`);return $.message}if(!A)throw new LD(`Unexpected event order, got ${$.type} before "message_start"`);switch($.type){case"message_stop":return A;case"message_delta":if(A.stop_reason=$.delta.stop_reason,A.stop_sequence=$.delta.stop_sequence,A.usage.output_tokens=$.usage.output_tokens,$.usage.input_tokens!=null)A.usage.input_tokens=$.usage.input_tokens;if($.usage.cache_creation_input_tokens!=null)A.usage.cache_creation_input_tokens=$.usage.cache_creation_input_tokens;if($.usage.cache_read_input_tokens!=null)A.usage.cache_read_input_tokens=$.usage.cache_read_input_tokens;if($.usage.server_tool_use!=null)A.usage.server_tool_use=$.usage.server_tool_use;return A;case"content_block_start":return A.content.push({...$.content_block}),A;case"content_block_delta":{let L=A.content.at($.index);switch($.delta.type){case"text_delta":{if(L?.type==="text")A.content[$.index]={...L,text:(L.text||"")+$.delta.text};break}case"citations_delta":{if(L?.type==="text")A.content[$.index]={...L,citations:[...L.citations??[],$.delta.citation]};break}case"input_json_delta":{if(L&&hcL(L)){let I=L[vcL]||"";I+=$.delta.partial_json;let D={...L};if(Object.defineProperty(D,vcL,{value:I,enumerable:!1,writable:!0}),I)D.input=RB$(I);A.content[$.index]=D}break}case"thinking_delta":{if(L?.type==="thinking")A.content[$.index]={...L,thinking:L.thinking+$.delta.thinking};break}case"signature_delta":{if(L?.type==="thinking")A.content[$.index]={...L,signature:$.delta.signature};break}default:bcL($.delta)}return A}case"content_block_stop":return A}},Symbol.asyncIterator)](){let H=[],$=[],A=!1;return this.on("streamEvent",(L)=>{let I=$.shift();if(I)I.resolve(L);else H.push(L)}),this.on("end",()=>{A=!0;for(let L of $)L.resolve(void 0);$.length=0}),this.on("abort",(L)=>{A=!0;for(let I of $)I.reject(L);$.length=0}),this.on("error",(L)=>{A=!0;for(let I of $)I.reject(L);$.length=0}),{next:async()=>{if(!H.length){if(A)return{value:void 0,done:!0};return new Promise((I,D)=>$.push({resolve:I,reject:D})).then((I)=>I?{value:I,done:!1}:{value:void 0,done:!0})}return{value:H.shift(),done:!1}},return:async()=>{return this.abort(),{value:void 0,done:!0}}}}toReadableStream(){return new zV(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}});var wTH;var tLA=K(()=>{rR();Qq();uLA();zAH();vi();wTH=class wTH extends _5{create(H,$){return this._client.post("/v1/messages/batches",{body:H,...$})}retrieve(H,$){return this._client.get(_4`/v1/messages/batches/${H}`,$)}list(H={},$){return this._client.getAPIList("/v1/messages/batches",sN,{query:H,...$})}delete(H,$){return this._client.delete(_4`/v1/messages/batches/${H}`,$)}cancel(H,$){return this._client.post(_4`/v1/messages/batches/${H}/cancel`,$)}async results(H,$){let A=await this.retrieve(H);if(!A.results_url)throw new LD(`No batch \`results_url\`; Has it finished processing? ${A.processing_status} - ${A.id}`);return this._client.get(A.results_url,{...$,headers:Z9([{Accept:"application/binary"},$?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((L,I)=>U4H.fromResponse(I.response,I.controller))}}});var w2,ucL;var sLA=K(()=>{kcL();tLA();tLA();NLA();w2=class w2 extends _5{constructor(){super(...arguments);this.batches=new wTH(this._client)}create(H,$){if(H.model in ucL)console.warn(`The model '${H.model}' is deprecated and will reach end-of-life on ${ucL[H.model]}
3b1c935d9 `),querySource:D.querySource,tools:vH(u)}:void 0,g=_vI(D.model,y,Y),v=Date.now(),p=Date.now(),d=0,k=void 0,n=void 0,GH=void 0,e=(HH)=>{let $H=[...f],DH=HD()==="bedrock"?[...ud$(HH.model),...G?[G]:[]]:[],MH=$X$(DH),AH={...MH.output_config??{}},KH=YyD()??D.effortValue??oaL(D.model);if(FY1(KH,AH,MH,$H,D.model),D.outputFormat&&!("format"in AH)){if(AH.format=D.outputFormat,!$H.includes(_c))$H.push(_c)}let CH=void 0;if(A!==0)if(YhI(D.model)){if(MH.thinking={type:"adaptive"},!$H.includes(BS$))$H.push(BS$);let lH=$H.indexOf(QlH);if(lH!==-1)$H.splice(lH,1)}else{let lH=A??PlH(D.model),hH=HH.maxTokensOverride||D.maxOutputTokensOverride;CH={budget_tokens:hH?Math.min(lH,hH-1):lH,type:"enabled"}}let TH=waL({hasThinking:A!==0}),yH=HH?.maxTokensOverride||D.maxOutputTokensOverride||Math.max((A??0)+1,zNA(D.model)),gH=D.enablePromptCaching??lrD(HH.model),QH=A!==0?void 0:D.temperatureOverride??1;return{model:zu(D.model),messages:VY1(Y,gH),system:O,tools:[...P,...D.extraToolSchemas??[]],tool_choice:D.toolChoice,...j?{betas:$H}:{},metadata:Kr(),max_tokens:yH,thinking:CH,...QH!==void 0&&{temperature:QH},...TH&&j&&$H.includes(WlH)?{context_management:TH}:{},...MH,...Object.keys(AH).length>0?{output_config:AH}:{}}};D.getToolPermissionContext().then((HH)=>{let $H=e({model:D.model,maxThinkingTokens:A}),MH=$H.output_config?.effort??"unset";WhI({model:D.model,messagesLength:$H.messages.length,temperature:D.temperatureOverride??1,betas:j?$H.betas??[]:[],permissionMode:HH.mode,querySource:D.querySource,queryTracking:D.queryTracking,effortValue:MH})});let BH=[],VH=0,wH=void 0,WH=[],qH=TC,s=0,IH=null,FH=!1,EH=0,YH=void 0,OH=void 0;try{W9("query_client_creation_start");let HH=KU$(()=>lO({maxRetries:0,model:D.model,fetchOverride:D.fetchOverride}),async(DH,MH,AH)=>{d=MH,p=Date.now();let KH=e(AH);LtH(KH,D.querySource),EH=KH.max_tokens;let CH=await DH.beta.messages.create({...KH,stream:!0},{signal:I}).withResponse();return n=CH.request_id,GH=CH.response,CH.data},{model:D.model,fallbackModel:D.fallbackModel,maxThinkingTokens:A,...!1,signal:I}),$H;do if($H=await HH.next(),!("controller"in $H.value))yield $H.value;while(!$H.done);if(k=$H.value,W9("query_client_creation_end"),BH.length=0,VH=0,wH=void 0,WH.length=0,qH=TC,IH=null,W9("query_api_request_sent"),!D.agentId)u9H("api_request_sent");try{let DH=!0,MH=null,AH=30000,KH=0,CH=0;for await(let yH of k){let gH=Date.now();if(MH!==null){let QH=gH-MH;if(QH>AH)CH++,KH+=QH,N(`Streaming stall detected: ${(QH/1000).toFixed(1)}s gap between events (stall #${CH})`,{level:"warn"}),c("tengu_streaming_stall",{stall_duration_ms:QH,stall_count:CH,total_stall_time_ms:KH,event_type:yH.type,model:D.model,request_id:n??"unknown"})}if(MH=gH,DH){if(N("Stream started - received first chunk"),W9("query_first_chunk_received"),!D.agentId)u9H("first_chunk");czD(),DH=!1}switch(yH.type){case"message_start":{wH=yH.message,VH=Date.now()-p,qH=O9H(qH,yH.message.usage);break}case"content_block_start":switch(yH.content_block.type){case"tool_use":WH[yH.index]={...yH.content_block,input:""};break;case"server_tool_use":WH[yH.index]={...yH.content_block,input:""};break;case"text":WH[yH.index]={...yH.content_block,text:""};break;case"thinking":WH[yH.index]={...yH.content_block,thinking:"",signature:""};break;default:WH[yH.index]={...yH.content_block};break}break;case"content_block_delta":{let QH=WH[yH.index];if(!QH)throw c("tengu_streaming_error",{error_type:"content_block_not_found_delta",part_type:yH.type,part_index:yH.index}),RangeError("Content block not found");switch(yH.delta.type){case"citations_delta":break;case"input_json_delta":if(QH.type!=="tool_use"&&QH.type!=="server_tool_use")throw c("tengu_streaming_error",{error_type:"content_block_type_mismatch_input_json",expected_type:"tool_use",actual_type:QH.type}),Error("Content block is not a input_json block");if(typeof QH.input!=="string")throw c("tengu_streaming_error",{error_type:"content_block_input_not_string",input_type:typeof QH.input}),Error("Content block input is not a string");QH.input+=yH.delta.partial_json;break;case"text_delta":if(QH.type!=="text")throw c("tengu_streaming_error",{error_type:"content_block_type_mismatch_text",expected_type:"text",actual_type:QH.type}),Error("Content block is not a text block");QH.text+=yH.delta.text;break;case"signature_delta":if(QH.type!=="thinking")throw c("tengu_streaming_error",{error_type:"content_block_type_mismatch_thinking_signature",expected_type:"thinking",actual_type:QH.type}),Error("Content block is not a thinking block");QH.signature=yH.delta.signature;break;case"thinking_delta":if(QH.type!=="thinking")throw c("tengu_streaming_error",{error_type:"content_block_type_mismatch_thinking_delta",expected_type:"thinking",actual_type:QH.type}),Error("Content block is not a thinking block");QH.thinking+=yH.delta.thinking;break}break}case"content_block_stop":{let QH=WH[yH.index];if(!QH)throw c("tengu_streaming_error",{error_type:"content_block_not_found_stop",part_type:yH.type,part_index:yH.index}),RangeError("Content block not found");if(!wH)throw c("tengu_streaming_error",{error_type:"partial_message_not_found",part_type:yH.type}),Error("Message not found");let lH={message:{...wH,content:Xz$([QH],L,D.agentId)},requestId:n??void 0,type:"assistant",uuid:Uz$.randomUUID(),timestamp:new Date().toISOString(),...{}};BH.push(lH),yield lH;break}case"message_delta":{qH=O9H(qH,yH.usage);let QH=BH[BH.length-1];if(QH)QH.message={...QH.message,usage:qH};IH=yH.delta.stop_reason;let lH=D9$(B,qH);$9$(lH,qH,D.model),s+=lH;let hH=y6I(yH.delta.stop_reason,D.model);if(hH)yield hH;if(IH==="max_tokens")c("tengu_max_tokens_reached",{max_tokens:EH}),yield Yf({content:`${z5}: Claude's response exceeded the ${EH} output token maximum. To configure this behavior, set the CLAUDE_CODE_MAX_OUTPUT_TOKENS environment variable.`,apiError:"max_output_tokens"});if(IH==="model_context_window_exceeded")c("tengu_context_window_exceeded",{max_tokens:EH,output_tokens:qH.output_tokens}),yield Yf({content:`${z5}: The model has reached its context window limit.`});break}case"message_stop":break}yield{type:"stream_event",event:yH}}if(!wH||BH.length===0&&!IH)throw N(!wH?"Stream completed without receiving message_start event - triggering non-streaming fallback":"Stream completed with message_start but no content blocks completed - triggering non-streaming fallback",{level:"error"}),c("tengu_stream_no_events",{model:D.model,request_id:n??"unknown"}),Error("Stream ended without receiving any events");if(CH>0)N(`Streaming completed with ${CH} stall(s), total stall time: ${(KH/1000).toFixed(1)}s`,{level:"warn"}),c("tengu_streaming_stall_summary",{stall_count:CH,total_stall_time_ms:KH,model:D.model,request_id:n??"unknown"});tvI(D.querySource,qH.cache_read_input_tokens,qH.cache_creation_input_tokens,H,D.agentId);let TH=GH;if(TH)kUA(TH.headers),YH=TH.headers}catch(DH){if(DH instanceof lf)if(I.aborted)throw N(`Streaming aborted by user: ${DH instanceof Error?DH.message:String(DH)}`),DH;else throw N(`Streaming timeout (SDK abort): ${DH.message}`,{level:"error"}),new nR({message:"Request timed out"});if(N(`Error streaming, falling back to non-streaming mode: ${DH instanceof Error?DH.message:String(DH)}`,{level:"error"}),FH=!0,D.onStreamingFallback)D.onStreamingFallback();c("tengu_streaming_fallback_to_non_streaming",{model:D.model,error:DH instanceof Error?DH.name:String(DH),attemptNumber:d,maxOutputTokens:EH,maxThinkingTokens:A});let MH=yield*irD({model:D.model},{model:D.model,maxThinkingTokens:A,...{},signal:I},e,(KH,CH,TH)=>{d=KH,EH=TH},(KH)=>LtH(KH,D.querySource)),AH={message:{...MH,content:Xz$(MH.content,L,D.agentId)},requestId:n??void 0,type:"assistant",uuid:Uz$.randomUUID(),timestamp:new Date().toISOString(),...{}};BH.push(AH),yield AH}}catch(HH){if(!FH&&HH instanceof my&&HH.originalError instanceof KD&&HH.originalError.status===404){if(N("Streaming endpoint returned 404, falling back to non-streaming mode",{level:"warn"}),FH=!0,D.onStreamingFallback)D.onStreamingFallback();c("tengu_streaming_fallback_to_non_streaming",{model:D.model,error:"404_stream_creation",attemptNumber:d,maxOutputTokens:EH,maxThinkingTokens:A});try{let DH=yield*irD({model:D.model},{model:D.model,maxThinkingTokens:A,...{},signal:I},e,(AH,KH,CH)=>{d=AH,EH=CH},(AH)=>LtH(AH,D.querySource)),MH={message:{...DH,content:Xz$(DH.content,L,D.agentId)},requestId:n??void 0,type:"assistant",uuid:Uz$.randomUUID(),timestamp:new Date().toISOString(),...{}};BH.push(MH),yield MH}catch(DH){N(`Non-streaming fallback also failed: ${DH instanceof Error?DH.message:String(DH)}`,{level:"error"});let MH=DH,AH=D.model;if(DH instanceof my)MH=DH.originalError,AH=DH.retryContext.model;if(MH instanceof KD)hG$(MH);let KH=n||(MH instanceof KD?MH.requestID:void 0)||(MH instanceof KD?MH.error?.request_id:void 0);if(O6A({error:MH,model:AH,messageCount:Y.length,messageTokens:VP(Y),durationMs:Date.now()-p,durationMsIncludingRetries:Date.now()-v,attempt:d,requestId:KH,didFallBackToNonStreaming:FH,queryTracking:D.queryTracking,querySource:D.querySource,llmSpan:g}),MH instanceof lf){$pH(k);return}yield XU$(MH,AH,{messages:H,messagesForAPI:Y}),$pH(k);return}}else{N(`Error in API request: ${HH instanceof Error?HH.message:String(HH)}`,{level:"error"});let DH=HH,MH=D.model;if(HH instanceof my)DH=HH.originalError,MH=HH.retryContext.model;if(DH instanceof KD)hG$(DH);let AH=n||(DH instanceof KD?DH.requestID:void 0)||(DH instanceof KD?DH.error?.request_id:void 0);if(O6A({error:DH,model:MH,messageCount:Y.length,messageTokens:VP(Y),durationMs:Date.now()-p,durationMsIncludingRetries:Date.now()-v,attempt:d,requestId:AH,didFallBackToNonStreaming:FH,queryTracking:D.queryTracking,querySource:D.querySource,llmSpan:g}),DH instanceof lf){$pH(k);return}yield XU$(DH,MH,{messages:H,messagesForAPI:Y}),$pH(k);return}}D.getToolPermissionContext().then((HH)=>{VhI({model:BH[0]?.message.model??wH?.model??D.model,preNormalizedModel:D.model,usage:qH,start:p,startIncludingRetries:v,attempt:d,messageCount:Y.length,messageTokens:VP(Y),requestId:n??null,stopReason:IH,ttftMs:VH,didFallBackToNonStreaming:FH,querySource:D.querySource,headers:YH,costUSD:s,queryTracking:D.queryTracking,permissionMode:HH.mode,newMessages:BH,llmSpan:g,globalCacheStrategy:W})}),$pH(k)}function $pH(H){if(!H)return;try{if(!H.controller.signal.aborted)H.controller.abort()}catch{}}function O9H(H,$){return{input_tokens:$.input_tokens!==null&&$.input_tokens>0?$.input_tokens:H.input_tokens,cache_creation_input_tokens:$.cache_creation_input_tokens!==null&&$.cache_creation_input_tokens>0?$.cache_creation_input_tokens:H.cache_creation_input_tokens,cache_read_input_tokens:$.cache_read_input_tokens!==null&&$.cache_read_input_tokens>0?$.cache_read_input_tokens:H.cache_read_input_tokens,output_tokens:$.output_tokens??H.output_tokens,server_tool_use:{web_search_requests:$.server_tool_use?.web_search_requests??H.server_tool_use.web_search_requests,web_fetch_requests:$.server_tool_use?.web_fetch_requests??H.server_tool_use.web_fetch_requests},service_tier:H.service_tier,cache_creation:{ephemeral_1h_input_tokens:$.cache_creation?.ephemeral_1h_input_tokens??H.cache_creation.ephemeral_1h_input_tokens,ephemeral_5m_input_tokens:$.cache_creation?.ephemeral_5m_input_tokens??H.cache_creation.ephemeral_5m_input_tokens}}}function cY$(H,$){return{input_tokens:H.input_tokens+$.input_tokens,cache_creation_input_tokens:H.cache_creation_input_tokens+$.cache_creation_input_tokens,cache_read_input_tokens:H.cache_read_input_tokens+$.cache_read_input_tokens,output_tokens:H.output_tokens+$.output_tokens,server_tool_use:{web_search_requests:H.server_tool_use.web_search_requests+$.server_tool_use.web_search_requests,web_fetch_requests:H.server_tool_use.web_fetch_requests+$.server_tool_use.web_fetch_requests},service_tier:$.service_tier,cache_creation:{ephemeral_1h_input_tokens:H.cache_creation.ephemeral_1h_input_tokens+$.cache_creation.ephemeral_1h_input_tokens,ephemeral_5m_input_tokens:H.cache_creation.ephemeral_5m_input_tokens+$.cache_creation.ephemeral_5m_input_tokens}}}function VY1(H,$){return c("tengu_api_cache_breakpoints",{totalMessageCount:H.length,cachingEnabled:$}),H.map((A,L)=>{return A.type==="user"?KY1(A,L>H.length-3,$):QY1(A,L>H.length-3,$)})}function PY1(H,$,A){return xOA(H,{skipGlobalCacheForSystemPrompt:A?.skipGlobalCacheForSystemPrompt}).map((L)=>{return{type:"text",text:L.text,...$&&L.cacheScope!==null?{cache_control:APH(L.cacheScope)}:{}}})}async function YQ({systemPrompt:H=[],userPrompt:$,outputFormat:A,signal:L,options:I}){return(await HX$([R$({content:H.map((B)=>({type:"text",text:B}))}),R$({content:$})],async()=>{let B=[R$({content:$})];return[await Qm({messages:B,systemPrompt:H,maxThinkingTokens:0,tools:[],signal:L,options:{...I,model:eX(),enablePromptCaching:I.enablePromptCaching??!1,outputFormat:A,async getToolPermissionContext(){return KK()}}})]}))[0]}async function fz$({systemPrompt:H=[],userPrompt:$,outputFormat:A,signal:L,options:I}){return(await HX$([R$({content:H.map((B)=>({type:"text",text:B}))}),R$({content:$})],async()=>{let B=[R$({content:$})];return[await Qm({messages:B,systemPrompt:H,maxThinkingTokens:0,tools:[],signal:L,options:{...I,enablePromptCaching:I.enablePromptCaching??!1,outputFormat:A,async getToolPermissionContext(){return KK()}}})]}))[0]}function CY1(H,$){let A=Math.min(H.max_tokens,$),L={...H};if(L.thinking?.type==="enabled"&&L.thinking.budget_tokens)L.thinking={...L.thinking,budget_tokens:Math.min(L.thinking.budget_tokens,A-1)};return{...L,max_tokens:A}}function zNA(H){let $=nfH(H),A=KlH.validate(process.env.CLAUDE_CODE_MAX_OUTPUT_TOKENS);if(A.status==="capped")N(`CLAUDE_CODE_MAX_OUTPUT_TOKENS ${A.message}`);else if(A.status==="invalid")N(`CLAUDE_CODE_MAX_OUTPUT_TOKENS ${A.message}`);return Math.min(A.effective,$)}var Uz$,_Y1=21333;var mU=K(()=>{ZaL();iI();V9$();yDA();qw();nt();oZ();vA();fI();NA();_$();_L();iI();rM();E3();mY();yy();jD();z$();cFA();dxH();QyH();oZH();lM();lIH();LHH();oZ();UT();ya();aS();yF();E$();FyH();Wt();Hq$();Cm();mY();G3H();huH();p$();zAH();gy();fI();MCH();iI();UBH();la();BzH();Yq();Z$();jD();i6();Uz$=require("crypto")});function ZY1(){return trD.randomBytes(8).toString("hex")}function TY1(H,$){let A=!1,L=!1;for(let I=0;I<$;I++){let D=H[I],B=0;for(let f=I-1;f>=0&&H[f]==="\\";f--)B++;if(B%2===1)continue;if(D==="'"&&!L)A=!A;else if(D==='"'&&!A)L=!L}return A||L}function zY1(H,$){let A=H.lastIndexOf(`
3b1d3cbd2 `)})()}}async write(H){await this.transport.write(H)}close(){this.transport.close(),this.inputStream.end()}}});var EEB=K(()=>{OV();ei();oG();DK()});class MEB{config;mutableMessages;abortController;permissionDenials;totalUsage;hasHandledOrphanedPermission=!1;constructor(H){this.config=H,this.mutableMessages=H.initialMessages??[],this.abortController=H.abortController??cD(),this.permissionDenials=[],this.totalUsage=TC}async*submitMessage(H,$){let{cwd:A,commands:L,tools:I,mcpClients:D,verbose:B=!1,maxThinkingTokens:f,maxTurns:E,maxBudgetUsd:M,canUseTool:G,customSystemPrompt:U,appendSystemPrompt:X,userSpecifiedModel:J,fallbackModel:F,jsonSchema:Q,getAppState:W,setAppState:P,replayUserMessages:Y=!1,includePartialMessages:C=!1,agents:Z=[],setSDKStatus:q,orphanedPermission:O}=this.config;MY(A);let j=!yZ(),u=Date.now(),y=async(U$,hA,iA,rH,G$,b$)=>{let qA=await G(U$,hA,iA,rH,G$,b$);if(qA.behavior!=="allow")this.permissionDenials.push({tool_name:U$.name,tool_use_id:G$,tool_input:hA});return qA},g=await W(),v=J?t8(J):G1(),[p,d,k]=await Promise.all([tC(I,v,Array.from(g.toolPermissionContext.additionalWorkingDirectories.keys()),D),y5(),typeof U==="string"?Promise.resolve({}):R5()]),n={...d,...Gx1(D)},GH=[...typeof U==="string"?[U]:p,...X?[X]:[]],e=I.some((U$)=>U$.name===PK);if(Q&&e)KK$(P,j$());let BH={messages:this.mutableMessages,setMessages:()=>{},onChangeAPIKey:()=>{},options:{commands:L,debug:!1,tools:I,verbose:B,mainLoopModel:v,maxThinkingTokens:f??0,mcpClients:D,mcpResources:{},ideInstallationStatus:null,isNonInteractiveSession:!0,customSystemPrompt:U,appendSystemPrompt:X,agentDefinitions:{activeAgents:Z,allAgents:[]},theme:M$().theme,maxBudgetUsd:M},getAppState:W,setAppState:P,abortController:this.abortController,readFileState:g9H(this.mutableMessages,A),setInProgressToolUseIDs:()=>{},setResponseLength:()=>{},updateFileHistoryState:(U$)=>{P((hA)=>({...hA,fileHistory:U$(hA.fileHistory)}))},updateAttributionState:(U$)=>{P((hA)=>({...hA,attribution:U$(hA.attribution)}))},setSDKStatus:q};if(O&&!this.hasHandledOrphanedPermission){this.hasHandledOrphanedPermission=!0;for await(let U$ of ezD(O,I,this.mutableMessages,BH))yield U$}let{messages:VH,shouldQuery:wH,allowedTools:WH,maxThinkingTokens:qH,model:s,resultText:IH}=await rN$({input:H,mode:"prompt",setIsLoading:()=>{},setToolJSX:()=>{},context:{...BH,messages:this.mutableMessages},messages:this.mutableMessages,uuid:$?.uuid,querySource:"sdk"});this.mutableMessages.push(...VH);let FH=f??qH??0,EH=[...this.mutableMessages],YH=VH.filter((U$)=>U$.type==="user"&&!U$.isMeta&&!U$.toolUseResult||U$.type==="system"&&U$.subtype==="compact_boundary"),OH=Y?YH:[];P((U$)=>({...U$,toolPermissionContext:{...U$.toolPermissionContext,alwaysAllowRules:{...U$.toolPermissionContext.alwaysAllowRules,command:WH}}}));let HH=s??v,$H=g9H(EH,A),DH=qKH($H,BH.readFileState);BH={messages:EH,setMessages:()=>{},onChangeAPIKey:()=>{},options:{commands:L,debug:!1,tools:I,verbose:B,mainLoopModel:HH,maxThinkingTokens:FH,mcpClients:D,mcpResources:{},ideInstallationStatus:null,isNonInteractiveSession:!0,customSystemPrompt:U,appendSystemPrompt:X,theme:M$().theme,agentDefinitions:{activeAgents:Z,allAgents:[]},maxBudgetUsd:M},getAppState:W,setAppState:P,abortController:this.abortController,readFileState:DH,setInProgressToolUseIDs:()=>{},setResponseLength:()=>{},updateFileHistoryState:BH.updateFileHistoryState,updateAttributionState:BH.updateAttributionState,setSDKStatus:q};let AH=VL()?.outputStyle??aQ,[KH,{enabled:CH}]=await Promise.all([zJ$(Y$()),zf()]);if(yield{type:"system",subtype:"init",cwd:A,session_id:j$(),tools:I.map((U$)=>U$.name),mcp_servers:D.map((U$)=>({name:U$.name,status:U$.type})),model:HH,permissionMode:g.toolPermissionContext.mode,slash_commands:L.map((U$)=>U$.name),apiKeySource:V5().source,betas:J6(),claude_code_version:{ISSUES_EXPLAINER:"report the issue at https://github.com/anthropics/claude-code/issues",PACKAGE_URL:"@anthropic-ai/claude-code",README_URL:"https://code.claude.com/docs/en/overview",VERSION:"2.1.33",FEEDBACK_CHANNEL:"https://github.com/anthropics/claude-code/issues",BUILD_TIME:"2026-02-06T00:15:09Z"}.VERSION,output_style:AH,agents:Z.map((U$)=>U$.agentType),skills:KH.map((U$)=>U$.name),plugins:CH.map((U$)=>({name:U$.name,path:U$.path})),uuid:hd.randomUUID()},u9H("system_message_yielded"),!wH){for(let U$ of YH){if(U$.type==="user"&&typeof U$.message.content==="string"&&(U$.message.content.includes(`<${YMH}>`)||U$.message.content.includes(`<${eoH}>`)||U$.isCompactSummary))EH.push(U$),yield{type:"user",message:{...U$.message,content:HU(U$.message.content)},session_id:j$(),parent_tool_use_id:null,uuid:U$.uuid,isReplay:!U$.isCompactSummary};if(U$.type==="system"&&U$.subtype==="compact_boundary")EH.push(U$),yield{type:"system",subtype:"compact_boundary",session_id:j$(),uuid:U$.uuid,compact_metadata:{trigger:U$.compactMetadata.trigger,pre_tokens:U$.compactMetadata.preTokens}}}if(j){if(await cS(EH),A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}yield{type:"result",subtype:"success",is_error:!1,duration_ms:Date.now()-u,duration_api_ms:pY(),num_turns:EH.length-1,result:IH??"",stop_reason:null,session_id:j$(),total_cost_usd:$Q(),usage:TC,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID()};return}if(bE()&&j)VH.filter(CpH).forEach((U$)=>{J6H((hA)=>{P((iA)=>({...iA,fileHistory:hA(iA.fileHistory)}))},U$.uuid)});let yH=TC,gH=1,QH=!1,lH,hH=null,sH=Q?MbA(this.mutableMessages,PK):0;for await(let U$ of OP({messages:EH,systemPrompt:GH,userContext:n,systemContext:k,canUseTool:y,toolUseContext:BH,fallbackModel:F,querySource:"sdk",maxTurns:E})){if(U$.type==="assistant"||U$.type==="user"||U$.type==="system"&&U$.subtype==="compact_boundary"){if(EH.push(U$),j)await cS(EH);if(!QH&&OH.length>0){QH=!0;for(let hA of OH)if(hA.type==="user")yield{type:"user",message:hA.message,session_id:j$(),parent_tool_use_id:null,uuid:hA.uuid,isReplay:!0}}}if(U$.type==="user")gH++;switch(U$.type){case"tombstone":break;case"assistant":hH=U$.message.stop_reason,this.mutableMessages.push(U$),yield*$xA(U$);break;case"progress":case"user":this.mutableMessages.push(U$),yield*$xA(U$);break;case"stream_event":if(U$.event.type==="message_start")yH=TC,yH=O9H(yH,U$.event.message.usage);if(U$.event.type==="message_delta")yH=O9H(yH,U$.event.usage);if(U$.event.type==="message_stop")this.totalUsage=cY$(this.totalUsage,yH);if(C)yield{type:"stream_event",event:U$.event,session_id:j$(),parent_tool_use_id:null,uuid:hd.randomUUID()};break;case"attachment":if(this.mutableMessages.push(U$),U$.attachment.type==="structured_output")lH=U$.attachment.data;else if(U$.attachment.type==="max_turns_reached"){if(j){if(A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}yield{type:"result",subtype:"error_max_turns",duration_ms:Date.now()-u,duration_api_ms:pY(),is_error:!1,num_turns:U$.attachment.turnCount,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID(),errors:[]};return}else if(Y&&U$.attachment.type==="queued_command")yield{type:"user",message:{role:"user",content:U$.attachment.prompt},session_id:j$(),parent_tool_use_id:null,uuid:U$.attachment.source_uuid||U$.uuid,isReplay:!0};break;case"stream_request_start":break;case"system":if(this.mutableMessages.push(U$),U$.subtype==="compact_boundary"&&U$.compactMetadata)yield{type:"system",subtype:"compact_boundary",session_id:j$(),uuid:U$.uuid,compact_metadata:{trigger:U$.compactMetadata.trigger,pre_tokens:U$.compactMetadata.preTokens}};break;case"tool_use_summary":yield{type:"tool_use_summary",summary:U$.summary,preceding_tool_use_ids:U$.precedingToolUseIds,session_id:j$(),uuid:U$.uuid};break}if(M!==void 0&&$Q()>=M){if(j){if(A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}yield{type:"result",subtype:"error_max_budget_usd",duration_ms:Date.now()-u,duration_api_ms:pY(),is_error:!1,num_turns:gH,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID(),errors:[]};return}if(U$.type==="user"&&Q){let iA=MbA(this.mutableMessages,PK)-sH,rH=parseInt(process.env.MAX_STRUCTURED_OUTPUT_RETRIES||"5",10);if(iA>=rH){if(j){if(A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}yield{type:"result",subtype:"error_max_structured_output_retries",duration_ms:Date.now()-u,duration_api_ms:pY(),is_error:!0,num_turns:gH,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID(),errors:[`Failed to provide valid structured output after ${rH} attempts`]};return}}}let F$=K6(EH);if(j){if(A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}if(!szD(F$)){yield{type:"result",subtype:"error_during_execution",duration_ms:Date.now()-u,duration_api_ms:pY(),is_error:!1,num_turns:gH,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID(),errors:TMH().map((U$)=>U$.error)};return}let KA="",UA=!1;if(F$.type==="assistant"){let U$=K6(F$.message.content);if(U$?.type==="text")KA=U$.text;UA=Boolean(F$.isApiErrorMessage)}yield{type:"result",subtype:"success",is_error:UA,duration_ms:Date.now()-u,duration_api_ms:pY(),num_turns:gH,result:KA,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,structured_output:lH,uuid:hd.randomUUID()}}interrupt(){this.abortController.abort()}getMessages(){return this.mutableMessages}getSessionId(){return j$()}setModel(H){this.config.userSpecifiedModel=H}}async function*GEB({commands:H,prompt:$,promptUuid:A,cwd:L,tools:I,mcpClients:D,verbose:B=!1,maxThinkingTokens:f,maxTurns:E,maxBudgetUsd:M,canUseTool:G,mutableMessages:U=[],customSystemPrompt:X,appendSystemPrompt:J,userSpecifiedModel:F,fallbackModel:Q,jsonSchema:W,getAppState:P,setAppState:Y,abortController:C,replayUserMessages:Z=!1,includePartialMessages:q=!1,agents:O=[],setSDKStatus:j,orphanedPermission:u}){yield*new MEB({cwd:L,tools:I,commands:H,mcpClients:D,agents:O,canUseTool:G,getAppState:P,setAppState:Y,initialMessages:U,customSystemPrompt:X,appendSystemPrompt:J,userSpecifiedModel:F,fallbackModel:Q,maxThinkingTokens:f,maxTurns:E,maxBudgetUsd:M,jsonSchema:W,verbose:B,replayUserMessages:Z,includePartialMessages:q,setSDKStatus:j,abortController:C,orphanedPermission:u}).submitMessage($,{uuid:A})}var hd,Gx1=()=>({});var UEB=K(()=>{_HH();i6();R4();VI();qw();ST();Yq();N9H();Q7();rh();nB();NA();_L();zv();yuA();p$();iI();QK$();Nq();DE();fI();huH();QyH();mU();vA();aE();wh();mL();WX();_$();sC();nz$();c2$();hd=require("crypto")});var XEB=K(()=>{E$()});var JEB=K(()=>{_$();FgA();VI();XEB();z$();tr()});function FEB(H){let $=process.env.CLAUDE_CODE_EXIT_AFTER_STOP_DELAY,A=$?parseInt($,10):null,L=A&&!isNaN(A)&&A>0,I=null,D=0;return{start(){if(I)clearTimeout(I),I=null;if(L)D=Date.now(),I=setTimeout(()=>{let B=Date.now()-D;if(H()&&B>=A)N(`Exiting after ${A}ms of idle time`),$9()},A)},stop(){if(I)clearTimeout(I),I=null}}}var KEB=K(()=>{E$();MU()});function QEB(H){try{let $=new URL(H);return{sessionId:SgA.randomUUID(),ingressUrl:$.href,isUrl:!0,jsonlFile:null,isJsonlFile:!1}}catch{if(Iw(H))return{sessionId:H,ingressUrl:null,isUrl:!1,jsonlFile:null,isJsonlFile:!1};if(H.endsWith(".jsonl"))return{sessionId:SgA.randomUUID(),ingressUrl:null,isUrl:!1,jsonlFile:H,isJsonlFile:!0}}return null}var SgA;var WEB=K(()=>{vx();SgA=require("crypto")});async function VEB(){N("installPluginsForHeadless: starting");try{let[,H,$,A]=await Promise.all([IO$(),yq$(),wVH(),qVH()]),L=[];if(H.size>0){let M=await vq$(H);for(let G of M){let U=H.get(G);if(!U)continue;try{await vw(U.source),L.push(G),N(`installPluginsForHeadless: installed extra marketplace ${G}`)}catch(X){r(X instanceof Error?X:Error(String(X))),N(`installPluginsForHeadless: failed to install extra marketplace ${G}`)}}if(L.length>0)q3H(),wx()}let I=await d1(),D=$.filter((M)=>!A.includes(M)),B=[],f=[];for(let M of D){let[,G]=M.split("@");if(!G||G in I)B.push(M);else f.push(M)}if(f.length>0)N(`installPluginsForHeadless: skipping ${f.length} plugins from unknown marketplaces: ${f.join(", ")}`);if(B.length===0)return N("installPluginsForHeadless: no plugins to install"),!1;let E=await hq$(B,()=>{});if(E.installed.length>0)wx();return N(`installPluginsForHeadless: ${E.installed.length} installed, ${E.failed.length} failed`),E.installed.length>0}catch(H){return r(H instanceof Error?H:Error(String(H))),!1}}var PEB=K(()=>{cuA();TVH();mRA();S4();kq$();WX();E$();_$()});async function YEB(H,$,A,L,I,D,B,f){if(sJ.subscribe((q)=>{ZZ$(q,A)}),ROA(),await RQH())await $cD();if(kL.isSandboxingEnabled())try{await kL.initialize()}catch(q){process.stderr.write(`
3b1fe4f4c `),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],I}if(this.chunks.push(H),H.startsWith(":"))return null;let[$,A,L]=uw0(H,":");if(L.startsWith(" "))L=L.substring(1);if($==="event")this.event=L;else if($==="data")this.data.push(L);return null}}function uw0(H,$){let A=H.indexOf($);if(A!==-1)return[H.substring(0,A),$,H.substring(A+$.length)];return[H,"",""]}var HTH,zV;var WLA=K(()=>{Uu();TV();KLA();ZAH();TB$();TV();zV=class zV{constructor(H,$,A){this.iterator=H,HTH.set(this,void 0),this.controller=$,ED(this,HTH,A,"f")}static fromSSEResponse(H,$,A){let L=!1,I=A?JQ(A):console;async function*D(){if(L)throw new LD("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");L=!0;let B=!1;try{for await(let f of bw0(H,$)){if(f.event==="completion")try{yield JSON.parse(f.data)}catch(E){throw I.error("Could not parse message into JSON:",f.data),I.error("From chunk:",f.raw),E}if(f.event==="message_start"||f.event==="message_delta"||f.event==="message_stop"||f.event==="content_block_start"||f.event==="content_block_delta"||f.event==="content_block_stop")try{yield JSON.parse(f.data)}catch(E){throw I.error("Could not parse message into JSON:",f.data),I.error("From chunk:",f.raw),E}if(f.event==="ping")continue;if(f.event==="error")throw new KD(void 0,YB$(f.data)??f.data,void 0,H.headers)}B=!0}catch(f){if(Xu(f))return;throw f}finally{if(!B)$.abort()}}return new zV(D,$,A)}static fromReadableStream(H,$,A){let L=!1;async function*I(){let B=new yi,f=tqH(H);for await(let E of f)for(let M of B.decode(E))yield M;for(let E of B.flush())yield E}async function*D(){if(L)throw new LD("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");L=!0;let B=!1;try{for await(let f of I()){if(B)continue;if(f)yield JSON.parse(f)}B=!0}catch(f){if(Xu(f))return;throw f}finally{if(!B)$.abort()}}return new zV(D,$,A)}[(HTH=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let H=[],$=[],A=this.iterator(),L=(I)=>{return{next:()=>{if(I.length===0){let D=A.next();H.push(D),$.push(D)}return I.shift()}}};return[new zV(()=>L(H),this.controller,xA(this,HTH,"f")),new zV(()=>L($),this.controller,xA(this,HTH,"f"))]}toReadableStream(){let H=this,$;return JLA({async start(){$=H[Symbol.asyncIterator]()},async pull(A){try{let{value:L,done:I}=await $.next();if(I)return A.close();let D=sqH(JSON.stringify(L)+`
3b1fe7c5a ${U}`)}return B},_4;var vi=K(()=>{TV();wcL=Object.freeze(Object.create(null)),_4=aw0(ZcL)});var ITH;var TLA=K(()=>{rR();Qq();B4H();vi();ITH=class ITH extends _5{list(H={},$){let{betas:A,...L}=H??{};return this._client.getAPIList("/v1/files",sN,{query:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"files-api-2025-04-14"].toString()},$?.headers])})}delete(H,$={},A){let{betas:L}=$??{};return this._client.delete(_4`/v1/files/${H}`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"files-api-2025-04-14"].toString()},A?.headers])})}download(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/files/${H}/content`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"files-api-2025-04-14"].toString(),Accept:"application/binary"},A?.headers]),__binaryResponse:!0})}retrieveMetadata(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/files/${H}`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"files-api-2025-04-14"].toString()},A?.headers])})}upload(H,$){let{betas:A,...L}=H;return this._client.post("/v1/files",D4H({body:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"files-api-2025-04-14"].toString()},$?.headers])},this._client))}}});var DTH;var zLA=K(()=>{rR();Qq();vi();DTH=class DTH extends _5{retrieve(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/models/${H}?beta=true`,{...A,headers:Z9([{...L?.toString()!=null?{"anthropic-beta":L?.toString()}:void 0},A?.headers])})}list(H={},$){let{betas:A,...L}=H??{};return this._client.getAPIList("/v1/models?beta=true",sN,{query:L,...$,headers:Z9([{...A?.toString()!=null?{"anthropic-beta":A?.toString()}:void 0},$?.headers])})}}});var jB$;var NLA=K(()=>{jB$={"claude-opus-4-20250514":8192,"claude-opus-4-0":8192,"claude-4-opus-20250514":8192,"anthropic.claude-opus-4-20250514-v1:0":8192,"claude-opus-4@20250514":8192,"claude-opus-4-1-20250805":8192,"anthropic.claude-opus-4-1-20250805-v1:0":8192,"claude-opus-4-1@20250805":8192}});function OLA(H,$){if(!$||!("parse"in($.output_format??{})))return{...H,content:H.content.map((A)=>{if(A.type==="text")return{...A,parsed:null};return A}),parsed_output:null};return xLA(H,$)}function xLA(H,$){let A=null,L=H.content.map((I)=>{if(I.type==="text"){let D=sw0($,I.text);if(A===null)A=D;return{...I,parsed:D}}return I});return{...H,content:L,parsed_output:A}}function sw0(H,$){if(H.output_format?.type!=="json_schema")return null;try{if("parse"in H.output_format)return H.output_format.parse($);return JSON.parse($)}catch(A){throw new LD(`Failed to parse structured output: ${A}`)}}var SLA=K(()=>{TV()});var ew0=(H)=>{let $=0,A=[];while($<H.length){let L=H[$];if(L==="\\"){$++;continue}if(L==="{"){A.push({type:"brace",value:"{"}),$++;continue}if(L==="}"){A.push({type:"brace",value:"}"}),$++;continue}if(L==="["){A.push({type:"paren",value:"["}),$++;continue}if(L==="]"){A.push({type:"paren",value:"]"}),$++;continue}if(L===":"){A.push({type:"separator",value:":"}),$++;continue}if(L===","){A.push({type:"delimiter",value:","}),$++;continue}if(L==='"'){let f="",E=!1;L=H[++$];while(L!=='"'){if($===H.length){E=!0;break}if(L==="\\"){if($++,$===H.length){E=!0;break}f+=L+H[$],L=H[++$]}else f+=L,L=H[++$]}if(L=H[++$],!E)A.push({type:"string",value:f});continue}if(L&&/\s/.test(L)){$++;continue}let D=/[0-9]/;if(L&&D.test(L)||L==="-"||L==="."){let f="";if(L==="-")f+=L,L=H[++$];while(L&&D.test(L)||L===".")f+=L,L=H[++$];A.push({type:"number",value:f});continue}let B=/[a-z]/i;if(L&&B.test(L)){let f="";while(L&&B.test(L)){if($===H.length)break;f+=L,L=H[++$]}if(f=="true"||f=="false"||f==="null")A.push({type:"name",value:f});else{$++;continue}continue}$++}return A},f4H=(H)=>{if(H.length===0)return H;let $=H[H.length-1];switch($.type){case"separator":return H=H.slice(0,H.length-1),f4H(H);break;case"number":let A=$.value[$.value.length-1];if(A==="."||A==="-")return H=H.slice(0,H.length-1),f4H(H);case"string":let L=H[H.length-2];if(L?.type==="delimiter")return H=H.slice(0,H.length-1),f4H(H);else if(L?.type==="brace"&&L.value==="{")return H=H.slice(0,H.length-1),f4H(H);break;case"delimiter":return H=H.slice(0,H.length-1),f4H(H);break}return H},HZ0=(H)=>{let $=[];if(H.map((A)=>{if(A.type==="brace")if(A.value==="{")$.push("}");else $.splice($.lastIndexOf("}"),1);if(A.type==="paren")if(A.value==="[")$.push("]");else $.splice($.lastIndexOf("]"),1)}),$.length>0)$.reverse().map((A)=>{if(A==="}")H.push({type:"brace",value:"}"});else if(A==="]")H.push({type:"paren",value:"]"})});return H},$Z0=(H)=>{let $="";return H.map((A)=>{switch(A.type){case"string":$+='"'+A.value+'"';break;default:$+=A.value;break}}),$},RB$=(H)=>JSON.parse($Z0(HZ0(f4H(ew0(H)))));var jLA=()=>{};var zAH=K(()=>{TV()});var yB$=K(()=>{WLA()});function NcL(H){return H.type==="tool_use"||H.type==="server_tool_use"||H.type==="mcp_tool_use"}function OcL(H){}var Wq,hi,E4H,BTH,vB$,fTH,ETH,hB$,MTH,Fu,GTH,bB$,kB$,M4H,uB$,gB$,RLA,qcL,mB$,yLA,vLA,hLA,TcL,zcL="__json_buf",UTH;var xcL=K(()=>{Uu();jLA();zAH();yB$();SLA();UTH=class UTH{constructor(H){Wq.add(this),this.messages=[],this.receivedMessages=[],hi.set(this,void 0),E4H.set(this,null),this.controller=new AbortController,BTH.set(this,void 0),vB$.set(this,()=>{}),fTH.set(this,()=>{}),ETH.set(this,void 0),hB$.set(this,()=>{}),MTH.set(this,()=>{}),Fu.set(this,{}),GTH.set(this,!1),bB$.set(this,!1),kB$.set(this,!1),M4H.set(this,!1),uB$.set(this,void 0),gB$.set(this,void 0),mB$.set(this,($)=>{if(ED(this,bB$,!0,"f"),Xu($))$=new lf;if($ instanceof lf)return ED(this,kB$,!0,"f"),this._emit("abort",$);if($ instanceof LD)return this._emit("error",$);if($ instanceof Error){let A=new LD($.message);return A.cause=$,this._emit("error",A)}return this._emit("error",new LD(String($)))}),ED(this,BTH,new Promise(($,A)=>{ED(this,vB$,$,"f"),ED(this,fTH,A,"f")}),"f"),ED(this,ETH,new Promise(($,A)=>{ED(this,hB$,$,"f"),ED(this,MTH,A,"f")}),"f"),xA(this,BTH,"f").catch(()=>{}),xA(this,ETH,"f").catch(()=>{}),ED(this,E4H,H,"f")}get response(){return xA(this,uB$,"f")}get request_id(){return xA(this,gB$,"f")}async withResponse(){let H=await xA(this,BTH,"f");if(!H)throw Error("Could not resolve a `Response` object");return{data:this,response:H,request_id:H.headers.get("request-id")}}static fromReadableStream(H){let $=new UTH(null);return $._run(()=>$._fromReadableStream(H)),$}static createMessage(H,$,A){let L=new UTH($);for(let I of $.messages)L._addMessageParam(I);return ED(L,E4H,{...$,stream:!0},"f"),L._run(()=>L._createMessage(H,{...$,stream:!0},{...A,headers:{...A?.headers,"X-Stainless-Helper-Method":"stream"}})),L}_run(H){H().then(()=>{this._emitFinal(),this._emit("end")},xA(this,mB$,"f"))}_addMessageParam(H){this.messages.push(H)}_addMessage(H,$=!0){if(this.receivedMessages.push(H),$)this._emit("message",H)}async _createMessage(H,$,A){let L=A?.signal,I;if(L){if(L.aborted)this.controller.abort();I=this.controller.abort.bind(this.controller),L.addEventListener("abort",I)}try{xA(this,Wq,"m",yLA).call(this);let{response:D,data:B}=await H.create({...$,stream:!0},{...A,signal:this.controller.signal}).withResponse();this._connected(D);for await(let f of B)xA(this,Wq,"m",vLA).call(this,f);if(B.controller.signal?.aborted)throw new lf;xA(this,Wq,"m",hLA).call(this)}finally{if(L&&I)L.removeEventListener("abort",I)}}_connected(H){if(this.ended)return;ED(this,uB$,H,"f"),ED(this,gB$,H?.headers.get("request-id"),"f"),xA(this,vB$,"f").call(this,H),this._emit("connect")}get ended(){return xA(this,GTH,"f")}get errored(){return xA(this,bB$,"f")}get aborted(){return xA(this,kB$,"f")}abort(){this.controller.abort()}on(H,$){return(xA(this,Fu,"f")[H]||(xA(this,Fu,"f")[H]=[])).push({listener:$}),this}off(H,$){let A=xA(this,Fu,"f")[H];if(!A)return this;let L=A.findIndex((I)=>I.listener===$);if(L>=0)A.splice(L,1);return this}once(H,$){return(xA(this,Fu,"f")[H]||(xA(this,Fu,"f")[H]=[])).push({listener:$,once:!0}),this}emitted(H){return new Promise(($,A)=>{if(ED(this,M4H,!0,"f"),H!=="error")this.once("error",A);this.once(H,$)})}async done(){ED(this,M4H,!0,"f"),await xA(this,ETH,"f")}get currentMessage(){return xA(this,hi,"f")}async finalMessage(){return await this.done(),xA(this,Wq,"m",RLA).call(this)}async finalText(){return await this.done(),xA(this,Wq,"m",qcL).call(this)}_emit(H,...$){if(xA(this,GTH,"f"))return;if(H==="end")ED(this,GTH,!0,"f"),xA(this,hB$,"f").call(this);let A=xA(this,Fu,"f")[H];if(A)xA(this,Fu,"f")[H]=A.filter((L)=>!L.once),A.forEach(({listener:L})=>L(...$));if(H==="abort"){let L=$[0];if(!xA(this,M4H,"f")&&!A?.length)Promise.reject(L);xA(this,fTH,"f").call(this,L),xA(this,MTH,"f").call(this,L),this._emit("end");return}if(H==="error"){let L=$[0];if(!xA(this,M4H,"f")&&!A?.length)Promise.reject(L);xA(this,fTH,"f").call(this,L),xA(this,MTH,"f").call(this,L),this._emit("end")}}_emitFinal(){if(this.receivedMessages.at(-1))this._emit("finalMessage",xA(this,Wq,"m",RLA).call(this))}async _fromReadableStream(H,$){let A=$?.signal,L;if(A){if(A.aborted)this.controller.abort();L=this.controller.abort.bind(this.controller),A.addEventListener("abort",L)}try{xA(this,Wq,"m",yLA).call(this),this._connected(null);let I=zV.fromReadableStream(H,this.controller);for await(let D of I)xA(this,Wq,"m",vLA).call(this,D);if(I.controller.signal?.aborted)throw new lf;xA(this,Wq,"m",hLA).call(this)}finally{if(A&&L)A.removeEventListener("abort",L)}}[(hi=new WeakMap,E4H=new WeakMap,BTH=new WeakMap,vB$=new WeakMap,fTH=new WeakMap,ETH=new WeakMap,hB$=new WeakMap,MTH=new WeakMap,Fu=new WeakMap,GTH=new WeakMap,bB$=new WeakMap,kB$=new WeakMap,M4H=new WeakMap,uB$=new WeakMap,gB$=new WeakMap,mB$=new WeakMap,Wq=new WeakSet,RLA=function(){if(this.receivedMessages.length===0)throw new LD("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},qcL=function(){if(this.receivedMessages.length===0)throw new LD("stream ended without producing a Message with role=assistant");let $=this.receivedMessages.at(-1).content.filter((A)=>A.type==="text").map((A)=>A.text);if($.length===0)throw new LD("stream ended without producing a content block with type=text");return $.join(" ")},yLA=function(){if(this.ended)return;ED(this,hi,void 0,"f")},vLA=function($){if(this.ended)return;let A=xA(this,Wq,"m",TcL).call(this,$);switch(this._emit("streamEvent",$,A),$.type){case"content_block_delta":{let L=A.content.at(-1);switch($.delta.type){case"text_delta":{if(L.type==="text")this._emit("text",$.delta.text,L.text||"");break}case"citations_delta":{if(L.type==="text")this._emit("citation",$.delta.citation,L.citations??[]);break}case"input_json_delta":{if(NcL(L)&&L.input)this._emit("inputJson",$.delta.partial_json,L.input);break}case"thinking_delta":{if(L.type==="thinking")this._emit("thinking",$.delta.thinking,L.thinking);break}case"signature_delta":{if(L.type==="thinking")this._emit("signature",L.signature);break}default:OcL($.delta)}break}case"message_stop":{this._addMessageParam(A),this._addMessage(OLA(A,xA(this,E4H,"f")),!0);break}case"content_block_stop":{this._emit("contentBlock",A.content.at(-1));break}case"message_start":{ED(this,hi,A,"f");break}case"content_block_start":case"message_delta":break}},hLA=function(){if(this.ended)throw new LD("stream has ended, this shouldn't happen");let $=xA(this,hi,"f");if(!$)throw new LD("request ended without sending any chunks");return ED(this,hi,void 0,"f"),OLA($,xA(this,E4H,"f"))},TcL=function($){let A=xA(this,hi,"f");if($.type==="message_start"){if(A)throw new LD(`Unexpected event order, got ${$.type} before receiving "message_stop"`);return $.message}if(!A)throw new LD(`Unexpected event order, got ${$.type} before "message_start"`);switch($.type){case"message_stop":return A;case"message_delta":if(A.container=$.delta.container,A.stop_reason=$.delta.stop_reason,A.stop_sequence=$.delta.stop_sequence,A.usage.output_tokens=$.usage.output_tokens,A.context_management=$.context_management,$.usage.input_tokens!=null)A.usage.input_tokens=$.usage.input_tokens;if($.usage.cache_creation_input_tokens!=null)A.usage.cache_creation_input_tokens=$.usage.cache_creation_input_tokens;if($.usage.cache_read_input_tokens!=null)A.usage.cache_read_input_tokens=$.usage.cache_read_input_tokens;if($.usage.server_tool_use!=null)A.usage.server_tool_use=$.usage.server_tool_use;return A;case"content_block_start":return A.content.push($.content_block),A;case"content_block_delta":{let L=A.content.at($.index);switch($.delta.type){case"text_delta":{if(L?.type==="text")A.content[$.index]={...L,text:(L.text||"")+$.delta.text};break}case"citations_delta":{if(L?.type==="text")A.content[$.index]={...L,citations:[...L.citations??[],$.delta.citation]};break}case"input_json_delta":{if(L&&NcL(L)){let I=L[zcL]||"";I+=$.delta.partial_json;let D={...L};if(Object.defineProperty(D,zcL,{value:I,enumerable:!1,writable:!0}),I)try{D.input=RB$(I)}catch(B){let f=new LD(`Unable to parse tool parameter JSON from model. Please retry your request or adjust your prompt. Error: ${B}. JSON: ${I}`);xA(this,mB$,"f").call(this,f)}A.content[$.index]=D}break}case"thinking_delta":{if(L?.type==="thinking")A.content[$.index]={...L,thinking:L.thinking+$.delta.thinking};break}case"signature_delta":{if(L?.type==="thinking")A.content[$.index]={...L,signature:$.delta.signature};break}default:OcL($.delta)}return A}case"content_block_stop":return A}},Symbol.asyncIterator)](){let H=[],$=[],A=!1;return this.on("streamEvent",(L)=>{let I=$.shift();if(I)I.resolve(L);else H.push(L)}),this.on("end",()=>{A=!0;for(let L of $)L.resolve(void 0);$.length=0}),this.on("abort",(L)=>{A=!0;for(let I of $)I.reject(L);$.length=0}),this.on("error",(L)=>{A=!0;for(let I of $)I.reject(L);$.length=0}),{next:async()=>{if(!H.length){if(A)return{value:void 0,done:!0};return new Promise((I,D)=>$.push({resolve:I,reject:D})).then((I)=>I?{value:I,done:!1}:{value:void 0,done:!0})}return{value:H.shift(),done:!1}},return:async()=>{return this.abort(),{value:void 0,done:!0}}}}toReadableStream(){return new zV(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}});function ScL(){let H,$;return{promise:new Promise((L,I)=>{H=L,$=I}),resolve:H,reject:$}}async function AZ0(H,$=H.messages.at(-1)){if(!$||$.role!=="assistant"||!$.content||typeof $.content==="string")return null;let A=$.content.filter((I)=>I.type==="tool_use");if(A.length===0)return null;return{role:"user",content:await Promise.all(A.map(async(I)=>{let D=H.tools.find((B)=>B.name===I.name);if(!D||!("run"in D))return{type:"tool_result",tool_use_id:I.id,content:`Error: Tool '${I.name}' not found`,is_error:!0};try{let B=I.input;if("parse"in D&&D.parse)B=D.parse(B);let f=await D.run(B);return{type:"tool_result",tool_use_id:I.id,content:f}}catch(B){return{type:"tool_result",tool_use_id:I.id,content:`Error: ${B instanceof Error?B.message:String(B)}`,is_error:!0}}}))}}var pB$,G4H,NAH,m_,XTH,eN,Ku,bi,JTH,bLA,FTH;var kLA=K(()=>{Uu();TV();Qq();FTH=class FTH{constructor(H,$,A){pB$.add(this),this.client=H,G4H.set(this,!1),NAH.set(this,!1),m_.set(this,void 0),XTH.set(this,void 0),eN.set(this,void 0),Ku.set(this,void 0),bi.set(this,void 0),JTH.set(this,0),ED(this,m_,{params:{...$,messages:structuredClone($.messages)}},"f"),ED(this,XTH,{...A,headers:Z9([{"x-stainless-helper":"BetaToolRunner"},A?.headers])},"f"),ED(this,bi,ScL(),"f")}async*[(G4H=new WeakMap,NAH=new WeakMap,m_=new WeakMap,XTH=new WeakMap,eN=new WeakMap,Ku=new WeakMap,bi=new WeakMap,JTH=new WeakMap,pB$=new WeakSet,Symbol.asyncIterator)](){var H;if(xA(this,G4H,"f"))throw new LD("Cannot iterate over a consumed stream");ED(this,G4H,!0,"f"),ED(this,NAH,!0,"f"),ED(this,Ku,void 0,"f");try{while(!0){let $;try{if(xA(this,m_,"f").params.max_iterations&&xA(this,JTH,"f")>=xA(this,m_,"f").params.max_iterations)break;ED(this,NAH,!1,"f"),ED(this,eN,void 0,"f"),ED(this,Ku,void 0,"f"),ED(this,JTH,(H=xA(this,JTH,"f"),H++,H),"f");let{max_iterations:A,...L}=xA(this,m_,"f").params;if(L.stream)$=this.client.beta.messages.stream({...L},xA(this,XTH,"f")),ED(this,eN,$.finalMessage(),"f"),xA(this,eN,"f").catch(()=>{}),yield $;else ED(this,eN,this.client.beta.messages.create({...L,stream:!1},xA(this,XTH,"f")),"f"),yield xA(this,eN,"f");if(!xA(this,NAH,"f")){let{role:D,content:B}=await xA(this,eN,"f");xA(this,m_,"f").params.messages.push({role:D,content:B})}let I=await xA(this,pB$,"m",bLA).call(this,xA(this,m_,"f").params.messages.at(-1));if(I)xA(this,m_,"f").params.messages.push(I);if(!I&&!xA(this,NAH,"f"))break}finally{if($)$.abort()}}if(!xA(this,eN,"f"))throw new LD("ToolRunner concluded without a message from the server");xA(this,bi,"f").resolve(await xA(this,eN,"f"))}catch($){throw ED(this,G4H,!1,"f"),xA(this,bi,"f").promise.catch(()=>{}),xA(this,bi,"f").reject($),ED(this,bi,ScL(),"f"),$}}setMessagesParams(H){if(typeof H==="function")xA(this,m_,"f").params=H(xA(this,m_,"f").params);else xA(this,m_,"f").params=H;ED(this,NAH,!0,"f"),ED(this,Ku,void 0,"f")}async generateToolResponse(){let H=await xA(this,eN,"f")??this.params.messages.at(-1);if(!H)return null;return xA(this,pB$,"m",bLA).call(this,H)}done(){return xA(this,bi,"f").promise}async runUntilDone(){if(!xA(this,G4H,"f"))for await(let H of this);return this.done()}get params(){return xA(this,m_,"f").params}pushMessages(...H){this.setMessagesParams(($)=>({...$,messages:[...$.messages,...H]}))}then(H,$){return this.runUntilDone().then(H,$)}};bLA=async function($){if(xA(this,Ku,"f")!==void 0)return xA(this,Ku,"f");return ED(this,Ku,AZ0(xA(this,m_,"f").params,$),"f"),xA(this,Ku,"f")}});var U4H;var uLA=K(()=>{TV();KLA();U4H=class U4H{constructor(H,$){this.iterator=H,this.controller=$}async*decoder(){let H=new yi;for await(let $ of this.iterator)for(let A of H.decode($))yield JSON.parse(A);for(let $ of H.flush())yield JSON.parse($)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(H,$){if(!H.body){if($.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative")throw new LD("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new LD("Attempted to iterate over a response with no body")}return new U4H(tqH(H.body),$)}}});var KTH;var gLA=K(()=>{rR();Qq();uLA();zAH();vi();KTH=class KTH extends _5{create(H,$){let{betas:A,...L}=H;return this._client.post("/v1/messages/batches?beta=true",{body:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"message-batches-2024-09-24"].toString()},$?.headers])})}retrieve(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/messages/batches/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"message-batches-2024-09-24"].toString()},A?.headers])})}list(H={},$){let{betas:A,...L}=H??{};return this._client.getAPIList("/v1/messages/batches?beta=true",sN,{query:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"message-batches-2024-09-24"].toString()},$?.headers])})}delete(H,$={},A){let{betas:L}=$??{};return this._client.delete(_4`/v1/messages/batches/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"message-batches-2024-09-24"].toString()},A?.headers])})}cancel(H,$={},A){let{betas:L}=$??{};return this._client.post(_4`/v1/messages/batches/${H}/cancel?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"message-batches-2024-09-24"].toString()},A?.headers])})}async results(H,$={},A){let L=await this.retrieve(H);if(!L.results_url)throw new LD(`No batch \`results_url\`; Has it finished processing? ${L.processing_status} - ${L.id}`);let{betas:I}=$??{};return this._client.get(L.results_url,{...A,headers:Z9([{"anthropic-beta":[...I??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary"},A?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((D,B)=>U4H.fromResponse(B.response,B.controller))}}});var jcL,OAH;var mLA=K(()=>{NLA();Qq();SLA();xcL();kLA();gLA();gLA();kLA();jcL={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-7-sonnet-latest":"February 19th, 2026","claude-3-7-sonnet-20250219":"February 19th, 2026"};OAH=class OAH extends _5{constructor(){super(...arguments);this.batches=new KTH(this._client)}create(H,$){let{betas:A,...L}=H;if(L.model in jcL)console.warn(`The model '${L.model}' is deprecated and will reach end-of-life on ${jcL[L.model]}
3b1fecbcc Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let I=this._client._options.timeout;if(!L.stream&&I==null){let D=jB$[L.model]??void 0;I=this._client.calculateNonstreamingTimeout(L.max_tokens,D)}return this._client.post("/v1/messages?beta=true",{body:L,timeout:I??600000,...$,headers:Z9([{...A?.toString()!=null?{"anthropic-beta":A?.toString()}:void 0},$?.headers]),stream:H.stream??!1})}parse(H,$){return $={...$,headers:Z9([{"anthropic-beta":[...H.betas??[],"structured-outputs-2025-09-17"].toString()},$?.headers])},this.create(H,$).then((A)=>xLA(A,H))}stream(H,$){return UTH.createMessage(this,H,$)}countTokens(H,$){let{betas:A,...L}=H;return this._client.post("/v1/messages/count_tokens?beta=true",{body:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"token-counting-2024-11-01"].toString()},$?.headers])})}toolRunner(H,$){return new FTH(this._client,H,$)}};OAH.Batches=KTH;OAH.BetaToolRunner=FTH});var QTH;var pLA=K(()=>{rR();Qq();B4H();vi();QTH=class QTH extends _5{create(H,$={},A){let{betas:L,...I}=$??{};return this._client.post(_4`/v1/skills/${H}/versions?beta=true`,D4H({body:I,...A,headers:Z9([{"anthropic-beta":[...L??[],"skills-2025-10-02"].toString()},A?.headers])},this._client))}retrieve(H,$,A){let{skill_id:L,betas:I}=$;return this._client.get(_4`/v1/skills/${L}/versions/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...I??[],"skills-2025-10-02"].toString()},A?.headers])})}list(H,$={},A){let{betas:L,...I}=$??{};return this._client.getAPIList(_4`/v1/skills/${H}/versions?beta=true`,ATH,{query:I,...A,headers:Z9([{"anthropic-beta":[...L??[],"skills-2025-10-02"].toString()},A?.headers])})}delete(H,$,A){let{skill_id:L,betas:I}=$;return this._client.delete(_4`/v1/skills/${L}/versions/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...I??[],"skills-2025-10-02"].toString()},A?.headers])})}}});var X4H;var dLA=K(()=>{pLA();pLA();rR();Qq();B4H();vi();X4H=class X4H extends _5{constructor(){super(...arguments);this.versions=new QTH(this._client)}create(H={},$){let{betas:A,...L}=H??{};return this._client.post("/v1/skills?beta=true",D4H({body:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"skills-2025-10-02"].toString()},$?.headers])},this._client))}retrieve(H,$={},A){let{betas:L}=$??{};return this._client.get(_4`/v1/skills/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"skills-2025-10-02"].toString()},A?.headers])})}list(H={},$){let{betas:A,...L}=H??{};return this._client.getAPIList("/v1/skills?beta=true",ATH,{query:L,...$,headers:Z9([{"anthropic-beta":[...A??[],"skills-2025-10-02"].toString()},$?.headers])})}delete(H,$={},A){let{betas:L}=$??{};return this._client.delete(_4`/v1/skills/${H}?beta=true`,{...A,headers:Z9([{"anthropic-beta":[...L??[],"skills-2025-10-02"].toString()},A?.headers])})}};X4H.Versions=QTH});var y6;var cLA=K(()=>{TLA();TLA();zLA();zLA();mLA();mLA();dLA();dLA();y6=class y6 extends _5{constructor(){super(...arguments);this.models=new DTH(this._client),this.messages=new OAH(this._client),this.files=new ITH(this._client),this.skills=new X4H(this._client)}};y6.Models=DTH;y6.Messages=OAH;y6.Files=ITH;y6.Skills=X4H});var ki;var lLA=K(()=>{Qq();ki=class ki extends _5{create(H,$){let{betas:A,...L}=H;return this._client.post("/v1/complete",{body:L,timeout:this._client._options.timeout??600000,...$,headers:Z9([{...A?.toString()!=null?{"anthropic-beta":A?.toString()}:void 0},$?.headers]),stream:H.stream??!1})}}});function hcL(H){return H.type==="tool_use"||H.type==="server_tool_use"}function bcL(H){}var Vq,ui,WTH,dB$,VTH,PTH,cB$,_TH,Qu,CTH,lB$,iB$,J4H,nB$,rB$,iLA,RcL,nLA,rLA,aLA,oLA,ycL,vcL="__json_buf",YTH;var kcL=K(()=>{Uu();zAH();yB$();jLA();YTH=class YTH{constructor(){Vq.add(this),this.messages=[],this.receivedMessages=[],ui.set(this,void 0),this.controller=new AbortController,WTH.set(this,void 0),dB$.set(this,()=>{}),VTH.set(this,()=>{}),PTH.set(this,void 0),cB$.set(this,()=>{}),_TH.set(this,()=>{}),Qu.set(this,{}),CTH.set(this,!1),lB$.set(this,!1),iB$.set(this,!1),J4H.set(this,!1),nB$.set(this,void 0),rB$.set(this,void 0),nLA.set(this,(H)=>{if(ED(this,lB$,!0,"f"),Xu(H))H=new lf;if(H instanceof lf)return ED(this,iB$,!0,"f"),this._emit("abort",H);if(H instanceof LD)return this._emit("error",H);if(H instanceof Error){let $=new LD(H.message);return $.cause=H,this._emit("error",$)}return this._emit("error",new LD(String(H)))}),ED(this,WTH,new Promise((H,$)=>{ED(this,dB$,H,"f"),ED(this,VTH,$,"f")}),"f"),ED(this,PTH,new Promise((H,$)=>{ED(this,cB$,H,"f"),ED(this,_TH,$,"f")}),"f"),xA(this,WTH,"f").catch(()=>{}),xA(this,PTH,"f").catch(()=>{})}get response(){return xA(this,nB$,"f")}get request_id(){return xA(this,rB$,"f")}async withResponse(){let H=await xA(this,WTH,"f");if(!H)throw Error("Could not resolve a `Response` object");return{data:this,response:H,request_id:H.headers.get("request-id")}}static fromReadableStream(H){let $=new YTH;return $._run(()=>$._fromReadableStream(H)),$}static createMessage(H,$,A){let L=new YTH;for(let I of $.messages)L._addMessageParam(I);return L._run(()=>L._createMessage(H,{...$,stream:!0},{...A,headers:{...A?.headers,"X-Stainless-Helper-Method":"stream"}})),L}_run(H){H().then(()=>{this._emitFinal(),this._emit("end")},xA(this,nLA,"f"))}_addMessageParam(H){this.messages.push(H)}_addMessage(H,$=!0){if(this.receivedMessages.push(H),$)this._emit("message",H)}async _createMessage(H,$,A){let L=A?.signal,I;if(L){if(L.aborted)this.controller.abort();I=this.controller.abort.bind(this.controller),L.addEventListener("abort",I)}try{xA(this,Vq,"m",rLA).call(this);let{response:D,data:B}=await H.create({...$,stream:!0},{...A,signal:this.controller.signal}).withResponse();this._connected(D);for await(let f of B)xA(this,Vq,"m",aLA).call(this,f);if(B.controller.signal?.aborted)throw new lf;xA(this,Vq,"m",oLA).call(this)}finally{if(L&&I)L.removeEventListener("abort",I)}}_connected(H){if(this.ended)return;ED(this,nB$,H,"f"),ED(this,rB$,H?.headers.get("request-id"),"f"),xA(this,dB$,"f").call(this,H),this._emit("connect")}get ended(){return xA(this,CTH,"f")}get errored(){return xA(this,lB$,"f")}get aborted(){return xA(this,iB$,"f")}abort(){this.controller.abort()}on(H,$){return(xA(this,Qu,"f")[H]||(xA(this,Qu,"f")[H]=[])).push({listener:$}),this}off(H,$){let A=xA(this,Qu,"f")[H];if(!A)return this;let L=A.findIndex((I)=>I.listener===$);if(L>=0)A.splice(L,1);return this}once(H,$){return(xA(this,Qu,"f")[H]||(xA(this,Qu,"f")[H]=[])).push({listener:$,once:!0}),this}emitted(H){return new Promise(($,A)=>{if(ED(this,J4H,!0,"f"),H!=="error")this.once("error",A);this.once(H,$)})}async done(){ED(this,J4H,!0,"f"),await xA(this,PTH,"f")}get currentMessage(){return xA(this,ui,"f")}async finalMessage(){return await this.done(),xA(this,Vq,"m",iLA).call(this)}async finalText(){return await this.done(),xA(this,Vq,"m",RcL).call(this)}_emit(H,...$){if(xA(this,CTH,"f"))return;if(H==="end")ED(this,CTH,!0,"f"),xA(this,cB$,"f").call(this);let A=xA(this,Qu,"f")[H];if(A)xA(this,Qu,"f")[H]=A.filter((L)=>!L.once),A.forEach(({listener:L})=>L(...$));if(H==="abort"){let L=$[0];if(!xA(this,J4H,"f")&&!A?.length)Promise.reject(L);xA(this,VTH,"f").call(this,L),xA(this,_TH,"f").call(this,L),this._emit("end");return}if(H==="error"){let L=$[0];if(!xA(this,J4H,"f")&&!A?.length)Promise.reject(L);xA(this,VTH,"f").call(this,L),xA(this,_TH,"f").call(this,L),this._emit("end")}}_emitFinal(){if(this.receivedMessages.at(-1))this._emit("finalMessage",xA(this,Vq,"m",iLA).call(this))}async _fromReadableStream(H,$){let A=$?.signal,L;if(A){if(A.aborted)this.controller.abort();L=this.controller.abort.bind(this.controller),A.addEventListener("abort",L)}try{xA(this,Vq,"m",rLA).call(this),this._connected(null);let I=zV.fromReadableStream(H,this.controller);for await(let D of I)xA(this,Vq,"m",aLA).call(this,D);if(I.controller.signal?.aborted)throw new lf;xA(this,Vq,"m",oLA).call(this)}finally{if(A&&L)A.removeEventListener("abort",L)}}[(ui=new WeakMap,WTH=new WeakMap,dB$=new WeakMap,VTH=new WeakMap,PTH=new WeakMap,cB$=new WeakMap,_TH=new WeakMap,Qu=new WeakMap,CTH=new WeakMap,lB$=new WeakMap,iB$=new WeakMap,J4H=new WeakMap,nB$=new WeakMap,rB$=new WeakMap,nLA=new WeakMap,Vq=new WeakSet,iLA=function(){if(this.receivedMessages.length===0)throw new LD("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},RcL=function(){if(this.receivedMessages.length===0)throw new LD("stream ended without producing a Message with role=assistant");let $=this.receivedMessages.at(-1).content.filter((A)=>A.type==="text").map((A)=>A.text);if($.length===0)throw new LD("stream ended without producing a content block with type=text");return $.join(" ")},rLA=function(){if(this.ended)return;ED(this,ui,void 0,"f")},aLA=function($){if(this.ended)return;let A=xA(this,Vq,"m",ycL).call(this,$);switch(this._emit("streamEvent",$,A),$.type){case"content_block_delta":{let L=A.content.at(-1);switch($.delta.type){case"text_delta":{if(L.type==="text")this._emit("text",$.delta.text,L.text||"");break}case"citations_delta":{if(L.type==="text")this._emit("citation",$.delta.citation,L.citations??[]);break}case"input_json_delta":{if(hcL(L)&&L.input)this._emit("inputJson",$.delta.partial_json,L.input);break}case"thinking_delta":{if(L.type==="thinking")this._emit("thinking",$.delta.thinking,L.thinking);break}case"signature_delta":{if(L.type==="thinking")this._emit("signature",L.signature);break}default:bcL($.delta)}break}case"message_stop":{this._addMessageParam(A),this._addMessage(A,!0);break}case"content_block_stop":{this._emit("contentBlock",A.content.at(-1));break}case"message_start":{ED(this,ui,A,"f");break}case"content_block_start":case"message_delta":break}},oLA=function(){if(this.ended)throw new LD("stream has ended, this shouldn't happen");let $=xA(this,ui,"f");if(!$)throw new LD("request ended without sending any chunks");return ED(this,ui,void 0,"f"),$},ycL=function($){let A=xA(this,ui,"f");if($.type==="message_start"){if(A)throw new LD(`Unexpected event order, got ${$.type} before receiving "message_stop"`);return $.message}if(!A)throw new LD(`Unexpected event order, got ${$.type} before "message_start"`);switch($.type){case"message_stop":return A;case"message_delta":if(A.stop_reason=$.delta.stop_reason,A.stop_sequence=$.delta.stop_sequence,A.usage.output_tokens=$.usage.output_tokens,$.usage.input_tokens!=null)A.usage.input_tokens=$.usage.input_tokens;if($.usage.cache_creation_input_tokens!=null)A.usage.cache_creation_input_tokens=$.usage.cache_creation_input_tokens;if($.usage.cache_read_input_tokens!=null)A.usage.cache_read_input_tokens=$.usage.cache_read_input_tokens;if($.usage.server_tool_use!=null)A.usage.server_tool_use=$.usage.server_tool_use;return A;case"content_block_start":return A.content.push({...$.content_block}),A;case"content_block_delta":{let L=A.content.at($.index);switch($.delta.type){case"text_delta":{if(L?.type==="text")A.content[$.index]={...L,text:(L.text||"")+$.delta.text};break}case"citations_delta":{if(L?.type==="text")A.content[$.index]={...L,citations:[...L.citations??[],$.delta.citation]};break}case"input_json_delta":{if(L&&hcL(L)){let I=L[vcL]||"";I+=$.delta.partial_json;let D={...L};if(Object.defineProperty(D,vcL,{value:I,enumerable:!1,writable:!0}),I)D.input=RB$(I);A.content[$.index]=D}break}case"thinking_delta":{if(L?.type==="thinking")A.content[$.index]={...L,thinking:L.thinking+$.delta.thinking};break}case"signature_delta":{if(L?.type==="thinking")A.content[$.index]={...L,signature:$.delta.signature};break}default:bcL($.delta)}return A}case"content_block_stop":return A}},Symbol.asyncIterator)](){let H=[],$=[],A=!1;return this.on("streamEvent",(L)=>{let I=$.shift();if(I)I.resolve(L);else H.push(L)}),this.on("end",()=>{A=!0;for(let L of $)L.resolve(void 0);$.length=0}),this.on("abort",(L)=>{A=!0;for(let I of $)I.reject(L);$.length=0}),this.on("error",(L)=>{A=!0;for(let I of $)I.reject(L);$.length=0}),{next:async()=>{if(!H.length){if(A)return{value:void 0,done:!0};return new Promise((I,D)=>$.push({resolve:I,reject:D})).then((I)=>I?{value:I,done:!1}:{value:void 0,done:!0})}return{value:H.shift(),done:!1}},return:async()=>{return this.abort(),{value:void 0,done:!0}}}}toReadableStream(){return new zV(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}});var wTH;var tLA=K(()=>{rR();Qq();uLA();zAH();vi();wTH=class wTH extends _5{create(H,$){return this._client.post("/v1/messages/batches",{body:H,...$})}retrieve(H,$){return this._client.get(_4`/v1/messages/batches/${H}`,$)}list(H={},$){return this._client.getAPIList("/v1/messages/batches",sN,{query:H,...$})}delete(H,$){return this._client.delete(_4`/v1/messages/batches/${H}`,$)}cancel(H,$){return this._client.post(_4`/v1/messages/batches/${H}/cancel`,$)}async results(H,$){let A=await this.retrieve(H);if(!A.results_url)throw new LD(`No batch \`results_url\`; Has it finished processing? ${A.processing_status} - ${A.id}`);return this._client.get(A.results_url,{...$,headers:Z9([{Accept:"application/binary"},$?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((L,I)=>U4H.fromResponse(I.response,I.controller))}}});var w2,ucL;var sLA=K(()=>{kcL();tLA();tLA();NLA();w2=class w2 extends _5{constructor(){super(...arguments);this.batches=new wTH(this._client)}create(H,$){if(H.model in ucL)console.warn(`The model '${H.model}' is deprecated and will reach end-of-life on ${ucL[H.model]}
3b26f45d9 `),querySource:D.querySource,tools:vH(u)}:void 0,g=_vI(D.model,y,Y),v=Date.now(),p=Date.now(),d=0,k=void 0,n=void 0,GH=void 0,e=(HH)=>{let $H=[...f],DH=HD()==="bedrock"?[...ud$(HH.model),...G?[G]:[]]:[],MH=$X$(DH),AH={...MH.output_config??{}},KH=YyD()??D.effortValue??oaL(D.model);if(FY1(KH,AH,MH,$H,D.model),D.outputFormat&&!("format"in AH)){if(AH.format=D.outputFormat,!$H.includes(_c))$H.push(_c)}let CH=void 0;if(A!==0)if(YhI(D.model)){if(MH.thinking={type:"adaptive"},!$H.includes(BS$))$H.push(BS$);let lH=$H.indexOf(QlH);if(lH!==-1)$H.splice(lH,1)}else{let lH=A??PlH(D.model),hH=HH.maxTokensOverride||D.maxOutputTokensOverride;CH={budget_tokens:hH?Math.min(lH,hH-1):lH,type:"enabled"}}let TH=waL({hasThinking:A!==0}),yH=HH?.maxTokensOverride||D.maxOutputTokensOverride||Math.max((A??0)+1,zNA(D.model)),gH=D.enablePromptCaching??lrD(HH.model),QH=A!==0?void 0:D.temperatureOverride??1;return{model:zu(D.model),messages:VY1(Y,gH),system:O,tools:[...P,...D.extraToolSchemas??[]],tool_choice:D.toolChoice,...j?{betas:$H}:{},metadata:Kr(),max_tokens:yH,thinking:CH,...QH!==void 0&&{temperature:QH},...TH&&j&&$H.includes(WlH)?{context_management:TH}:{},...MH,...Object.keys(AH).length>0?{output_config:AH}:{}}};D.getToolPermissionContext().then((HH)=>{let $H=e({model:D.model,maxThinkingTokens:A}),MH=$H.output_config?.effort??"unset";WhI({model:D.model,messagesLength:$H.messages.length,temperature:D.temperatureOverride??1,betas:j?$H.betas??[]:[],permissionMode:HH.mode,querySource:D.querySource,queryTracking:D.queryTracking,effortValue:MH})});let BH=[],VH=0,wH=void 0,WH=[],qH=TC,s=0,IH=null,FH=!1,EH=0,YH=void 0,OH=void 0;try{W9("query_client_creation_start");let HH=KU$(()=>lO({maxRetries:0,model:D.model,fetchOverride:D.fetchOverride}),async(DH,MH,AH)=>{d=MH,p=Date.now();let KH=e(AH);LtH(KH,D.querySource),EH=KH.max_tokens;let CH=await DH.beta.messages.create({...KH,stream:!0},{signal:I}).withResponse();return n=CH.request_id,GH=CH.response,CH.data},{model:D.model,fallbackModel:D.fallbackModel,maxThinkingTokens:A,...!1,signal:I}),$H;do if($H=await HH.next(),!("controller"in $H.value))yield $H.value;while(!$H.done);if(k=$H.value,W9("query_client_creation_end"),BH.length=0,VH=0,wH=void 0,WH.length=0,qH=TC,IH=null,W9("query_api_request_sent"),!D.agentId)u9H("api_request_sent");try{let DH=!0,MH=null,AH=30000,KH=0,CH=0;for await(let yH of k){let gH=Date.now();if(MH!==null){let QH=gH-MH;if(QH>AH)CH++,KH+=QH,N(`Streaming stall detected: ${(QH/1000).toFixed(1)}s gap between events (stall #${CH})`,{level:"warn"}),c("tengu_streaming_stall",{stall_duration_ms:QH,stall_count:CH,total_stall_time_ms:KH,event_type:yH.type,model:D.model,request_id:n??"unknown"})}if(MH=gH,DH){if(N("Stream started - received first chunk"),W9("query_first_chunk_received"),!D.agentId)u9H("first_chunk");czD(),DH=!1}switch(yH.type){case"message_start":{wH=yH.message,VH=Date.now()-p,qH=O9H(qH,yH.message.usage);break}case"content_block_start":switch(yH.content_block.type){case"tool_use":WH[yH.index]={...yH.content_block,input:""};break;case"server_tool_use":WH[yH.index]={...yH.content_block,input:""};break;case"text":WH[yH.index]={...yH.content_block,text:""};break;case"thinking":WH[yH.index]={...yH.content_block,thinking:"",signature:""};break;default:WH[yH.index]={...yH.content_block};break}break;case"content_block_delta":{let QH=WH[yH.index];if(!QH)throw c("tengu_streaming_error",{error_type:"content_block_not_found_delta",part_type:yH.type,part_index:yH.index}),RangeError("Content block not found");switch(yH.delta.type){case"citations_delta":break;case"input_json_delta":if(QH.type!=="tool_use"&&QH.type!=="server_tool_use")throw c("tengu_streaming_error",{error_type:"content_block_type_mismatch_input_json",expected_type:"tool_use",actual_type:QH.type}),Error("Content block is not a input_json block");if(typeof QH.input!=="string")throw c("tengu_streaming_error",{error_type:"content_block_input_not_string",input_type:typeof QH.input}),Error("Content block input is not a string");QH.input+=yH.delta.partial_json;break;case"text_delta":if(QH.type!=="text")throw c("tengu_streaming_error",{error_type:"content_block_type_mismatch_text",expected_type:"text",actual_type:QH.type}),Error("Content block is not a text block");QH.text+=yH.delta.text;break;case"signature_delta":if(QH.type!=="thinking")throw c("tengu_streaming_error",{error_type:"content_block_type_mismatch_thinking_signature",expected_type:"thinking",actual_type:QH.type}),Error("Content block is not a thinking block");QH.signature=yH.delta.signature;break;case"thinking_delta":if(QH.type!=="thinking")throw c("tengu_streaming_error",{error_type:"content_block_type_mismatch_thinking_delta",expected_type:"thinking",actual_type:QH.type}),Error("Content block is not a thinking block");QH.thinking+=yH.delta.thinking;break}break}case"content_block_stop":{let QH=WH[yH.index];if(!QH)throw c("tengu_streaming_error",{error_type:"content_block_not_found_stop",part_type:yH.type,part_index:yH.index}),RangeError("Content block not found");if(!wH)throw c("tengu_streaming_error",{error_type:"partial_message_not_found",part_type:yH.type}),Error("Message not found");let lH={message:{...wH,content:Xz$([QH],L,D.agentId)},requestId:n??void 0,type:"assistant",uuid:Uz$.randomUUID(),timestamp:new Date().toISOString(),...{}};BH.push(lH),yield lH;break}case"message_delta":{qH=O9H(qH,yH.usage);let QH=BH[BH.length-1];if(QH)QH.message={...QH.message,usage:qH};IH=yH.delta.stop_reason;let lH=D9$(B,qH);$9$(lH,qH,D.model),s+=lH;let hH=y6I(yH.delta.stop_reason,D.model);if(hH)yield hH;if(IH==="max_tokens")c("tengu_max_tokens_reached",{max_tokens:EH}),yield Yf({content:`${z5}: Claude's response exceeded the ${EH} output token maximum. To configure this behavior, set the CLAUDE_CODE_MAX_OUTPUT_TOKENS environment variable.`,apiError:"max_output_tokens"});if(IH==="model_context_window_exceeded")c("tengu_context_window_exceeded",{max_tokens:EH,output_tokens:qH.output_tokens}),yield Yf({content:`${z5}: The model has reached its context window limit.`});break}case"message_stop":break}yield{type:"stream_event",event:yH}}if(!wH||BH.length===0&&!IH)throw N(!wH?"Stream completed without receiving message_start event - triggering non-streaming fallback":"Stream completed with message_start but no content blocks completed - triggering non-streaming fallback",{level:"error"}),c("tengu_stream_no_events",{model:D.model,request_id:n??"unknown"}),Error("Stream ended without receiving any events");if(CH>0)N(`Streaming completed with ${CH} stall(s), total stall time: ${(KH/1000).toFixed(1)}s`,{level:"warn"}),c("tengu_streaming_stall_summary",{stall_count:CH,total_stall_time_ms:KH,model:D.model,request_id:n??"unknown"});tvI(D.querySource,qH.cache_read_input_tokens,qH.cache_creation_input_tokens,H,D.agentId);let TH=GH;if(TH)kUA(TH.headers),YH=TH.headers}catch(DH){if(DH instanceof lf)if(I.aborted)throw N(`Streaming aborted by user: ${DH instanceof Error?DH.message:String(DH)}`),DH;else throw N(`Streaming timeout (SDK abort): ${DH.message}`,{level:"error"}),new nR({message:"Request timed out"});if(N(`Error streaming, falling back to non-streaming mode: ${DH instanceof Error?DH.message:String(DH)}`,{level:"error"}),FH=!0,D.onStreamingFallback)D.onStreamingFallback();c("tengu_streaming_fallback_to_non_streaming",{model:D.model,error:DH instanceof Error?DH.name:String(DH),attemptNumber:d,maxOutputTokens:EH,maxThinkingTokens:A});let MH=yield*irD({model:D.model},{model:D.model,maxThinkingTokens:A,...{},signal:I},e,(KH,CH,TH)=>{d=KH,EH=TH},(KH)=>LtH(KH,D.querySource)),AH={message:{...MH,content:Xz$(MH.content,L,D.agentId)},requestId:n??void 0,type:"assistant",uuid:Uz$.randomUUID(),timestamp:new Date().toISOString(),...{}};BH.push(AH),yield AH}}catch(HH){if(!FH&&HH instanceof my&&HH.originalError instanceof KD&&HH.originalError.status===404){if(N("Streaming endpoint returned 404, falling back to non-streaming mode",{level:"warn"}),FH=!0,D.onStreamingFallback)D.onStreamingFallback();c("tengu_streaming_fallback_to_non_streaming",{model:D.model,error:"404_stream_creation",attemptNumber:d,maxOutputTokens:EH,maxThinkingTokens:A});try{let DH=yield*irD({model:D.model},{model:D.model,maxThinkingTokens:A,...{},signal:I},e,(AH,KH,CH)=>{d=AH,EH=CH},(AH)=>LtH(AH,D.querySource)),MH={message:{...DH,content:Xz$(DH.content,L,D.agentId)},requestId:n??void 0,type:"assistant",uuid:Uz$.randomUUID(),timestamp:new Date().toISOString(),...{}};BH.push(MH),yield MH}catch(DH){N(`Non-streaming fallback also failed: ${DH instanceof Error?DH.message:String(DH)}`,{level:"error"});let MH=DH,AH=D.model;if(DH instanceof my)MH=DH.originalError,AH=DH.retryContext.model;if(MH instanceof KD)hG$(MH);let KH=n||(MH instanceof KD?MH.requestID:void 0)||(MH instanceof KD?MH.error?.request_id:void 0);if(O6A({error:MH,model:AH,messageCount:Y.length,messageTokens:VP(Y),durationMs:Date.now()-p,durationMsIncludingRetries:Date.now()-v,attempt:d,requestId:KH,didFallBackToNonStreaming:FH,queryTracking:D.queryTracking,querySource:D.querySource,llmSpan:g}),MH instanceof lf){$pH(k);return}yield XU$(MH,AH,{messages:H,messagesForAPI:Y}),$pH(k);return}}else{N(`Error in API request: ${HH instanceof Error?HH.message:String(HH)}`,{level:"error"});let DH=HH,MH=D.model;if(HH instanceof my)DH=HH.originalError,MH=HH.retryContext.model;if(DH instanceof KD)hG$(DH);let AH=n||(DH instanceof KD?DH.requestID:void 0)||(DH instanceof KD?DH.error?.request_id:void 0);if(O6A({error:DH,model:MH,messageCount:Y.length,messageTokens:VP(Y),durationMs:Date.now()-p,durationMsIncludingRetries:Date.now()-v,attempt:d,requestId:AH,didFallBackToNonStreaming:FH,queryTracking:D.queryTracking,querySource:D.querySource,llmSpan:g}),DH instanceof lf){$pH(k);return}yield XU$(DH,MH,{messages:H,messagesForAPI:Y}),$pH(k);return}}D.getToolPermissionContext().then((HH)=>{VhI({model:BH[0]?.message.model??wH?.model??D.model,preNormalizedModel:D.model,usage:qH,start:p,startIncludingRetries:v,attempt:d,messageCount:Y.length,messageTokens:VP(Y),requestId:n??null,stopReason:IH,ttftMs:VH,didFallBackToNonStreaming:FH,querySource:D.querySource,headers:YH,costUSD:s,queryTracking:D.queryTracking,permissionMode:HH.mode,newMessages:BH,llmSpan:g,globalCacheStrategy:W})}),$pH(k)}function $pH(H){if(!H)return;try{if(!H.controller.signal.aborted)H.controller.abort()}catch{}}function O9H(H,$){return{input_tokens:$.input_tokens!==null&&$.input_tokens>0?$.input_tokens:H.input_tokens,cache_creation_input_tokens:$.cache_creation_input_tokens!==null&&$.cache_creation_input_tokens>0?$.cache_creation_input_tokens:H.cache_creation_input_tokens,cache_read_input_tokens:$.cache_read_input_tokens!==null&&$.cache_read_input_tokens>0?$.cache_read_input_tokens:H.cache_read_input_tokens,output_tokens:$.output_tokens??H.output_tokens,server_tool_use:{web_search_requests:$.server_tool_use?.web_search_requests??H.server_tool_use.web_search_requests,web_fetch_requests:$.server_tool_use?.web_fetch_requests??H.server_tool_use.web_fetch_requests},service_tier:H.service_tier,cache_creation:{ephemeral_1h_input_tokens:$.cache_creation?.ephemeral_1h_input_tokens??H.cache_creation.ephemeral_1h_input_tokens,ephemeral_5m_input_tokens:$.cache_creation?.ephemeral_5m_input_tokens??H.cache_creation.ephemeral_5m_input_tokens}}}function cY$(H,$){return{input_tokens:H.input_tokens+$.input_tokens,cache_creation_input_tokens:H.cache_creation_input_tokens+$.cache_creation_input_tokens,cache_read_input_tokens:H.cache_read_input_tokens+$.cache_read_input_tokens,output_tokens:H.output_tokens+$.output_tokens,server_tool_use:{web_search_requests:H.server_tool_use.web_search_requests+$.server_tool_use.web_search_requests,web_fetch_requests:H.server_tool_use.web_fetch_requests+$.server_tool_use.web_fetch_requests},service_tier:$.service_tier,cache_creation:{ephemeral_1h_input_tokens:H.cache_creation.ephemeral_1h_input_tokens+$.cache_creation.ephemeral_1h_input_tokens,ephemeral_5m_input_tokens:H.cache_creation.ephemeral_5m_input_tokens+$.cache_creation.ephemeral_5m_input_tokens}}}function VY1(H,$){return c("tengu_api_cache_breakpoints",{totalMessageCount:H.length,cachingEnabled:$}),H.map((A,L)=>{return A.type==="user"?KY1(A,L>H.length-3,$):QY1(A,L>H.length-3,$)})}function PY1(H,$,A){return xOA(H,{skipGlobalCacheForSystemPrompt:A?.skipGlobalCacheForSystemPrompt}).map((L)=>{return{type:"text",text:L.text,...$&&L.cacheScope!==null?{cache_control:APH(L.cacheScope)}:{}}})}async function YQ({systemPrompt:H=[],userPrompt:$,outputFormat:A,signal:L,options:I}){return(await HX$([R$({content:H.map((B)=>({type:"text",text:B}))}),R$({content:$})],async()=>{let B=[R$({content:$})];return[await Qm({messages:B,systemPrompt:H,maxThinkingTokens:0,tools:[],signal:L,options:{...I,model:eX(),enablePromptCaching:I.enablePromptCaching??!1,outputFormat:A,async getToolPermissionContext(){return KK()}}})]}))[0]}async function fz$({systemPrompt:H=[],userPrompt:$,outputFormat:A,signal:L,options:I}){return(await HX$([R$({content:H.map((B)=>({type:"text",text:B}))}),R$({content:$})],async()=>{let B=[R$({content:$})];return[await Qm({messages:B,systemPrompt:H,maxThinkingTokens:0,tools:[],signal:L,options:{...I,enablePromptCaching:I.enablePromptCaching??!1,outputFormat:A,async getToolPermissionContext(){return KK()}}})]}))[0]}function CY1(H,$){let A=Math.min(H.max_tokens,$),L={...H};if(L.thinking?.type==="enabled"&&L.thinking.budget_tokens)L.thinking={...L.thinking,budget_tokens:Math.min(L.thinking.budget_tokens,A-1)};return{...L,max_tokens:A}}function zNA(H){let $=nfH(H),A=KlH.validate(process.env.CLAUDE_CODE_MAX_OUTPUT_TOKENS);if(A.status==="capped")N(`CLAUDE_CODE_MAX_OUTPUT_TOKENS ${A.message}`);else if(A.status==="invalid")N(`CLAUDE_CODE_MAX_OUTPUT_TOKENS ${A.message}`);return Math.min(A.effective,$)}var Uz$,_Y1=21333;var mU=K(()=>{ZaL();iI();V9$();yDA();qw();nt();oZ();vA();fI();NA();_$();_L();iI();rM();E3();mY();yy();jD();z$();cFA();dxH();QyH();oZH();lM();lIH();LHH();oZ();UT();ya();aS();yF();E$();FyH();Wt();Hq$();Cm();mY();G3H();huH();p$();zAH();gy();fI();MCH();iI();UBH();la();BzH();Yq();Z$();jD();i6();Uz$=require("crypto")});function ZY1(){return trD.randomBytes(8).toString("hex")}function TY1(H,$){let A=!1,L=!1;for(let I=0;I<$;I++){let D=H[I],B=0;for(let f=I-1;f>=0&&H[f]==="\\";f--)B++;if(B%2===1)continue;if(D==="'"&&!L)A=!A;else if(D==='"'&&!A)L=!L}return A||L}function zY1(H,$){let A=H.lastIndexOf(`
3b279dbd2 `)})()}}async write(H){await this.transport.write(H)}close(){this.transport.close(),this.inputStream.end()}}});var EEB=K(()=>{OV();ei();oG();DK()});class MEB{config;mutableMessages;abortController;permissionDenials;totalUsage;hasHandledOrphanedPermission=!1;constructor(H){this.config=H,this.mutableMessages=H.initialMessages??[],this.abortController=H.abortController??cD(),this.permissionDenials=[],this.totalUsage=TC}async*submitMessage(H,$){let{cwd:A,commands:L,tools:I,mcpClients:D,verbose:B=!1,maxThinkingTokens:f,maxTurns:E,maxBudgetUsd:M,canUseTool:G,customSystemPrompt:U,appendSystemPrompt:X,userSpecifiedModel:J,fallbackModel:F,jsonSchema:Q,getAppState:W,setAppState:P,replayUserMessages:Y=!1,includePartialMessages:C=!1,agents:Z=[],setSDKStatus:q,orphanedPermission:O}=this.config;MY(A);let j=!yZ(),u=Date.now(),y=async(U$,hA,iA,rH,G$,b$)=>{let qA=await G(U$,hA,iA,rH,G$,b$);if(qA.behavior!=="allow")this.permissionDenials.push({tool_name:U$.name,tool_use_id:G$,tool_input:hA});return qA},g=await W(),v=J?t8(J):G1(),[p,d,k]=await Promise.all([tC(I,v,Array.from(g.toolPermissionContext.additionalWorkingDirectories.keys()),D),y5(),typeof U==="string"?Promise.resolve({}):R5()]),n={...d,...Gx1(D)},GH=[...typeof U==="string"?[U]:p,...X?[X]:[]],e=I.some((U$)=>U$.name===PK);if(Q&&e)KK$(P,j$());let BH={messages:this.mutableMessages,setMessages:()=>{},onChangeAPIKey:()=>{},options:{commands:L,debug:!1,tools:I,verbose:B,mainLoopModel:v,maxThinkingTokens:f??0,mcpClients:D,mcpResources:{},ideInstallationStatus:null,isNonInteractiveSession:!0,customSystemPrompt:U,appendSystemPrompt:X,agentDefinitions:{activeAgents:Z,allAgents:[]},theme:M$().theme,maxBudgetUsd:M},getAppState:W,setAppState:P,abortController:this.abortController,readFileState:g9H(this.mutableMessages,A),setInProgressToolUseIDs:()=>{},setResponseLength:()=>{},updateFileHistoryState:(U$)=>{P((hA)=>({...hA,fileHistory:U$(hA.fileHistory)}))},updateAttributionState:(U$)=>{P((hA)=>({...hA,attribution:U$(hA.attribution)}))},setSDKStatus:q};if(O&&!this.hasHandledOrphanedPermission){this.hasHandledOrphanedPermission=!0;for await(let U$ of ezD(O,I,this.mutableMessages,BH))yield U$}let{messages:VH,shouldQuery:wH,allowedTools:WH,maxThinkingTokens:qH,model:s,resultText:IH}=await rN$({input:H,mode:"prompt",setIsLoading:()=>{},setToolJSX:()=>{},context:{...BH,messages:this.mutableMessages},messages:this.mutableMessages,uuid:$?.uuid,querySource:"sdk"});this.mutableMessages.push(...VH);let FH=f??qH??0,EH=[...this.mutableMessages],YH=VH.filter((U$)=>U$.type==="user"&&!U$.isMeta&&!U$.toolUseResult||U$.type==="system"&&U$.subtype==="compact_boundary"),OH=Y?YH:[];P((U$)=>({...U$,toolPermissionContext:{...U$.toolPermissionContext,alwaysAllowRules:{...U$.toolPermissionContext.alwaysAllowRules,command:WH}}}));let HH=s??v,$H=g9H(EH,A),DH=qKH($H,BH.readFileState);BH={messages:EH,setMessages:()=>{},onChangeAPIKey:()=>{},options:{commands:L,debug:!1,tools:I,verbose:B,mainLoopModel:HH,maxThinkingTokens:FH,mcpClients:D,mcpResources:{},ideInstallationStatus:null,isNonInteractiveSession:!0,customSystemPrompt:U,appendSystemPrompt:X,theme:M$().theme,agentDefinitions:{activeAgents:Z,allAgents:[]},maxBudgetUsd:M},getAppState:W,setAppState:P,abortController:this.abortController,readFileState:DH,setInProgressToolUseIDs:()=>{},setResponseLength:()=>{},updateFileHistoryState:BH.updateFileHistoryState,updateAttributionState:BH.updateAttributionState,setSDKStatus:q};let AH=VL()?.outputStyle??aQ,[KH,{enabled:CH}]=await Promise.all([zJ$(Y$()),zf()]);if(yield{type:"system",subtype:"init",cwd:A,session_id:j$(),tools:I.map((U$)=>U$.name),mcp_servers:D.map((U$)=>({name:U$.name,status:U$.type})),model:HH,permissionMode:g.toolPermissionContext.mode,slash_commands:L.map((U$)=>U$.name),apiKeySource:V5().source,betas:J6(),claude_code_version:{ISSUES_EXPLAINER:"report the issue at https://github.com/anthropics/claude-code/issues",PACKAGE_URL:"@anthropic-ai/claude-code",README_URL:"https://code.claude.com/docs/en/overview",VERSION:"2.1.33",FEEDBACK_CHANNEL:"https://github.com/anthropics/claude-code/issues",BUILD_TIME:"2026-02-06T00:15:09Z"}.VERSION,output_style:AH,agents:Z.map((U$)=>U$.agentType),skills:KH.map((U$)=>U$.name),plugins:CH.map((U$)=>({name:U$.name,path:U$.path})),uuid:hd.randomUUID()},u9H("system_message_yielded"),!wH){for(let U$ of YH){if(U$.type==="user"&&typeof U$.message.content==="string"&&(U$.message.content.includes(`<${YMH}>`)||U$.message.content.includes(`<${eoH}>`)||U$.isCompactSummary))EH.push(U$),yield{type:"user",message:{...U$.message,content:HU(U$.message.content)},session_id:j$(),parent_tool_use_id:null,uuid:U$.uuid,isReplay:!U$.isCompactSummary};if(U$.type==="system"&&U$.subtype==="compact_boundary")EH.push(U$),yield{type:"system",subtype:"compact_boundary",session_id:j$(),uuid:U$.uuid,compact_metadata:{trigger:U$.compactMetadata.trigger,pre_tokens:U$.compactMetadata.preTokens}}}if(j){if(await cS(EH),A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}yield{type:"result",subtype:"success",is_error:!1,duration_ms:Date.now()-u,duration_api_ms:pY(),num_turns:EH.length-1,result:IH??"",stop_reason:null,session_id:j$(),total_cost_usd:$Q(),usage:TC,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID()};return}if(bE()&&j)VH.filter(CpH).forEach((U$)=>{J6H((hA)=>{P((iA)=>({...iA,fileHistory:hA(iA.fileHistory)}))},U$.uuid)});let yH=TC,gH=1,QH=!1,lH,hH=null,sH=Q?MbA(this.mutableMessages,PK):0;for await(let U$ of OP({messages:EH,systemPrompt:GH,userContext:n,systemContext:k,canUseTool:y,toolUseContext:BH,fallbackModel:F,querySource:"sdk",maxTurns:E})){if(U$.type==="assistant"||U$.type==="user"||U$.type==="system"&&U$.subtype==="compact_boundary"){if(EH.push(U$),j)await cS(EH);if(!QH&&OH.length>0){QH=!0;for(let hA of OH)if(hA.type==="user")yield{type:"user",message:hA.message,session_id:j$(),parent_tool_use_id:null,uuid:hA.uuid,isReplay:!0}}}if(U$.type==="user")gH++;switch(U$.type){case"tombstone":break;case"assistant":hH=U$.message.stop_reason,this.mutableMessages.push(U$),yield*$xA(U$);break;case"progress":case"user":this.mutableMessages.push(U$),yield*$xA(U$);break;case"stream_event":if(U$.event.type==="message_start")yH=TC,yH=O9H(yH,U$.event.message.usage);if(U$.event.type==="message_delta")yH=O9H(yH,U$.event.usage);if(U$.event.type==="message_stop")this.totalUsage=cY$(this.totalUsage,yH);if(C)yield{type:"stream_event",event:U$.event,session_id:j$(),parent_tool_use_id:null,uuid:hd.randomUUID()};break;case"attachment":if(this.mutableMessages.push(U$),U$.attachment.type==="structured_output")lH=U$.attachment.data;else if(U$.attachment.type==="max_turns_reached"){if(j){if(A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}yield{type:"result",subtype:"error_max_turns",duration_ms:Date.now()-u,duration_api_ms:pY(),is_error:!1,num_turns:U$.attachment.turnCount,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID(),errors:[]};return}else if(Y&&U$.attachment.type==="queued_command")yield{type:"user",message:{role:"user",content:U$.attachment.prompt},session_id:j$(),parent_tool_use_id:null,uuid:U$.attachment.source_uuid||U$.uuid,isReplay:!0};break;case"stream_request_start":break;case"system":if(this.mutableMessages.push(U$),U$.subtype==="compact_boundary"&&U$.compactMetadata)yield{type:"system",subtype:"compact_boundary",session_id:j$(),uuid:U$.uuid,compact_metadata:{trigger:U$.compactMetadata.trigger,pre_tokens:U$.compactMetadata.preTokens}};break;case"tool_use_summary":yield{type:"tool_use_summary",summary:U$.summary,preceding_tool_use_ids:U$.precedingToolUseIds,session_id:j$(),uuid:U$.uuid};break}if(M!==void 0&&$Q()>=M){if(j){if(A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}yield{type:"result",subtype:"error_max_budget_usd",duration_ms:Date.now()-u,duration_api_ms:pY(),is_error:!1,num_turns:gH,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID(),errors:[]};return}if(U$.type==="user"&&Q){let iA=MbA(this.mutableMessages,PK)-sH,rH=parseInt(process.env.MAX_STRUCTURED_OUTPUT_RETRIES||"5",10);if(iA>=rH){if(j){if(A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}yield{type:"result",subtype:"error_max_structured_output_retries",duration_ms:Date.now()-u,duration_api_ms:pY(),is_error:!0,num_turns:gH,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID(),errors:[`Failed to provide valid structured output after ${rH} attempts`]};return}}}let F$=K6(EH);if(j){if(A$(process.env.CLAUDE_CODE_EAGER_FLUSH)||A$(process.env.CLAUDE_CODE_IS_COWORK))await i1H()}if(!szD(F$)){yield{type:"result",subtype:"error_during_execution",duration_ms:Date.now()-u,duration_api_ms:pY(),is_error:!1,num_turns:gH,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,uuid:hd.randomUUID(),errors:TMH().map((U$)=>U$.error)};return}let KA="",UA=!1;if(F$.type==="assistant"){let U$=K6(F$.message.content);if(U$?.type==="text")KA=U$.text;UA=Boolean(F$.isApiErrorMessage)}yield{type:"result",subtype:"success",is_error:UA,duration_ms:Date.now()-u,duration_api_ms:pY(),num_turns:gH,result:KA,stop_reason:hH,session_id:j$(),total_cost_usd:$Q(),usage:this.totalUsage,modelUsage:JN(),permission_denials:this.permissionDenials,structured_output:lH,uuid:hd.randomUUID()}}interrupt(){this.abortController.abort()}getMessages(){return this.mutableMessages}getSessionId(){return j$()}setModel(H){this.config.userSpecifiedModel=H}}async function*GEB({commands:H,prompt:$,promptUuid:A,cwd:L,tools:I,mcpClients:D,verbose:B=!1,maxThinkingTokens:f,maxTurns:E,maxBudgetUsd:M,canUseTool:G,mutableMessages:U=[],customSystemPrompt:X,appendSystemPrompt:J,userSpecifiedModel:F,fallbackModel:Q,jsonSchema:W,getAppState:P,setAppState:Y,abortController:C,replayUserMessages:Z=!1,includePartialMessages:q=!1,agents:O=[],setSDKStatus:j,orphanedPermission:u}){yield*new MEB({cwd:L,tools:I,commands:H,mcpClients:D,agents:O,canUseTool:G,getAppState:P,setAppState:Y,initialMessages:U,customSystemPrompt:X,appendSystemPrompt:J,userSpecifiedModel:F,fallbackModel:Q,maxThinkingTokens:f,maxTurns:E,maxBudgetUsd:M,jsonSchema:W,verbose:B,replayUserMessages:Z,includePartialMessages:q,setSDKStatus:j,abortController:C,orphanedPermission:u}).submitMessage($,{uuid:A})}var hd,Gx1=()=>({});var UEB=K(()=>{_HH();i6();R4();VI();qw();ST();Yq();N9H();Q7();rh();nB();NA();_L();zv();yuA();p$();iI();QK$();Nq();DE();fI();huH();QyH();mU();vA();aE();wh();mL();WX();_$();sC();nz$();c2$();hd=require("crypto")});var XEB=K(()=>{E$()});var JEB=K(()=>{_$();FgA();VI();XEB();z$();tr()});function FEB(H){let $=process.env.CLAUDE_CODE_EXIT_AFTER_STOP_DELAY,A=$?parseInt($,10):null,L=A&&!isNaN(A)&&A>0,I=null,D=0;return{start(){if(I)clearTimeout(I),I=null;if(L)D=Date.now(),I=setTimeout(()=>{let B=Date.now()-D;if(H()&&B>=A)N(`Exiting after ${A}ms of idle time`),$9()},A)},stop(){if(I)clearTimeout(I),I=null}}}var KEB=K(()=>{E$();MU()});function QEB(H){try{let $=new URL(H);return{sessionId:SgA.randomUUID(),ingressUrl:$.href,isUrl:!0,jsonlFile:null,isJsonlFile:!1}}catch{if(Iw(H))return{sessionId:H,ingressUrl:null,isUrl:!1,jsonlFile:null,isJsonlFile:!1};if(H.endsWith(".jsonl"))return{sessionId:SgA.randomUUID(),ingressUrl:null,isUrl:!1,jsonlFile:H,isJsonlFile:!0}}return null}var SgA;var WEB=K(()=>{vx();SgA=require("crypto")});async function VEB(){N("installPluginsForHeadless: starting");try{let[,H,$,A]=await Promise.all([IO$(),yq$(),wVH(),qVH()]),L=[];if(H.size>0){let M=await vq$(H);for(let G of M){let U=H.get(G);if(!U)continue;try{await vw(U.source),L.push(G),N(`installPluginsForHeadless: installed extra marketplace ${G}`)}catch(X){r(X instanceof Error?X:Error(String(X))),N(`installPluginsForHeadless: failed to install extra marketplace ${G}`)}}if(L.length>0)q3H(),wx()}let I=await d1(),D=$.filter((M)=>!A.includes(M)),B=[],f=[];for(let M of D){let[,G]=M.split("@");if(!G||G in I)B.push(M);else f.push(M)}if(f.length>0)N(`installPluginsForHeadless: skipping ${f.length} plugins from unknown marketplaces: ${f.join(", ")}`);if(B.length===0)return N("installPluginsForHeadless: no plugins to install"),!1;let E=await hq$(B,()=>{});if(E.installed.length>0)wx();return N(`installPluginsForHeadless: ${E.installed.length} installed, ${E.failed.length} failed`),E.installed.length>0}catch(H){return r(H instanceof Error?H:Error(String(H))),!1}}var PEB=K(()=>{cuA();TVH();mRA();S4();kq$();WX();E$();_$()});async function YEB(H,$,A,L,I,D,B,f){if(sJ.subscribe((q)=>{ZZ$(q,A)}),ROA(),await RQH())await $cD();if(kL.isSandboxingEnabled())try{await kL.initialize()}catch(q){process.stderr.write(`