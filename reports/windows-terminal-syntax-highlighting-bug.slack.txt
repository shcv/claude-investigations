*Windows Terminal Syntax Highlighting Offset Bug*
Claude Code v2.1.19 | 2026-01-26

───────────────────────────────────────

*Summary*

Investigation into syntax highlighting color offset issues in Claude Code when running on Windows Terminal. Colors appear shifted from the text they should color, with the offset accumulating ~1 character per line.

───────────────────────────────────────

*Root Cause Hypothesis*

Mismatch between how Claude Code calculates display widths and how Windows Terminal/ConPTY interprets cursor positions, specifically around control characters in syntax-highlighted code.

Key file: `archive/claude-code/pretty/pretty-v2.1.19.js`

───────────────────────────────────────

*Critical Code Sections*

*1. Width Calculation in Tokenizer* (lines 173147-173154)
```
let H = s66(w),  // Only checks East Asian width
    J = String.fromCodePoint(w);
q.push({ type: "char", value: J, fullWidth: H });
z += H ? 2 : J.length;  // BUG: Uses J.length for non-wide chars
```
:warning: For `\r` (code 13), `J.length` is 1 but actual display width is 0.

*2. Main Width Function* (lines 170541-170554)
```
if (K) {  // ASCII fast path
  let Y = 0;
  for (let z = 0; z < A.length; z++)
    if (A.charCodeAt(z) > 31) Y++;  // Correctly skips control chars
  return Y;
}
```
:white_check_mark: Correctly skips control characters, BUT only in the ASCII fast path.

*3. Control Character Handling* (lines 173548-173592)
```
if (V !== void 0 && V <= 31) {
  if (V === 9) { /* TAB handling */ }
  else if (V === 27) { /* ESC/ANSI handling */ }
  continue;  // Other control chars skipped
}
```
Screen model correctly skips `\r`, but width calculations may not.

*4. Segmenter Grouping* (lines 173647-173656)
```
for (let { segment: H } of qY4.segment(w))
  q.push({ type: "char", value: H, fullWidth: p7(H) === 2, styles: z });
```
`Intl.Segmenter` can group `\r\n` as a single segment with length 2.

───────────────────────────────────────

*Where the Bug Manifests*

When code content has Windows `\r\n` line endings:

1. Text is split by `\n` only → leaves `\r` at end of each line
2. `\r` flows through the system with styles attached
3. In screen buffer, `\r` is correctly skipped (no cell filled)
4. BUT in width calculations outside ASCII fast path, `\r` may contribute to width
5. This affects cursor positioning during differential rendering

───────────────────────────────────────

*ConPTY Interaction*

Windows Terminal uses ConPTY which:
• Has known issues with cursor position synchronization
• May interpret some ANSI sequences differently
• Could have different handling of `\r` in certain contexts

───────────────────────────────────────

*Architecture Notes*

Claude Code uses a _custom cell-based screen buffer_ (not standard Ink):
• Typed arrays: `Uint32Array` for chars, `Uint16Array` for styles, `Uint8Array` for widths
• Differential rendering with cursor tracking via `H86` class
• Cursor movements use `\r` (carriageReturn) + relative cursor moves

Windows Terminal detection:
• `WT_SESSION` environment variable
• Some features disabled for WT (like progress reporting)
• Different clear sequences for WT vs legacy cmd

───────────────────────────────────────

*Workaround (for users)* :hammer_and_wrench:

Convert source files to Unix line endings (`\n` only):

```
# Single file
sed -i 's/\r$//' filename

# All JS files in directory
find . -type f -name "*.js" -exec sed -i 's/\r$//' {} \;
```

───────────────────────────────────────

*Proposed Fix (for Anthropic)* :wrench:

*Option 1: Fix width calculation*

At line 173152, add explicit handling for control characters:
```
// Current:
z += H ? 2 : J.length;

// Proposed:
z += H ? 2 : (w <= 31 ? 0 : J.length);
```

*Option 2: Normalize line endings*

Before syntax highlighting:
```
text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
```

───────────────────────────────────────

*Why Only Syntax Highlighting?*

Normal text output uses `\n` only (relying on Windows text mode to add `\r`), but code content being displayed may already contain `\r\n` from Windows-style source files. The ANSI color codes from syntax highlighting are positioned based on width calculations that may incorrectly count `\r` as having width.

───────────────────────────────────────

*Key Functions Reference*

```
Function  Line     Purpose
────────  ───────  ──────────────────────────────────
c0A       173124   Tokenizes text into chars/ANSI
U94       173062   Applies styles from ANSI to chars
jF3       173636   Uses Segmenter to group graphemes
p7/L34    170541   Width calculation (Node.js)
Yg3       170665   Width calculation (Bun)
l71       173434   Screen buffer class
H86       174003   Cursor tracking for diff rendering
m86       177393   Final output to stdout
```

───────────────────────────────────────

*How to Test the Fix Yourself* :test_tube:

*Step 1: Find Claude Code's installation*

```
# Find global npm location
npm root -g
# Typical Windows path: C:\Users\<user>\AppData\Roaming\npm\node_modules

# Or check local installation
ls ~/.claude/local/node_modules/@anthropic-ai/claude-code/
```

The main file is the bundled JS in the `dist/` folder (likely `cli.js`).

*Step 2: Backup the original*

```
cd "$(npm root -g)/@anthropic-ai/claude-code"
cp dist/cli.js dist/cli.js.backup
```

*Step 3: Apply one of these fixes*

*Fix A: Line ending normalization* (easier to find)

Search for `wG1.highlight` and find this line (~371983):
```
return wG1.highlight(A.text, { language: H }) + oD;
```

Change to:
```
return wG1.highlight(A.text.replace(/\r\n/g, '\n').replace(/\r/g, '\n'), { language: H }) + oD;
```

*Fix B: Width calculation*

Search for this exact pattern:
```
z += H ? 2 : J.length
```

Change to:
```
z += H ? 2 : (w <= 31 ? 0 : J.length)
```

*Step 4: Create a test file with CRLF*

```
# PowerShell
"const x = 1;`r`nconst y = 2;`r`nconst z = 3;" | Out-File -Encoding ASCII test-crlf.js

# Or Git Bash
printf 'const x = 1;\r\nconst y = 2;\r\nconst z = 3;\r\n' > test-crlf.js
```

*Step 5: Test*

Run Claude Code and have it display the test file with syntax highlighting. Check if colors now align correctly with the text.

*Step 6: Revert if needed*

```
cp dist/cli.js.backup dist/cli.js
```

───────────────────────────────────────

*Reporting Results* :memo:

If you test this, please report back:
• Did the fix resolve the color offset issue?
• Which fix did you apply (A or B)?
• Any other observations about the behavior?

This will help confirm the root cause and inform the official fix.
